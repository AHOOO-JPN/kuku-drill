
<!DOCTYPE html>
<html lang="ja">
    <head>
    <meta charset="utf-8">
    <title>KuKuãƒ‰ãƒªãƒ«</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    
    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KuKuãƒ‰ãƒªãƒ«">
    <meta name="theme-color" content="#9c2cff">
    
    <!-- Manifestï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§OKï¼‰ -->
    <link rel="manifest" href="manifest.webmanifest">
    
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§OKï¼‰ -->
    <link rel="apple-touch-icon" sizes="180x180" href="icon/icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
    <link rel="shortcut icon" href="icon/favicon.ico">
    
    <!-- Open Graph ã‚¿ã‚°ï¼ˆçµ¶å¯¾URLã«å¤‰æ›´ï¼‰ -->
    <meta property="og:title" content="KuKuãƒ‰ãƒªãƒ«">
    <meta property="og:description" content="ãŠå­æ§˜ãŒæ¥½ã—ãä¹ä¹ã‚’å­¦ç¿’ã§ãã‚‹æ•™è‚²ã‚¢ãƒ—ãƒª">
    <meta property="og:image" content="https://ahooo-jpn.github.io/kuku-drill/icon/icon-512.png">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ahooo-jpn.github.io/kuku-drill/">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="KuKuãƒ‰ãƒªãƒ«">
    <meta name="twitter:description" content="ãŠå­æ§˜ãŒæ¥½ã—ãä¹ä¹ã‚’å­¦ç¿’ã§ãã‚‹æ•™è‚²ã‚¢ãƒ—ãƒª">
    <meta name="twitter:image" content="https://ahooo-jpn.github.io/kuku-drill/icon/icon-512.png">
            
    <style>
    :root{
  --bg:#0a0714; --grad1:#2b115a; --grad2:#091a3a;
  --panel: rgba(255,255,255,.08); --panel2: rgba(255,255,255,.05);
  --border: rgba(255,255,255,.14);
  --text:#f7f6ff; --muted:#c7c2e6; --ok:#35ffa1; --ng:#ff6a6a;
  --accentA:#ff4dc4; --accentB:#3bc7ff; --radius:18px;
  --wallOpacity:.36;
  transition: --accentA 0.5s ease, --accentB 0.5s ease;
}
body.theme-mix{ --accentA:#ff4dc4; --accentB:#3bc7ff; }
body.theme-pink{ --accentA:#ff7adf; --accentB:#ff5ea6; }
body.theme-blue{ --accentA:#7ad3ff; --accentB:#3bc7ff; }

*{box-sizing:border-box}

/* â˜…è¿½åŠ : ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ãƒƒãƒæœ€é©åŒ– */
button, input, select, textarea {
  touch-action: manipulation;
  -webkit-tap-highlight-color: rgba(255,255,255,0.1);
}

/* â˜…è¿½åŠ : 300msã‚¿ãƒƒãƒ—é…å»¶ã‚’å®Œå…¨å‰Šé™¤ */
a, button, input, select, textarea, [role="button"] {
  -ms-touch-action: manipulation;
  touch-action: manipulation;
}

/* ========== â˜…è¿½åŠ 2: 300msã‚¿ãƒƒãƒ—é…å»¶ã‚’å®Œå…¨å‰Šé™¤ ========== */
* {
  -webkit-tap-highlight-color: transparent;
  -ms-touch-action: manipulation;
  touch-action: manipulation;
}


html {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: auto;  /* âœ… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
  -webkit-overflow-scrolling: touch;  /* âœ… iOSå‘ã‘ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
}
    /* ========== ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ ========== */
    html, body {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

    body {
      height: 100%;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
      padding: 50px 16px 16px 16px;  /* â˜…è¿½åŠ : å…ƒã®paddingã‚’å¾©å…ƒ */
      margin: 0;
      color: var(--text);
      font-family: system-ui,-apple-system,"Inter","Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(156,44,255,.32), #0a0714 60%),
        radial-gradient(1100px 700px at 120% 10%, rgba(59,199,255,.26), #0a0714 60%),
        linear-gradient(180deg, #2b115a 0%, #0a0714 100%);
      background-color: #0a0714;
      background-attachment: fixed;
    }

    /* ãƒ†ãƒ³ã‚­ãƒ¼ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    .keypad {
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      overscroll-behavior: contain;
    }

    .keypad button {
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
    }

    /* å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    .problem {
      touch-action: none;
      overscroll-behavior: contain;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ ã¯æ˜ç¤ºçš„ã«è¨±å¯ */
    .sheet .inner,
    #historyContent,
    #privacyContent,
    #termsContent,
    .modal .panel {
      touch-action: auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    
    
.wall{
  position:fixed; inset:0; z-index:0; opacity:var(--wallOpacity);
  background-image: var(--neon-wall); background-size: var(--wallSize, cover);
  background-position:center; filter:saturate(120%) contrast(110%); pointer-events:none;
}
    /* â˜…ä¿®æ­£: ãƒ“ãƒ¼ãƒ ã®è‰²ã‚’ãƒ†ãƒ¼ãƒã«é€£å‹• */
    .beams{
      position:fixed; inset:0; z-index:1; pointer-events:none; opacity:.9;
      filter: blur(44px) saturate(120%);
      animation: spin 18s linear infinite;
      background:
        conic-gradient(from 0deg at 20% 0%, color-mix(in oklab, var(--accentA) 45%, transparent), transparent 30%),
        conic-gradient(from 180deg at 80% 10%, color-mix(in oklab, var(--accentB) 45%, transparent), transparent 35%);
      /* â˜…è¿½åŠ : ãƒ†ãƒ¼ãƒå¤‰æ›´æ™‚ã«ã‚¹ãƒ ãƒ¼ã‚ºã«è‰²ãŒå¤‰ã‚ã‚‹ */
      transition: background 0.6s ease;
    }

@keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

.app{ width:100%; max-width:720px; margin:0 auto; position:relative; z-index:2; }

/* ========== ãƒ˜ãƒƒãƒ€ãƒ¼ä¿®æ­£ ========== */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  gap: 8px;
  min-height: 44px;
  /* â˜…ä¿®æ­£: flex-wrapã‚’è¨±å¯ã—ã¦æŠ˜ã‚Šè¿”ã›ã‚‹ã‚ˆã†ã« */
  flex-wrap: wrap;
  /* ãƒ˜ãƒƒãƒ€ãƒ¼å…¨ä½“ã‚’2è¡Œã«åˆ†ã‘ã¦ã‚‚è‰¯ã„å ´åˆã¯ wrap ã‚’ä½¿ã† */
}
    
    /* ã‚«ãƒ©ãƒ¼ãƒãƒƒã‚¸ã‚»ãƒƒãƒˆ */
    #colorSet {
      display: flex;
      gap: 6px;
      /* â˜…ä¿®æ­£: æœ€å°å¹…ã‚’è¨­å®šã—ã€å¿…è¦ã«å¿œã˜ã¦æŠ˜ã‚Šè¿”ã— */
      flex-wrap: wrap;
      align-items: center;
    }
    
    .badge {
      min-height: 36px;
      padding: 6px 12px;
      font-size: 13px;
      /* â˜…ä¿®æ­£: å¹…ã‚’è‡ªå‹•èª¿æ•´ */
      flex: 0 0 auto;
    }

    /* é †åº/ãƒ©ãƒ³ãƒ€ãƒ ãƒˆã‚°ãƒ« */
    .order-toggle {
      min-height: 36px;
      padding: 0 10px;
      font-size: 13px;
      /* â˜…ä¿®æ­£: å¹…ã‚’è‡ªå‹•èª¿æ•´ */
      flex: 0 0 auto;
    }
    
.title{font-weight:900;font-size:28px;letter-spacing:.5px}
.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:nowrap; /* â˜…ä¿®æ­£: æ”¹è¡Œã•ã›ãªã„ */
}

/* â˜…ä¿®æ­£: ãƒãƒƒã‚¸ã®é«˜ã•ã‚’çµ±ä¸€ */
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  /* é«˜ã•ã‚’çµ±ä¸€ */
  min-height:36px;
  padding:6px 12px;
  border-radius:999px;
  cursor:pointer;
  background:linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#0b0416;
  font-weight:800;
  border:0;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.22);
  /* â˜…è¿½åŠ : æ”¹è¡Œé˜²æ­¢ */
  white-space:nowrap;
}

/* â˜…ä¿®æ­£: é †ç•ª/ãƒ©ãƒ³ãƒ€ãƒ ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’çµ±ä¸€ */
.order-toggle {
  display: inline-flex;
  gap: 6px;
  align-items: center;
  padding: 2px;
  border-radius: 999px;
  background: linear-gradient(180deg, var(--panel), var(--panel2));
  border: 1px solid var(--border);
  /* é«˜ã•ã‚’çµ±ä¸€ */
  min-height:36px;
}
    .order-toggle .ot-btn {
      min-height: 32px;
      padding: 4px 10px;
      border: 0;
      border-radius: 999px;
      background: transparent;
      color: rgba(255,255,255,0.7);
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      /* â˜…è¿½åŠ : ã‚¿ãƒƒãƒæœ€é©åŒ– */
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255,255,255,0.2);
      -webkit-touch-callout: none;
      user-select: none;
    }
.order-toggle .ot-btn[aria-pressed="true"] {
  background: linear-gradient(90deg, var(--accentA), var(--accentB));
  color: #0b0416;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
}
.order-toggle.disabled {
  opacity: 0.5;
  pointer-events: none;
}


.card{background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));border:1px solid var(--border);border-radius:18px;padding:14px;backdrop-filter:blur(14px);box-shadow:0 12px 30px rgba(12,4,40,.5)}
.problem{ text-align:center; font-size:56px; font-weight:900; letter-spacing:1px; padding:16px 10px; border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid var(--border);
  text-shadow:0 0 14px color-mix(in oklab, var(--accentB) 55%, transparent), 0 0 10px color-mix(in oklab, var(--accentA) 45%, transparent);
  margin-bottom:12px;
}
    .kuku-input{
      text-align:right;
      width:100%;
      font-size:40px;
      font-weight:900;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.1);
      color:#fff;
      outline:none;
      /* â˜…è¿½åŠ : ã‚¿ãƒƒãƒæœ€é©åŒ– */
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
      /* â˜…è¿½åŠ : iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
      font-size: max(16px, 40px);
    }
.kuku-input::placeholder{ color: rgba(255,255,255,.85) }
.keypad{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px }
.key{
  font-size:30px;
  padding:16px 10px;
  text-align:center;
  border-radius:14px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  color:#f2efff;
  cursor:pointer;
  user-select:none;
  /* â˜…è¿½åŠ : ã‚¿ãƒƒãƒæœ€é©åŒ– */
  touch-action: manipulation;
  -webkit-tap-highlight-color: rgba(255,255,255,0.15);
  -webkit-touch-callout: none;
  /* â˜…è¿½åŠ : ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ */
  transform: translateZ(0);
  will-change: transform;
}
.key:active{
  transform:translateY(1px) scale(.99) translateZ(0);
}
.key.ok{ position:relative; font-weight:900; background:linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#0b0416; border:0; box-shadow: inset 0 0 0 1px rgba(255,255,255,.25), 0 6px 18px color-mix(in oklab,var(--accentB) 35%, transparent);}
.key.ok::before{content:""; position:absolute; inset:0; border-radius:14px; background:linear-gradient(90deg,color-mix(in oklab,var(--accentA) 92%, transparent), color-mix(in oklab,var(--accentB) 92%, transparent)); mask:linear-gradient(#000,#000); opacity:.85; pointer-events:none}
.statrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.stat{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius:14px; padding:10px; text-align:center }
.stat small{color:var(--muted)} .stat b{display:block;font-size:18px}
.result{text-align:center;margin-top:10px;font-weight:900;min-height:28px}
.result.ok{color:var(--ok)} .result.ng{color:var(--ng)}
details{ margin-top:12px }
summary{ list-style:none; cursor:pointer; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
  background:linear-gradient(90deg, color-mix(in oklab, var(--accentA) 25%, transparent), color-mix(in oklab, var(--accentB) 25%, transparent)),
             linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  color:#fff; font-weight:800;}
summary::-webkit-details-marker{ display:none }
.section-body{ margin-top:10px; padding:10px; border-radius:12px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); }
    .pill{
      padding:10px 18px;
      border-radius:999px;
      border:1px solid var(--border);
      background:linear-gradient(90deg, color-mix(in oklab, var(--accentA) 22%, transparent), color-mix(in oklab, var(--accentB) 22%, transparent));
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color:#eae7ff;
      cursor:pointer;
      font-size:14px;
      user-select:none;
      letter-spacing:.02em;
      /* â˜…è¿½åŠ : ã‚¿ãƒƒãƒæœ€é©åŒ– */
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255,255,255,0.2);
      -webkit-touch-callout: none;
    }
.pillset{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:6px }
.label{ font-size:12px; color:var(--muted); margin:12px 0 8px }
.pill.active{ outline:2px solid color-mix(in oklab, var(--accentA) 55%, transparent); box-shadow:0 0 20px color-mix(in oklab, var(--accentA) 35%, transparent)}
footer{margin:16px 0 6px;text-align:center;color:#bcb6da;font-size:12px}

.ta-on .card{ outline:2px solid color-mix(in oklab,var(--accentB) 70%,transparent);
  box-shadow:0 0 24px color-mix(in oklab,var(--accentB) 40%, transparent); }

    #best20, #best30, #best60, #best81, #best100, #best144 { display:none !important; }

.table-wrap{ margin-top:8px }
.history-table{ width:100%; border-collapse:collapse; margin-bottom:12px; font-size:12px }
.history-table th,.history-table td{ padding:6px 4px; border-bottom:1px solid rgba(255,255,255,.18); text-align:left }
.history-table thead th{ border-bottom:1px solid rgba(255,255,255,.35); font-weight:600 }
.history-table .best-row{ background:rgba(255,255,255,.08) }
.history-table .miss-row{ opacity:.7 }
.history-table .best-badge{ font-size:14px }

.iconbtn{
  min-width:44px; min-height:44px; border-radius:12px; border:1px solid var(--border);
  background: linear-gradient(180deg, var(--panel), var(--panel2)); color:#fff; font-weight:900; cursor:pointer;
}
.iconbtn:active{ transform: translateY(1px) scale(.98) }

/* ========== åœæ­¢ãƒœã‚¿ãƒ³(å·¦ä¸‹ãƒ»ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼é€£å‹•) ========== */
.ta-stop-fab {
  position: fixed;
  bottom: calc(20px + env(safe-area-inset-bottom));
  left: 20px;
  z-index: 1200;
  display: none;
  /* å¤§ããªå††å½¢ãƒœã‚¿ãƒ³ */
  width: 72px;
  height: 72px;
  padding: 0;
  border: 0;
  border-radius: 50%;
  /* æ¿ƒã„èƒŒæ™¯ */
  background: linear-gradient(135deg, rgba(30, 20, 60, 0.95), rgba(20, 15, 50, 0.95));
  color: #fff;
  font-weight: 800;
  font-size: 15px;
  /* â˜…ä¿®æ­£: ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã«é€£å‹•ã—ãŸãƒã‚ªãƒ³åŠ¹æœ */
  box-shadow:
    0 0 0 3px color-mix(in oklab, var(--accentA) 70%, transparent),
    0 0 20px color-mix(in oklab, var(--accentA) 50%, transparent),
    0 0 35px color-mix(in oklab, var(--accentB) 35%, transparent),
    0 4px 16px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  -webkit-appearance: none;
  appearance: none;
  -webkit-tap-highlight-color: transparent;
  /* ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  animation: stopPulseThemed 2s ease-in-out infinite;
  /* ä¸­å¤®æƒãˆ */
  align-items: center;
  justify-content: center;
}

/* â˜…ä¿®æ­£: ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼é€£å‹•ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes stopPulseThemed {
  0%, 100% {
    box-shadow:
      0 0 0 3px color-mix(in oklab, var(--accentA) 70%, transparent),
      0 0 20px color-mix(in oklab, var(--accentA) 50%, transparent),
      0 0 35px color-mix(in oklab, var(--accentB) 35%, transparent),
      0 4px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1);
  }
  50% {
    box-shadow:
      0 0 0 4px color-mix(in oklab, var(--accentA) 85%, transparent),
      0 0 30px color-mix(in oklab, var(--accentA) 70%, transparent),
      0 0 50px color-mix(in oklab, var(--accentB) 55%, transparent),
      0 6px 20px rgba(0, 0, 0, 0.5);
    transform: scale(1.05);
  }
}

.ta-stop-fab:active {
  transform: scale(0.92);
  box-shadow:
    0 0 0 3px color-mix(in oklab, var(--accentA) 80%, transparent),
    0 0 15px color-mix(in oklab, var(--accentA) 60%, transparent),
    0 2px 10px rgba(0, 0, 0, 0.4);
}

/* å°ã•ã„ç”»é¢ã§ã®èª¿æ•´ */
@media (max-width: 480px) {
  .ta-stop-fab {
    width: 64px;
    height: 64px;
    font-size: 14px;
    bottom: calc(16px + env(safe-area-inset-bottom));
    left: 16px;
  }
}

@media (max-height: 700px) {
  .ta-stop-fab {
    width: 60px;
    height: 60px;
    font-size: 13px;
    bottom: calc(12px + env(safe-area-inset-bottom));
    left: 12px;
  }
}
    
.sheet{
  position:fixed; left:0; right:0; bottom:0; z-index:1000;
  transform: translateY(110%); transition: transform .28s ease;
  background: rgba(10,7,20,.6); backdrop-filter: blur(18px);
  border-top:1px solid var(--border); border-radius:18px 18px 0 0;
  padding-bottom: calc(12px + env(safe-area-inset-bottom));
}
.sheet-close{
  position:absolute; top:6px; right:calc(8px + env(safe-area-inset-right)); z-index:3;
  width:44px; height:44px; padding:0; border:0 !important; background:transparent !important;
  appearance:none; -webkit-appearance:none; -webkit-tap-highlight-color:transparent;
  border-radius:12px; outline:none; box-shadow:none; color:transparent; font-size:0; line-height:0;
}
.sheet-close::before,.sheet-close::after{
  content:""; position:absolute; left:50%; top:50%; width:16px; height:2px; margin:-1px 0 0 -8px;
  background:rgba(255,255,255,.92); border-radius:2px;
}
.sheet-close::before{ transform:rotate(45deg) } .sheet-close::after{ transform:rotate(-45deg) }
.sheet-close:focus-visible{ box-shadow:0 0 0 2px color-mix(in oklab, var(--accentB) 45%, transparent) }
.sheet-close:active{ transform:translateY(1px) scale(.98) }

.sheet.show{ transform: translateY(0) }
.sheet .grab{ width:50px; height:5px; border-radius:999px; background:rgba(255,255,255,.35); margin:8px auto }
.sheet .inner{ padding:10px 14px 18px; height:calc(70vh); overflow:auto }

@media (max-width:390px){
  header{ flex-wrap:nowrap; gap:8px }
  .title{ font-size:24px }
  .badge{ padding:6px 10px; font-size:14px }
}

#paletteLabel{ display:inline } body.theme-mix #paletteLabel{ display:none }

body.overlay-open{ overflow:hidden!important; touch-action:none!important; overscroll-behavior:none!important; -webkit-overflow-scrolling:auto!important }

body.perf-lite .beams{ display:none }
body.perf-lite .card, body.perf-lite .stat, body.perf-lite .problem, body.perf-lite .key{ backdrop-filter:none; box-shadow:none; text-shadow:none }

body.theme-mix{ --accentA:#ff4dc4; --accentB:#3bc7ff; }
body.theme-pink{ --accentA:#ff7adf; --accentB:#ff5ea6; }
body.theme-blue{ --accentA:#7ad3ff; --accentB:#3bc7ff; }

#timerFree{ display:none !important }

.modal{
  position: fixed;
  inset: 0;
  z-index: 1300;
  display: none;
}
.modal.show{ display:block; }
.modal .back{
  position: absolute; inset: 0;
  background: rgba(6,4,20,.60);
  backdrop-filter: blur(10px);
}
.modal .panel{
  position: absolute; left:50%; top:50%;
  transform: translate(-50%,-50%);
  width: min(92vw, 560px);
  max-height: min(84vh, 720px);
  overflow: auto;
  border-radius: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border: 1px solid var(--border);
  box-shadow: 0 18px 48px rgba(12,4,40,.55);
  padding: 14px;
}
    
    /* â˜…è¿½åŠ : åˆå›èµ·å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    #firstLaunchModal .panel {
      max-height: min(90vh, 720px);
      padding: 20px 14px;
    }

    #firstLaunchModal .small {
      -webkit-overflow-scrolling: touch;
    }

    #firstLaunchModal a {
      transition: opacity 0.2s ease;
    }

    #firstLaunchModal a:active {
      opacity: 0.7;
    }

#faceBox{
  width: clamp(220px, 72vw, 340px) !important;
  height: clamp(220px, 72vw, 340px) !important;
  margin: 16px auto !important;
}

/* â˜…ä¿®æ­£4: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã¨ã‚«ãƒ©ãƒ¼çµ±ä¸€ */
    .btn{
      border: 0;
      border-radius: 12px;
      padding: 12px 20px;
      min-width: 100px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      color: #fff;
      font-weight: 800;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      /* â˜…è¿½åŠ : ã‚¿ãƒƒãƒæœ€é©åŒ– */
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255,255,255,0.2);
      -webkit-touch-callout: none;
      user-select: none;
    }
    .btn:active {
      transform: translateY(1px) scale(0.98);
    }
    .btn.grad{
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      color: #0b0416;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.25),
                  0 6px 18px color-mix(in oklab,var(--accentB) 35%, transparent);
    }

.btnrow{ display:flex; gap:10px; justify-content:center; margin-top:10px; }
.small{ color:var(--muted); font-size:13px; }
.h{ font-weight:900; font-size:20px; margin:4px 0 8px; }

/* â˜…ä¿®æ­£: å¿œæ´ãƒã‚¹ã‚³ãƒƒãƒˆï¼ˆé¡”ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« - ä¸­å¤®å›ºå®šã€ãƒã‚¦ãƒ³ã‚¹ã®ã¿ */
.mascot {
  position: fixed;
  /* ä¸­å¤®å›ºå®š */
  left: 50%;
  bottom: calc(16px + env(safe-area-inset-bottom));
  /* æœ€åˆã‹ã‚‰ä¸­å¤®ã«é…ç½® */
  transform: translateX(-50%);
  z-index: 999;
  width: 100px;
  height: 100px;
  border-radius: 50%;
  overflow: visible;
  /* ãƒã‚¦ãƒ³ã‚¹ã®ã¿ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  animation: mascotBounce 0.6s ease-out;
  pointer-events: none;
}
    
    /* ç”»é¢ãŒå°ã•ã„å ´åˆã¯ã•ã‚‰ã«å°ã•ã */
    @media (max-height: 700px) {
      .mascot {
        width: 80px;
        height: 80px;
        bottom: calc(8px + env(safe-area-inset-bottom));
      }
    }

    .mascot img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      border: 3px solid rgba(255,255,255,0.3);
    }
    /* â˜…ä¿®æ­£: æ­£è§£æ™‚ã®å¹ãå‡ºã— - ç™½ã®ã¿ã€æ ãªã—ã€é¡”ã«è¿‘ã¥ã‘ã‚‹ */
    .mascot-bubble {
      position: absolute;
      /* é¡”ã®ã™ãä¸Šã«é…ç½® */
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      /* é¡”ã¨ã®è·é›¢ã‚’ç¸®ã‚ã‚‹ */
      margin-bottom: 8px;
      padding: 8px 14px;
      /* ç™½èƒŒæ™¯ã®ã¿ */
      background: #ffffff;
      /* ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¿ƒã„è‰²ã«å¤‰æ›´ */
      color: #2d1b69;
      font-weight: 900;
      font-size: 15px;
      border-radius: 16px;
      white-space: nowrap;
      /* ã‚·ãƒ³ãƒ—ãƒ«ãªå½±ã®ã¿ */
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      animation: bubblePop 0.4s ease-out;
    }
    /* å¹ãå‡ºã—ã®çŸ¢å° */
    .mascot-bubble::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      /* ç™½è‰²ã®å¹ãå‡ºã—çŸ¢å° */
      border-top: 8px solid #ffffff;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    /* â˜…ä¿®æ­£: ãƒã‚¦ãƒ³ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - ä¸­å¤®å›ºå®šã€ä¸Šä¸‹ã®ã¿ */
    @keyframes mascotBounce {
      0% {
        /* ä¸‹ã‹ã‚‰ */
        transform: translateX(-50%) translateY(50px) scale(0.3);
        opacity: 0;
      }
      50% {
        /* å°‘ã—è·³ã­ä¸ŠãŒã‚‹ */
        transform: translateX(-50%) translateY(-15px) scale(1.1);
        opacity: 1;
      }
      70% {
        /* å°‘ã—ä¸‹ãŒã‚‹ */
        transform: translateX(-50%) translateY(5px) scale(0.95);
      }
      100% {
        /* å…ƒã®ä½ç½® */
        transform: translateX(-50%) translateY(0) scale(1);
        opacity: 1;
      }
    }


    /* â˜…ä¿®æ­£: å¹ãå‡ºã—ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - ä¸­å¤®å›ºå®š */
    @keyframes bubblePop {
      0% {
        transform: translateX(-50%) scale(0);
        opacity: 0;
      }
      70% {
        transform: translateX(-50%) scale(1.1);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
    }

    /* æ¶™ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒŸã‚¹æ™‚ï¼‰ */
    .mascot .tear {
      position: absolute;
      top: 40%;
      width: 8px;
      height: 12px;
      background: linear-gradient(180deg, rgba(59,199,255,0.9), rgba(59,199,255,0.3));
      border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
      animation: tearDrop 1.2s ease-in-out infinite;
    }
    .mascot .tear.left { left: 25%; }
    .mascot .tear.right { right: 25%; }

    @keyframes tearDrop {
      0%, 100% {
        transform: translateY(0);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      80% {
        transform: translateY(60px);
        opacity: 0.5;
      }
    }

/* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes pop-grow {
  0% {
    transform: scale(0.8);
    opacity: 0;
  }
  50% {
    transform: scale(1.2);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}
.pop-grow {
  animation: pop-grow 0.4s ease-out;
}

button.pill.grad,
#openHistory.pill.grad{
  background: linear-gradient(90deg, var(--accentA), var(--accentB)) !important;
  border: 0 !important; color:#0b0416 !important; font-weight:900;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25),
              0 6px 18px color-mix(in oklab,var(--accentB) 35%, transparent);
}
.order-toggle .ot-btn[aria-pressed="true"]{
  background: linear-gradient(90deg, var(--accentA), var(--accentB)) !important;
  border:0 !important; color:#0b0416 !important; font-weight:900;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25),
              0 6px 18px color-mix(in oklab,var(--accentB) 35%, transparent);
}
.key.ok, .btn.grad{
  background: linear-gradient(90deg, var(--accentA), var(--accentB)) !important;
  border:0 !important; color:#0b0416 !important; font-weight:900;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25),
              0 6px 18px color-mix(in oklab,var(--accentB) 35%, transparent);
}

    /* ========== è©³ç´°è¨­å®šãƒœã‚¿ãƒ³(å³ä¸‹ãƒ»ãƒ”ãƒ«å‹) ========== */
    .fab {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: 20px;
      z-index: 100;
    }

    .fab button {
      /* â˜…ä¿®æ­£: ãƒ”ãƒ«å‹ï¼ˆä¸¡ç«¯ãŒå††å½¢ã®ç´°é•·ã„å½¢ï¼‰ */
      min-width: 84px;
      height: 40px;
      padding: 0 16px;
      background: linear-gradient(135deg, var(--accentA) 0%, var(--accentB) 100%);
      color: white;
      border: none;
      border-radius: 999px;  /* â˜…ä¿®æ­£: å®Œå…¨ãªå††å½¢ã®ä¸¡ç«¯ */
      /* â˜…ä¿®æ­£: æ–‡å­—ã‚’å°ã•ã */
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow:
        0 0 12px color-mix(in oklab, var(--accentA) 50%, transparent),
        0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .fab button:hover {
      transform: scale(1.05);
      box-shadow:
        0 0 20px color-mix(in oklab, var(--accentA) 70%, transparent),
        0 6px 16px rgba(0, 0, 0, 0.4);
    }

    .fab button:active {
      transform: scale(0.98);
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-height: 700px) {
      .fab {
        bottom: calc(12px + env(safe-area-inset-bottom));
        right: 12px;
      }
      
      .fab button {
        min-width: 76px;
        height: 36px;
        font-size: 12px;
        padding: 0 14px;
      }
    }
    
    /* ========== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ãƒ†ã‚­ã‚¹ãƒˆä¸­å¤®æƒãˆ ========== */
    /* å®Œèµ°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    #resultModal .panel {
      text-align: center;
    }

    #resultModal .h {
      text-align: center;
      margin: 4px 0 12px;
    }

    #resultModal .small {
      text-align: center;
      white-space: pre-line;
      line-height: 1.6;
    }

    /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆconfirmAsyncï¼‰ */
    .modal .panel .h {
      text-align: center;
      white-space: pre-line;
      line-height: 1.7;
      margin: 8px 0 16px;
    }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚‚ä¸­å¤®æƒãˆ */
    #startModal .panel {
      text-align: center;
    }

    #startModal .h {
      text-align: center;
      margin: 4px 0 8px;
    }

    #startModal .small {
      text-align: center;
      white-space: pre-line;
      line-height: 1.6;
    }

    /* å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ä¸­å¤®æƒãˆ */
    #historyModal .h {
      text-align: center;
      margin: 4px 0 12px;
    }

    /* ========== ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒ»åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
    #privacyModal .panel,
    #termsModal .panel {
      text-align: left;
      padding: 20px;
    }

    #privacyContent,
    #termsContent {
      text-align: left;
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 13px;
      color: var(--text);
      max-height: 60vh;
      overflow-y: auto;
      padding: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 12px 0;
    }

    #privacyTitle,
    #termsTitle {
      text-align: center;
      margin-bottom: 16px;
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #privacyContent::-webkit-scrollbar,
    #termsContent::-webkit-scrollbar {
      width: 8px;
    }

    #privacyContent::-webkit-scrollbar-track,
    #termsContent::-webkit-scrollbar-track {
      background: rgba(255,255,255,.05);
      border-radius: 4px;
    }

    #privacyContent::-webkit-scrollbar-thumb,
    #termsContent::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.2);
      border-radius: 4px;
    }

    #privacyContent::-webkit-scrollbar-thumb:hover,
    #termsContent::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.3);
    }

    /* ========== ã‚«ãƒ¡ãƒ©èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« ========== */
    #cameraExplainModal .panel,
    #cameraDeniedModal .panel {
      padding: 24px 20px;
    }

    #cameraExplainBody,
    #cameraDeniedBody {
      font-size: 14px;
      color: var(--text);
      margin: 16px 0;
    }

    #cameraExplainBody ul,
    #cameraDeniedBody ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    #cameraExplainBody li,
    #cameraDeniedBody li {
      margin: 6px 0;
    }

    #cameraExplainPrivacy {
      font-size: 12px;
    }

    #cameraExplainDontShow {
      cursor: pointer;
    }
    
    /* ========== ãƒ†ãƒ³ã‚­ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ ========== */
    .numpad button {
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
      cursor: pointer;
    }
    
    /* 3. å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ã®åˆ¶å¾¡ - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    #question-area,
    .problem {
      touch-action: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç„¡åŠ¹ */
      overscroll-behavior: contain;
    }

    /* 4. ç­”ãˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã®åˆ¶å¾¡ - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    .answer,
    #answer {
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }
    #answer-display {
      touch-action: pan-y pinch-zoom; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ ã®ã¿è¨±å¯ */
    }
        /* 2. ãƒ†ãƒ³ã‚­ãƒ¼é ˜åŸŸã®ã‚¿ãƒƒãƒåˆ¶å¾¡ - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
        .numpad {
            touch-action: manipulation; /* ã‚¿ãƒƒãƒ—ã®ã¿è¨±å¯ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: contain;
        }
        
        /* 9. ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã¯é€šå¸¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
        .app {
            touch-action: auto;
            overflow: visible;
        }
        
        /* 10. ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ•ãƒƒã‚¿ãƒ¼ã¯å›ºå®šï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦ï¼‰ */
        header,
        footer {
            touch-action: none;
        }
        }
        
        /* iOSå°‚ç”¨ã‚¿ãƒƒãƒæœ€é©åŒ– */
        @supports (-webkit-touch-callout: none) {
          /* iOSã®ã¿ */
          * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
          }
          
          input, textarea {
            -webkit-user-select: auto;
          }
          
          button, .key, .pill, .btn {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(255,255,255,0.15);
          }
        }
        
</style>
</head>

<body class="theme-mix">
    <!-- â˜…è¿½åŠ : ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼ç”¨ï¼ˆéè¡¨ç¤ºï¼‰ -->
    <div id="ariaLive" aria-live="polite" aria-atomic="true" style="position:absolute; left:-9999px; width:1px; height:1px;"></div>
  <div class="wall"></div>
  <div class="beams"></div>

  <div class="app">
    <header>
      <div class="title" id="titleTxt">KuKuãƒ‰ãƒªãƒ«</div>
      <div class="row">
        <button id="paletteBtn" class="badge"><span id="paletteEmoji">ğŸ’™Ã—ğŸ’–</span><span id="paletteLabel">MIX</span></button>
        <div class="order-toggle" id="orderToggle" role="group" aria-label="å‡ºé¡Œé †ãƒˆã‚°ãƒ«">
          <button id="orderSeqBtn" class="ot-btn" aria-pressed="false" title="é †ç•ª"><span>ğŸ”¢</span></button>
          <button id="orderRndBtn" class="ot-btn" aria-pressed="true"  title="ãƒ©ãƒ³ãƒ€ãƒ "><span>ğŸ”€</span></button>
        </div>
      </div>
    </header>

    <div class="card">
      <div id="problem" class="problem" aria-live="assertive" aria-atomic="true">â€” Ã— â€” = ?</div>
      <input id="answer" class="kuku-input" type="text" inputmode="none" placeholder="ã“ãŸãˆ" readonly aria-labelledby="problem">

      <div class="keypad">
        <button type="button" class="key">7</button><button type="button" class="key">8</button><button type="button" class="key">9</button>
        <button type="button" class="key">4</button><button type="button" class="key">5</button><button type="button" class="key">6</button>
        <button type="button" class="key">1</button><button type="button" class="key">2</button><button type="button" class="key">3</button>
        <button type="button" class="key">0</button><button type="button" class="key">âŒ«</button><button type="button" class="key ok" id="okKey">OK</button>
      </div>

      <div id="result" class="result"></div>
      <div class="statrow">
        <div class="stat"><small id="labScore">ã‚¹ã‚³ã‚¢</small><b id="score">0</b></div>
        <div class="stat"><small id="labStreak">ã‚Œã‚“ã•</small><b id="streak">0</b></div>
        <div class="stat"><small id="labAvg">å¹³å‡ã‚¿ã‚¤ãƒ </small><b id="avgTime">â€”</b></div>
      </div>

      <details id="rangeD">
        <summary id="rngTitle">å‡ºé¡Œç¯„å›²ï¼ˆã‹ã‘ã‚‰ã‚Œã‚‹æ•° Ã— ã‹ã‘ã‚‹æ•°ï¼‰</summary>
        <div class="section-body">
          <div class="label" id="labA">ã‹ã‘ã‚‰ã‚Œã‚‹æ•°ï¼ˆæ®µï¼‰</div>
          <div id="danSet" class="pillset"></div>
          <div class="label" id="labB" style="margin-top:10px">ã‹ã‘ã‚‹æ•°ï¼ˆ1ã€œ10ï¼‰</div>
          <div id="kuSet" class="pillset"></div>
        </div>
      </details>

      <details id="modeD">
        <summary id="labMode">ãƒ¢ãƒ¼ãƒ‰</summary>
        <div class="section-body pillset" id="modeSet">
          <button class="pill active" data-mode="product" id="modeP">ç­”ãˆã‚’å…¥åŠ›ï¼ˆæ¨™æº–ï¼‰</button>
          <button class="pill" data-mode="missingB" id="modeMB">â–¡ Ã— B = ?ï¼ˆå·¦ã‚’å…¥åŠ›ï¼‰</button>
          <button class="pill" data-mode="missingA" id="modeMA">A Ã— â–¡ = ?ï¼ˆå³ã‚’å…¥åŠ›ï¼‰</button>
        </div>
      </details>

      <details id="ttD">
        <summary id="timerLabel">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</summary>
        <div class="section-body">
            <div class="pillset">
              <button class="pill" id="timer20">20å•</button><span class="pill small" id="best20" style="opacity:.65">Best: â€”</span>
              <button class="pill" id="timer30">30å•</button><span class="pill small" id="best30" style="opacity:.65">Best: â€”</span>
              <button class="pill" id="timer60">60å•</button><span class="pill small" id="best60" style="opacity:.65">Best: â€”</span>
              <button class="pill" id="timer81">ä¹ä¹(81å•)</button><span class="pill small" id="best81" style="opacity:.65">Best: â€”</span>
              <button class="pill" id="timer100">10Ã—10(100å•)</button><span class="pill small" id="best100" style="opacity:.65">Best: â€”</span>
              <!-- â˜…è¿½åŠ : 144å•ãƒœã‚¿ãƒ³ -->
              <button class="pill" id="timer144">12Ã—12(144å•)</button><span class="pill small" id="best144" style="opacity:.65">Best: â€”</span>
              <button class="pill" id="timerFree">ç„¡åˆ¶é™</button>
              <button class="pill grad" id="openHistory">å±¥æ­´</button>
            </div>

          <div class="label" id="labDanTT" style="margin-top:10px">æ®µã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</div>
          <div class="pillset" id="danTTSet">
            <button class="pill" id="timerDan1">1æ®µ</button>
            <button class="pill" id="timerDan2">2æ®µ</button>
            <button class="pill" id="timerDan3">3æ®µ</button>
            <button class="pill" id="timerDan4">4æ®µ</button>
            <button class="pill" id="timerDan5">5æ®µ</button>
            <button class="pill" id="timerDan6">6æ®µ</button>
            <button class="pill" id="timerDan7">7æ®µ</button>
            <button class="pill" id="timerDan8">8æ®µ</button>
            <button class="pill" id="timerDan9">9æ®µ</button>
            <button class="pill" id="timerDan10">10æ®µ</button>
            <!-- â˜…è¿½åŠ : 11æ®µã€12æ®µ -->
            <button class="pill" id="timerDan11">11æ®µ</button>
            <button class="pill" id="timerDan12">12æ®µ</button>
          </div>
        </div>
      </details>
    </div>

    <footer>&copy; KuKuãƒ‰ãƒªãƒ«</footer>
  </div>

  <button id="taStopFab" class="ta-stop-fab" type="button" aria-label="ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚’åœæ­¢" style="display:none">åœæ­¢</button>

  <div class="fab"><button id="openSettings">âš™ï¸è©³ç´°è¨­å®š</button></div>

  <div class="sheet" id="sheet" aria-hidden="true">
    <div class="grab"></div>
    <button class="iconbtn sheet-close" id="closeSettingsTop" aria-label="é–‰ã˜ã‚‹" title="é–‰ã˜ã‚‹">âœ•</button>
    <div class="inner">
      <div class="label" id="secSound">ã‚µã‚¦ãƒ³ãƒ‰</div>
      <div class="pillset" id="soundPack">
        <div class="opt pill" data-pack="synth">Synth Pop</div>
        <div class="opt pill" data-pack="edm">EDM</div>
        <div class="opt pill" data-pack="cute">Cute</div>
      </div>

      <div class="label" id="secLang">è¨€èªè¨­å®š</div>
      <div class="pillset" id="langSet">
        <button class="pill" data-lang="ja">æ—¥æœ¬èª | JP</button>
        <button class="pill" data-lang="en">è‹±èª | EN</button>
      </div>

      <div class="label" id="secTog">èª­ã¿ä¸Šã’ / åŠ¹æœéŸ³ / å¿œæ´</div>
      <div class="pillset" id="toggles">
        <button class="pill toggle" data-flag="speak" id="togSpeak">èª­ã¿ä¸Šã’</button>
        <button class="pill toggle" data-flag="sfx"   id="togSfx">åŠ¹æœéŸ³</button>
        <button class="pill toggle" data-flag="cheer" id="togCheer">å¿œæ´</button>
      </div>
      
      <div class="label" id="secPerf">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
      <div class="pillset">
        <button class="pill toggle" id="togLite" data-flag="lite">è»½é‡ãƒ¢ãƒ¼ãƒ‰</button>
      </div>

      <div class="label" id="secCheer">å¿œæ´</div>
      <div class="pillset">
        <button class="pill" id="faceBtn">é¡”ã‚’è¨­å®š</button>
        <button class="pill" id="faceDel">é¡”ã‚’å‰Šé™¤</button>
      </div>

      <div class="label" id="secBg">èƒŒæ™¯ç”»åƒ</div>
      <div class="pillset">
        <button class="pill" id="bgPick">èƒŒæ™¯ã‚’é¸æŠ</button>
        <button class="pill" id="bgReset">èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ</button>
        <input type="file" id="bgFile" accept="image/*" style="display:none">
      </div>

      <div class="label" id="secBright">æ˜ã‚‹ã•</div>
      <input type="range" id="bgBright" min="0" max="100" value="36" style="width:100%">

      <div class="label" id="secSize" style="margin-top:12px">èƒŒæ™¯ã‚µã‚¤ã‚º</div>
      <input type="range" id="bgSize" min="100" max="200" value="100" style="width:100%">

      <div class="label" id="dataLabel" style="margin-top:12px">ãƒ‡ãƒ¼ã‚¿</div>
      <div class="pillset">
        <button class="pill" id="hardResetBtn" type="button">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
      </div>
      
      <div class="label" id="secPrivacy" style="margin-top:12px">æ³•çš„æƒ…å ±</div>
      <div class="pillset">
        <button class="pill" id="privacyBtn">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</button>
        <button class="pill" id="termsBtn">åˆ©ç”¨è¦ç´„</button>
      </div>


      <div class="row" style="justify-content:center;margin-top:12px">
        <button class="btn grad" id="closeSettings">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ã‚«ãƒ¡ãƒ©ä½¿ç”¨èª¬æ˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="cameraExplainModal">
    <div class="back"></div>
    <div class="panel" style="text-align:center; max-width:480px;">
      <div style="font-size:48px; margin:16px 0;">ğŸ“¸</div>
      <div class="h" id="cameraExplainTitle">ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã«ã¤ã„ã¦</div>
      <div class="small" id="cameraExplainBody" style="text-align:left; line-height:1.8; padding:0 8px;">
  <!-- JavaScriptã§æŒ¿å…¥ -->
      </div>
      <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                  border:1px solid var(--border); border-radius:12px; padding:12px; margin:16px 0; text-align:left;">
        <div style="font-size:13px; color:var(--muted); line-height:1.6;" id="cameraExplainPrivacy">
  <!-- JavaScriptã§æŒ¿å…¥ -->
        </div>
      </div>
      <div class="btnrow">
        <button class="btn" id="cameraExplainCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn grad" id="cameraExplainOk">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
      </div>
      <div style="margin-top:12px;">
        <label style="display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; color:var(--muted);">
          <input type="checkbox" id="cameraExplainDontShow" style="width:16px; height:16px;">
          <span id="cameraExplainDontShowLabel">æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„</span>
        </label>
      </div>
    </div>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="cameraDeniedModal">
    <div class="back"></div>
    <div class="panel" style="text-align:center; max-width:480px;">
      <div style="font-size:48px; margin:16px 0;">ğŸš«</div>
      <div class="h" id="cameraDeniedTitle">ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</div>
      <div class="small" id="cameraDeniedBody" style="text-align:left; line-height:1.8; padding:0 8px;">
  <!-- JavaScriptã§æŒ¿å…¥ -->
      </div>
      <div class="btnrow">
        <button class="btn" id="cameraDeniedUseFile">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</button>
        <button class="btn grad" id="cameraDeniedSettings">è¨­å®šã‚’é–‹ã</button>
      </div>
      <div class="btnrow" style="margin-top:8px;">
        <button class="btn" id="cameraDeniedClose" style="width:100%;">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>


  <div class="modal" id="faceModal"><div class="back"></div><div class="panel" style="text-align:center">
    <div class="h" id="faceTitle">å¿œæ´ã®é¡”ã‚’æ’®å½±</div>
    <div class="small" id="faceHint">ä¸¸æ ã«é¡”ã‚’å…¥ã‚Œã¦ã­ã€‚<br><strong>â€»ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã®ã¿ã§å‡¦ç†ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</strong></div>
    <div id="faceBox" style="position:relative; width:min(70vw,320px); height:min(70vw,320px); margin:16px auto;">
      <video id="cam" autoplay playsinline style="position:absolute;inset:0;width:100%;height:100%;border-radius:50%;object-fit:cover;background:#000"></video>
      <canvas id="shot" width="320" height="320" style="position:absolute;inset:0;width:100%;height:100%;border-radius:50%;display:none"></canvas>
      <div style="position:absolute;inset:0;border-radius:50%;box-shadow:inset 0 0 0 6px rgba(255,255,255,.9);pointer-events:none"></div>
    </div>
    <button class="btn" id="facePickFile" style="margin-bottom: 10px;">æ’®å½± | ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</button>
    <input type="file" id="faceFileInput" accept="image/*" style="display:none">
    <div class="btnrow">
      <button class="btn" id="faceCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn grad" id="faceTake">æ’®å½±</button>
      <button class="btn grad" id="faceSave" disabled>ä¿å­˜</button>
    </div>
  </div></div>

  <div class="modal" id="startModal"><div class="back"></div><div class="panel" style="text-align:center">
    <div class="h" id="startTitle">ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ</div>
    <div class="small" id="startDesc">é¸æŠã—ãŸæœ¬æ•°ã§é–‹å§‹ã—ã¾ã™ã€‚</div>
    <div id="countNum" style="font-size:46px;font-weight:900;margin:8px 0">â±</div>
    <div class="btnrow">
      <button class="btn" id="startCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn grad" id="startGo">OK</button>
    </div>
  </div></div>

  <div class="modal" id="resultModal"><div class="back"></div><div class="panel">
    <div class="h" id="rpTitle">çµæœ</div>
    <div class="small" id="rpBody" style="white-space:pre-line">â€”</div>
    <div class="btnrow">
      <button class="btn grad" id="rpShare">å…±æœ‰</button>
      <button class="btn" id="rpCopy">ã‚³ãƒ”ãƒ¼</button>
      <button class="btn grad" id="rpClose">OK</button>
    </div>
  </div></div>

    <!-- ========================================
     âœ… ã“ã“ã«è¿½åŠ ï¼çµ±è¨ˆç”»é¢ã®HTML
     ======================================== -->
<div id="statsScreen" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:600px; max-height:80vh; overflow-y:auto; padding:20px; background:#1a1a2e; color:#eee; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.5); z-index:10000;">
  <h2 style="text-align:center; color:#9c2cff; margin-bottom:20px;">ğŸ“Š çµ±è¨ˆ</h2>
  
  <div id="statsContent" style="background:#2a2a3e; padding:15px; border-radius:8px; margin-bottom:20px;">
    <p style="margin:8px 0;">ç·å•é¡Œæ•°: <span id="totalQuestions" style="color:#9c2cff; font-weight:bold;">0</span>å•</p>
    <p style="margin:8px 0;">å¹³å‡ã‚¹ã‚³ã‚¢: <span id="avgScore" style="color:#9c2cff; font-weight:bold;">0</span>ç‚¹</p>
    <p style="margin:8px 0;">å¹³å‡ã‚¿ã‚¤ãƒ : <span id="avgTime" style="color:#9c2cff; font-weight:bold;">0</span>ç§’</p>
    <p style="margin:8px 0;">æœ€é«˜ã‚¹ã‚³ã‚¢: <span id="bestScore" style="color:#9c2cff; font-weight:bold;">0</span>ç‚¹</p>
    <p style="margin:8px 0;">æœ€é€Ÿã‚¿ã‚¤ãƒ : <span id="bestTime" style="color:#9c2cff; font-weight:bold;">0</span>ç§’</p>
  </div>
  
  <h3 style="margin-top:20px; margin-bottom:10px; color:#9c2cff;">æ®µåˆ¥æˆç¸¾</h3>
  <div id="danStats" style="max-height:300px; overflow-y:auto;"></div>
  
  <button onclick="closeStats()" style="margin-top:20px; padding:12px 24px; background:#9c2cff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:16px; width:100%;">é–‰ã˜ã‚‹</button>
</div>

<!-- çµ±è¨ˆç”»é¢ã®èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="statsOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999;" onclick="closeStats()"></div>

<!-- çµ±è¨ˆãƒœã‚¿ãƒ³ï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ã«è¿½åŠ ï¼‰ -->
<button id="showStatsBtn" onclick="showStats()" style="position:fixed; top:20px; right:20px; padding:12px 20px; background:#9c2cff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:16px; box-shadow:0 2px 10px rgba(156,44,255,0.3); z-index:1000; display:flex; align-items:center; gap:8px;">
  ğŸ“Š çµ±è¨ˆ
</button>

  <div class="modal" id="historyModal"><div class="back"></div><div class="panel" style="display:flex;flex-direction:column;max-height:85vh">
    <div class="h" id="histTitle">å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰</div>
    <div id="historyContent" class="small" style="flex-grow:1;overflow:auto">â€”</div>
    <div class="btnrow">
      <button class="btn" id="clearHistory" type="button">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      <button class="btn grad" id="historyClose">é–‰ã˜ã‚‹</button>
    </div>
  </div></div>
    
<script>

'use strict';
// ğŸ”„ Cache Buster: 2025-12-26 11:38 (ç¾åœ¨ã®æ—¥æ™‚ã‚’å…¥åŠ›)

// ========================================
// IndexedDB åˆæœŸåŒ–
// ========================================


// ========================================
// IndexedDB ã«ã‚ˆã‚‹æ°¸ç¶šåŒ–ï¼ˆKuKu Drill+ï¼‰
// ========================================

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–
let db;
const DB_NAME = 'KuKuDrillDB';
const DB_VERSION = 1;
const STORE_NAME = 'records';

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
        objectStore.createIndex('danNumber', 'danNumber', { unique: false });
      }
    };
  });
}

// è¨˜éŒ²ã‚’ä¿å­˜
async function saveRecord(record) {
  if (!db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const objectStore = transaction.objectStore(STORE_NAME);
    const request = objectStore.add({
      timestamp: Date.now(),
      questionCount: record.questionCount,
      timeTaken: record.timeTaken,
      score: record.score,
      danNumber: record.danNumber || null,
      mode: record.mode || 'normal'
    });
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// ã™ã¹ã¦ã®è¨˜éŒ²ã‚’å–å¾—
async function getAllRecords() {
  if (!db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const objectStore = transaction.objectStore(STORE_NAME);
    const request = objectStore.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
  });
}

// æ®µåˆ¥ã®çµ±è¨ˆã‚’å–å¾—
async function getStatsByDan(danNumber) {
  const allRecords = await getAllRecords();
  const danRecords = allRecords.filter(r => r.danNumber === danNumber);
  
  if (danRecords.length === 0) return null;
  
  const totalScore = danRecords.reduce((sum, r) => sum + r.score, 0);
  const totalTime = danRecords.reduce((sum, r) => sum + parseFloat(r.timeTaken), 0);
  const avgScore = totalScore / danRecords.length;
  const avgTime = totalTime / danRecords.length;
  
  return {
    totalAttempts: danRecords.length,
    avgScore: avgScore.toFixed(1),
    avgTime: avgTime.toFixed(1),
    bestScore: Math.max(...danRecords.map(r => r.score)),
    bestTime: Math.min(...danRecords.map(r => parseFloat(r.timeTaken))).toFixed(1)
  };
}

// ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«DBã‚’åˆæœŸåŒ–
initDB().then(() => {
  console.log('âœ… IndexedDB initialized');
}).catch(err => {
  console.error('âŒ IndexedDB initialization failed:', err);
});

/* ========= 0) åˆæœŸãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ•ãƒ©ã‚°ï¼ˆå³åº§ã«æœ‰åŠ¹åŒ–ï¼‰
    let userInteracted = true;  // â˜…ä¿®æ­£: æœ€åˆã‹ã‚‰trueã«è¨­å®šï¼ˆå¾…æ©Ÿæ™‚é–“ã‚’ã‚¼ãƒ­ã«ï¼‰
    
function measureFps(n=10){return new Promise(r=>{let f=0,s;function step(t){if(!s)s=t;if(++f<n)requestAnimationFrame(step);else r(1000*f/(t-s));}requestAnimationFrame(step);});}
function applyLite(v){ document.body.classList.toggle('perf-lite', !!v); localStorage.setItem('kukuLite', v?'1':'0'); }
(()=>{ applyLite(false); localStorage.setItem('kukuLite','0'); })();

function debounce(fn, ms) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => {
      fn.apply(this, args);
    }, ms);
  };
}

/* ========= 1) localStorage safe shim ========= */
(function(){
  let ok=true; try{const k='__ls__'; localStorage.setItem(k,'1'); localStorage.removeItem(k);}catch(e){ok=false}
  if(!ok){
    let mem={};
    window.localStorage = {
      getItem:k=>Object.prototype.hasOwnProperty.call(mem,k)?mem[k]:null,
      setItem:(k,v)=>{mem[k]=String(v)}, removeItem:k=>{delete mem[k]}, clear:()=>{mem={}},
      key:i=>Object.keys(mem)[i]||null, get length(){return Object.keys(mem).length}
    };
    try{ alert('ã“ã®ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ã¯ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒç„¡åŠ¹ã§ã™ã€‚å±¥æ­´ã‚„è¨­å®šã¯æ¬¡å›èµ·å‹•æ™‚ã«æ®‹ã‚Šã¾ã›ã‚“ã€‚'); }catch(_){}
  }
})();

/* ========= 2) ã‚¢ãƒ—ãƒªæœ¬ä½“(IIFE) ========= */
    (function(){
        const $=id=>document.getElementById(id);
        /* ========= åˆå›èµ·å‹•æ™‚ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ç”»é¢ ========= */
        async function showFirstLaunchPrivacy(){
          console.log('ğŸ”´ showFirstLaunchPrivacy é–‹å§‹');
          
          // æ—¢ã«åŒæ„æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
          const agreed = localStorage.getItem('privacyAgreed');
          console.log('ğŸ”´ privacyAgreed:', agreed);
          
          if(agreed === '1'){
            console.log('ğŸ”´ æ—¢ã«åŒæ„æ¸ˆã¿ã®ãŸã‚return');
            return;
          }

          const firstModal = $('firstLaunchModal');  // â˜… modal â†’ firstModal ã«å¤‰æ›´
          console.log('ğŸ”´ firstLaunchModal:', firstModal);
          
          if(!firstModal) {  // â˜… modal â†’ firstModal
            console.error('ğŸ”´ firstLaunchModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
            return;
          }

          console.log('ğŸ”´ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
          
          // è¨€èªå–å¾—
          const currentLang = localStorage.getItem('kukuLang') || 'ja';
          console.log('ğŸ”´ currentLang:', currentLang);
          
          // è¨€èªã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
          const title = $('firstLaunchTitle');
          const body = $('firstLaunchBody');
          const agreeBtn = $('firstLaunchAgree');

          if(currentLang === 'en'){
            if(title) title.innerHTML = 'Privacy & Data Handling';
            
            if(body){
              body.innerHTML = `
                <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                            border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
                  <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
                    âœ¨ About This App
                  </div>
                  <div class="small" style="line-height:1.7; color:var(--muted);">
                    KuKu Drill is an educational app for learning multiplication tables.<br>
                    All data is stored only on your device and never transmitted externally.
                  </div>
                </div>

                <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                            border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
                  <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
                    ğŸ”’ Privacy Protection
                  </div>
                  <ul class="small" style="line-height:1.7; color:var(--muted); margin:0; padding-left:20px;">
                    <li>Learning data stored on device only</li>
                    <li>No internet required (fully offline)</li>
                    <li>No personal information collected</li>
                    <li>No ads or tracking</li>
                  </ul>
                </div>

                <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                            border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
                  <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
                    ğŸ“¸ Camera Feature (Optional)
                  </div>
                  <div class="small" style="line-height:1.7; color:var(--muted);">
                    Cheer character feature can use camera.<br>
                    â€¢ Camera use is <strong>completely optional</strong><br>
                    â€¢ Photos stored on device only<br>
                    â€¢ Never transmitted externally<br>
                    â€¢ Can be deleted anytime
                  </div>
                </div>

                <div style="background:linear-gradient(180deg, rgba(59,199,255,.12), rgba(59,199,255,.04)); 
                            border:1px solid rgba(59,199,255,.3); border-radius:12px; padding:14px; margin-bottom:16px;">
                  <div class="small" style="line-height:1.7; color:var(--text); text-align:center;">
                    See
                    <button id="privacyLinkFromFirst" 
                            style="background:none; border:0; color:var(--accentB); 
                                   text-decoration:underline; cursor:pointer; font-size:inherit; padding:0;">
                      Privacy Policy
                    </button>
                    and
                    <button id="termsLinkFromFirst"
                            style="background:none; border:0; color:var(--accentB); 
                                   text-decoration:underline; cursor:pointer; font-size:inherit; padding:0;">
                      Terms of Use
                    </button>
                    for details
                  </div>
                </div>
              `;
            }

            if(agreeBtn) agreeBtn.textContent = 'Agree & Start';
          }

          // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          firstModal.classList.add('show');
          setOverlayLock(true);

          // åŒæ„ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
          const agreeButton = $('firstLaunchAgree');
          if(agreeButton){
            agreeButton.onclick = ()=>{
              try{
                localStorage.setItem('privacyAgreed', '1');
                console.log('âœ… Privacy agreed and saved');
              }catch(e){
                console.error('âŒ Failed to save privacy agreement:', e);
              }
              
              firstModal.classList.remove('show');
              setOverlayLock(false);
            };
          }

          // ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒªãƒ³ã‚¯
          const privacyLink = $('privacyLinkFromFirst');
          if(privacyLink){
            privacyLink.onclick = (e)=>{
              e.preventDefault();
              e.stopPropagation();
              
              // åŒæ„ç”»é¢ã‚’é–‰ã˜ã‚‹
              firstModal.classList.remove('show');
              setOverlayLock(false);
              
              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã‚’é–‹ã
              setTimeout(()=>{
                const privacyModal = $('privacyModal');
                const privacyContent = $('privacyContent');
                
                if(privacyModal && privacyContent){
                  // æ—¥æœ¬èª/è‹±èªã«å¿œã˜ãŸå†…å®¹ã‚’è¨­å®š
                  setupPrivacyContent();
                  
                  privacyModal.classList.add('show');
                  setOverlayLock(true);
                  
                  // â˜…è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                  const privacyClose = $('privacyClose');
                  if(privacyClose){
                    privacyClose.onclick = ()=>{
                      privacyModal.classList.remove('show');
                      setOverlayLock(false);
                      
                      // åˆå›èµ·å‹•ç”»é¢ã«æˆ»ã‚‹
                      setTimeout(()=>{
                        firstModal.classList.add('show');
                        setOverlayLock(true);
                      }, 300);
                    };
                  }
                  
                  // â˜…è¿½åŠ : èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                  const privacyBack = privacyModal.querySelector('.back');
                  if(privacyBack){
                    privacyBack.onclick = ()=>{
                      privacyModal.classList.remove('show');
                      setOverlayLock(false);
                      
                      // åˆå›èµ·å‹•ç”»é¢ã«æˆ»ã‚‹
                      setTimeout(()=>{
                        firstModal.classList.add('show');
                        setOverlayLock(true);
                      }, 300);
                    };
                  }
                }
              }, 300);
            };
          }

          // åˆ©ç”¨è¦ç´„ãƒªãƒ³ã‚¯
          const termsLink = $('termsLinkFromFirst');
          if(termsLink){
            termsLink.onclick = (e)=>{
              e.preventDefault();
              e.stopPropagation();
              
              // åŒæ„ç”»é¢ã‚’é–‰ã˜ã‚‹
              firstModal.classList.remove('show');
              setOverlayLock(false);
              
              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆ©ç”¨è¦ç´„ã‚’é–‹ã
              setTimeout(()=>{
                const termsModal = $('termsModal');
                const termsContent = $('termsContent');
                
                if(termsModal && termsContent){
                  // æ—¥æœ¬èª/è‹±èªã«å¿œã˜ãŸå†…å®¹ã‚’è¨­å®š
                  setupTermsContent();
                  
                  termsModal.classList.add('show');
                  setOverlayLock(true);
                  
                  // â˜…è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                  const termsClose = $('termsClose');
                  if(termsClose){
                    termsClose.onclick = ()=>{
                      termsModal.classList.remove('show');
                      setOverlayLock(false);
                      
                      // åˆå›èµ·å‹•ç”»é¢ã«æˆ»ã‚‹
                      setTimeout(()=>{
                        firstModal.classList.add('show');
                        setOverlayLock(true);
                      }, 300);
                    };
                  }
                  
                  // â˜…è¿½åŠ : èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                  const termsBack = termsModal.querySelector('.back');
                  if(termsBack){
                    termsBack.onclick = ()=>{
                      termsModal.classList.remove('show');
                      setOverlayLock(false);
                      
                      // åˆå›èµ·å‹•ç”»é¢ã«æˆ»ã‚‹
                      setTimeout(()=>{
                        firstModal.classList.add('show');
                        setOverlayLock(true);
                      }, 300);
                    };
                  }
                }
              }, 300);
            };
          }
          }


        const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn);
        const isiOS=/iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        /* èƒŒé¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
        function setOverlayLock(onLock){
            const body=document.body;
            body.classList.toggle('overlay-open',!!onLock);
            if(onLock){
                body.dataset.scrollY=String(window.scrollY);
                body.style.position='fixed'; body.style.top=`-${window.scrollY}px`; body.style.width='100%';
            }else{
                const y=body.dataset.scrollY;
                body.style.position=''; body.style.top=''; body.style.width='';
                if(y) window.scrollTo(0,parseInt(y,10));
            }
        }
        
        async function confirmAsync(message){
            return new Promise(resolve=>{
                const m=document.createElement('div');
                m.className='modal show';
                m.innerHTML=`<div class="back"></div><div class="panel" style="text-align:center">
        <div class="h">${message}</div>
        <div class="btnrow">
          <button class="btn" id="cfNo">${(appLang==='ja')?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'Cancel'}</button>
          <button class="btn grad" id="cfYes">OK</button>
        </div></div>`;
        document.body.appendChild(m);
        setOverlayLock(true);
        const done=ok=>{ m.remove(); setOverlayLock(false); resolve(ok); };
        m.querySelector('.back').onclick = ()=>done(false);
        m.querySelector('#cfNo').onclick  = ()=>done(false);
        m.querySelector('#cfYes').onclick = ()=>done(true);
            });
        }
        
        function scrollToInput(){
          const a = $('answer');
          if(!a) return;

          // ãƒ¢ãƒ¼ãƒ€ãƒ«/ãƒ­ãƒƒã‚¯ä¸­ã¯ä½•ã‚‚ã—ãªã„
          if(document.querySelectorAll('.modal.show').length>0) return;
          if(document.body.classList.contains('overlay-open')) return;

          // ã¾ãšè¦ç´ ã¸å¯„ã›ã‚‹ï¼ˆiOSã§å¼·ã„ï¼‰
          try{
            a.scrollIntoView({ block:'center', inline:'nearest', behavior:'smooth' });
          }catch(_){
            // å¤ã„ç’°å¢ƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const rect=a.getBoundingClientRect();
            window.scrollTo(0, rect.top + window.pageYOffset - window.innerHeight/3);
          }

          // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å‡ºã—ãŸã„å ´åˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã•ã›ãªã„ï¼‰
          setTimeout(()=>{
            try{ a.focus({ preventScroll:true }); }catch(_){ a.focus(); }
          }, 50);
        }
        
        /* ãƒ†ãƒ¼ãƒ */
        const paletteBtn=$('paletteBtn'), paletteLabel=$('paletteLabel'), paletteEmoji=$('paletteEmoji');
        function setTheme(t){
            document.body.classList.remove('theme-mix','theme-pink','theme-blue');
            if(t==='pink'){
                document.body.classList.add('theme-pink');
                paletteLabel.textContent='PINK';
                paletteEmoji.textContent='ğŸ’–';
            }
            else if(t==='blue'){
                document.body.classList.add('theme-blue');
                paletteLabel.textContent='BLUE';
                paletteEmoji.textContent='ğŸ’™';
            }
            else{
                document.body.classList.add('theme-mix');
                paletteLabel.textContent='MIX';
                paletteEmoji.textContent='ğŸ’™Ã—ğŸ’–';
                t='mix';
            }
            localStorage.setItem('kukuTheme', t);
            
            // â˜…è¿½åŠ : ãƒ“ãƒ¼ãƒ ã‚’å†æç”»ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«è‰²å¤‰æ›´
            const beams = document.querySelector('.beams');
            if(beams){
                beams.style.opacity = '0';
                setTimeout(()=>{
                    beams.style.opacity = '.9';
                }, 50);
            }
        }
        
        setTheme(localStorage.getItem('kukuTheme')||'mix');
        paletteBtn.onclick=()=>{ const cur=localStorage.getItem('kukuTheme')||'mix'; setTheme(cur==='mix'?'pink':(cur==='pink'?'blue':'mix')); };
        
        /* è¨€èª */
        const i18n={
            ja:{title:'KuKuãƒ‰ãƒªãƒ«',answerPH:'ã“ãŸãˆ',score:'ã‚¹ã‚³ã‚¢',streak:'ã‚Œã‚“ã•',avg:'å¹³å‡ã‚¿ã‚¤ãƒ ',
                range:'å‡ºé¡Œç¯„å›²ï¼ˆã‹ã‘ã‚‰ã‚Œã‚‹æ•° Ã— ã‹ã‘ã‚‹æ•°ï¼‰',A:'ã‹ã‘ã‚‰ã‚Œã‚‹æ•°ï¼ˆæ®µï¼‰',B:'ã‹ã‘ã‚‹æ•°ï¼ˆ1ã€œ10ï¼‰',
                timer:'ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯', notStarted:'æœªé–‹å§‹',
                speakProb:(a,b)=>`${a} ã‹ã‘ã‚‹ ${b}`,
                remainOk:n=>`ã®ã“ã‚Š ${n} å•ï¼ˆãƒŸã‚¹ãªã—ï¼‰`, remainNg:n=>`ã®ã“ã‚Š ${n} å•ï¼ˆãƒŸã‚¹ã‚ã‚Šï¼šè¨˜éŒ²å¤–ï¼‰`,
                runDone:n=>`${n}å• å®Œèµ°ï¼ğŸƒğŸ’¨`, runInvalid:`é€”ä¸­ã§ã¾ã¡ãŒã„ãŒã‚ã‚Šã¾ã—ãŸğŸ¤¯ã–ã‚“ã­ã‚“ğŸ˜¢`,
                bestLabel:(sec,score,date)=>`Best: ${sec.toFixed(1)}ç§’ / ${score}ç‚¹ï¼ˆ${date}ï¼‰`,
                thisTime:'ä»Šå›', bestPrefix:'è‡ªå·±ãƒ™ã‚¹ãƒˆ', secUnit:'ç§’', ptsUnit:'ç‚¹',
                unlimitedLine:(q,sec,pts)=>`è§£ã„ãŸæ•°: ${q}å• / æ‰€è¦ ${sec}ç§’ / ${pts}ç‚¹ï¼ˆè¨˜éŒ²å¯¾è±¡å¤–ï¼‰`,
                shareAllOk:(n,sec,pts)=>`KuKu ${n}å• å®Œèµ°ğŸƒğŸ’¨ï¼ â±${sec}ç§’ / ${pts}ç‚¹`,
                shareGeneric:(n,sec,pts,ok,total)=>`KuKu ${n}å• â±${sec}ç§’ / ${pts}ç‚¹ / ${ok}/${total}`,
                shareUnlimited:(q,sec,pts)=>`KuKu ç„¡åˆ¶é™ ${q}Q â±${sec}ç§’ / ${pts}ç‚¹`},
            en:{title:'KuKu Drill',answerPH:'answer',score:'Score',streak:'Streak',avg:'Avg time',
                range:'Range (Multiplicand Ã— Multiplier)',A:'Multiplicand (tables)',B:'Multiplier (1â€“10)',
                timer:'Time Trial',notStarted:'Not started',
                speakProb:(a,b)=>`${a} times ${b}`,
                remainOk:n=>`${n} left (no miss)`, remainNg:n=>`${n} left (miss: no record)`,
                runDone:n=>`${n}Q Completed!`, runInvalid:`Record void due to a mistake.`,
                bestLabel:(sec,score,date)=>`Best: ${sec.toFixed(1)}s / ${score}pts (${date})`,
                thisTime:'This run', bestPrefix:'Personal best', secUnit:'s', ptsUnit:'pts',
                unlimitedLine:(q,sec,pts)=>`Solved: ${q}Q / Time ${sec}s / ${pts}pts (not recorded)`,
                shareAllOk:(n,sec,pts)=>`KuKu ${n}Q All correct! â±${sec}s / ${pts}pts`,
                shareGeneric:(n,sec,pts,ok,total)=>`KuKu ${n}Q â±${sec}s / ${pts}pts / ${ok}/${total}`,
                shareUnlimited:(q,sec,pts)=>`KuKu Free ${q}Q â±${sec}s / ${pts}pts`}
        };
        let appLang=localStorage.getItem('kukuLang')||'ja';
        function setLang(lang){
            appLang=(lang==='en')?'en':'ja';
            try{ localStorage.setItem('kukuLang',appLang); }catch(_){}
            updateLangUI();
            if(typeof refreshFaceButtons==='function') refreshFaceButtons();
        }
        on($('langSet'),'click',e=>{
            const b=e.target.closest('button'); if(!b) return;
            setLang(b.dataset.lang);
            document.querySelectorAll('#langSet .pill').forEach(x=>x.classList.toggle('active',x===b));
        });
        function txt(el,s){ if(el) el.textContent=s; }
        
        let allowedA=new Set(JSON.parse(localStorage.getItem('allowedA')||'[1,2,3,4,5,6,7,8,9,10,11,12]'));
        let allowedB=new Set(JSON.parse(localStorage.getItem('allowedB')||'[1,2,3,4,5,6,7,8,9,10,11,12]'));
        
        
        function buildPills(container,type){
            container.innerHTML='';
            for(let i=1;i<=12;i++){
                const set=(type==='A'?allowedA:allowedB); const active=set.has(i);
                const btn=document.createElement('button'); btn.className='pill'+(active?' active':'');
                btn.textContent=(type==='A'?(appLang==='ja'?i+'æ®µ':i+'Ã—'):String(i));
                btn.onclick=()=>{ set.has(i)?set.delete(i):set.add(i); btn.classList.toggle('active'); localStorage.setItem(type==='A'?'allowedA':'allowedB', JSON.stringify([...set])); pop(); newProblem(true); };
                container.appendChild(btn);
            }
        }
        
        function updateLangUI(){
            const t=i18n[appLang];
            document.documentElement.lang=(appLang==='ja'?'ja':'en');
            txt($('titleTxt'),t.title);
            const ans=$('answer'); if(ans) ans.placeholder=t.answerPH;
            txt($('labScore'),t.score); txt($('labStreak'),t.streak); txt($('labAvg'),t.avg);
            txt($('rngTitle'),t.range); txt($('labA'),t.A); txt($('labB'),t.B);
            document.querySelectorAll('#langSet .pill').forEach(b=>b.classList.toggle('active', b.dataset.lang===appLang));
            txt($('labMode'), (appLang==='ja'?'ãƒ¢ãƒ¼ãƒ‰':'Mode'));
            txt($('modeP'),   (appLang==='ja'?'ç­”ãˆã‚’å…¥åŠ›ï¼ˆæ¨™æº–ï¼‰':'Enter product (default)'));
            txt($('modeMB'),  (appLang==='ja'?'â–¡ Ã— B = ?ï¼ˆå·¦ã‚’å…¥åŠ›ï¼‰':'â–¡ Ã— B = ? (fill left)'));
            txt($('modeMA'),  (appLang==='ja'?'A Ã— â–¡ = ?ï¼ˆå³ã‚’å…¥åŠ›ï¼‰':'A Ã— â–¡ = ? (fill right)'));
            const tl=$('timerLabel'); if(tl){ tl.textContent=t.timer; }
            
            const stopFab=$('taStopFab');
            if(stopFab){
                stopFab.textContent=(appLang==='ja')?'åœæ­¢':'Stop';
                stopFab.setAttribute('aria-label',(appLang==='ja')?'ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚’åœæ­¢':'Stop time trial');
            }
            
            txt($('secSound'), appLang==='ja'?'ã‚µã‚¦ãƒ³ãƒ‰':'Sound');
            txt($('secLang'),  appLang==='ja'?'è¨€èªè¨­å®š':'Language');
            txt($('secTog'),   appLang==='ja'?'èª­ã¿ä¸Šã’ / åŠ¹æœéŸ³ / å¿œæ´':'TTS / SFX / Cheer');
            txt($('secCheer'), appLang==='ja'?'å¿œæ´':'Cheer');
            txt($('secBg'),    appLang==='ja'?'èƒŒæ™¯ç”»åƒ':'Background');
            txt($('secBright'),appLang==='ja'?'æ˜ã‚‹ã•':'Brightness');
            txt($('secSize'),  appLang==='ja'?'èƒŒæ™¯ã‚µã‚¤ã‚º':'Background size');
            txt($('dataLabel'),appLang==='ja'?'ãƒ‡ãƒ¼ã‚¿':'Data');
            
            txt($('togSpeak'), appLang==='ja'?'èª­ã¿ä¸Šã’':'TTS');
            txt($('togSfx'),   appLang==='ja'?'åŠ¹æœéŸ³':'SFX');
            txt($('togCheer'), appLang==='ja'?'å¿œæ´':'Cheer');
            
            txt($('faceBtn'),  appLang==='ja'?'é¡”ã‚’è¨­å®š':'Set face');
            txt($('faceDel'),  appLang==='ja'?'é¡”ã‚’å‰Šé™¤':'Remove face');
            txt($('bgPick'),   appLang==='ja'?'èƒŒæ™¯ã‚’é¸æŠ':'Set Background');
            txt($('bgReset'),  appLang==='ja'?'èƒŒæ™¯ã‚’å‰Šé™¤':'Reset background');
            txt($('hardResetBtn'), appLang==='ja'?'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤':'Reset all data');
            
            txt($('openSettings'), appLang==='ja'?'âš™ï¸è©³ç´°è¨­å®š':'âš™ï¸ Settings');
            txt($('closeSettings'),appLang==='ja'?'é–‰ã˜ã‚‹':'Close');
            
            txt($('startTitle'), appLang==='ja'?'ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ':'Ready to start?');
            txt($('startCancel'),appLang==='ja'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'Cancel');
            txt($('startGo'),    'OK');
            txt($('rpTitle'), appLang==='ja'?'çµæœ':'Results');
            txt($('rpShare'), appLang==='ja'?'å…±æœ‰':'Share');
            txt($('rpCopy'),  appLang==='ja'?'ã‚³ãƒ”ãƒ¼':'Copy text');
            txt($('rpClose'), 'OK');
            
            buildPills($('danSet'),'A'); buildPills($('kuSet'),'B');
            
            (function(){
                $('timer20').textContent=(appLang==='ja')?'20å•':'20Q';
                $('timer30').textContent=(appLang==='ja')?'30å•':'30Q';
                $('timer60').textContent=(appLang==='ja')?'60å•':'60Q';
                $('timer81').textContent=(appLang==='ja')?'ä¹ä¹(81å•)':'All 9Ã—9';
                $('timer100').textContent=(appLang==='ja')?'10Ã—10(100å•)':'10Ã—10 (100Q)';
                // â˜…è¿½åŠ : 144å•ãƒ©ãƒ™ãƒ«
                $('timer144').textContent=(appLang==='ja')?'12Ã—12(144å•)':'12Ã—12 (144Q)';
                $('timerFree').textContent=(appLang==='ja')?'ç„¡åˆ¶é™':'Unlimited';
                $('openHistory').textContent=(appLang==='ja')?'å±¥æ­´':'History';
                const labDan=$('labDanTT');
                if(labDan){
                    labDan.textContent=(appLang==='ja')?'æ®µã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯':'Per-table trial';
                }
                
                // ä¿®æ­£: 12æ®µã¾ã§æ‹¡å¼µ
                const labelsJa=['1æ®µ','2æ®µ','3æ®µ','4æ®µ','5æ®µ','6æ®µ','7æ®µ','8æ®µ','9æ®µ','10æ®µ','11æ®µ','12æ®µ'];
                const labelsEn=['1Ã—','2Ã—','3Ã—','4Ã—','5Ã—','6Ã—','7Ã—','8Ã—','9Ã—','10Ã—','11Ã—','12Ã—'];
                
                for(let i=1;i<=12;i++){
                    const b=$('timerDan'+i);
                    if(b) b.textContent=(appLang==='ja')?labelsJa[i-1]:labelsEn[i-1];
                }
                
                txt($('secPerf'), appLang==='ja'?'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹':'Performance');
                const liteBtn=$('togLite');
                if(liteBtn) liteBtn.textContent=(appLang==='ja'?'è»½é‡ãƒ¢ãƒ¼ãƒ‰':'Lite mode');
                txt($('faceTitle'), appLang==='ja'?'å¿œæ´ã®é¡”ã‚’æ’®å½±':'Capture cheer face');
                const hint=$('faceHint');
                if(hint){
                    hint.innerHTML=(appLang==='ja')?'ä¸¸æ ã«é¡”ã‚’å…¥ã‚Œã¦ã­ã€‚<br><strong>â€»ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã®ã¿ã§å‡¦ç†ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</strong>':'Fit your face in the circle.<br><strong>Camera feed stays on device (not uploaded).</strong>';
                }
                txt($('facePickFile'), appLang==='ja'?'æ’®å½± | ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ':'Photos | Files');
                txt($('faceTake'),     appLang==='ja'?'æ’®å½±':'Capture');
                txt($('faceSave'),     appLang==='ja'?'ä¿å­˜':'Save');
                txt($('faceCancel'),   appLang==='ja'?'ã‚­ãƒ£ãƒ³ã‚»ãƒ«':'Cancel');
                // â˜…è¿½åŠ : æ³•çš„æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³
                txt($('secPrivacy'), appLang==='ja'?'æ³•çš„æƒ…å ±':'Legal');
                txt($('privacyBtn'), appLang==='ja'?'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼':'Privacy Policy');
                txt($('termsBtn'), appLang==='ja'?'åˆ©ç”¨è¦ç´„':'Terms of Use');
                
                // â˜…è¿½åŠ : ã‚«ãƒ¡ãƒ©èª¬æ˜é–¢é€£ã®UIæ›´æ–°
                if($('cameraExplainModal') && $('cameraExplainModal').classList.contains('show')){
                    setupCameraExplainContent();
                }
                if($('cameraDeniedModal') && $('cameraDeniedModal').classList.contains('show')){
                    setupCameraDeniedContent();
                }
                
                
            })();
        } // â˜…ã“ã®è¡Œã‚’è¿½åŠ : updateLangUIé–¢æ•°ã®é–‰ã˜æ‹¬å¼§
        
        /* å‡ºé¡Œé †ãƒˆã‚°ãƒ« */
        let orderMode=localStorage.getItem('kukuOrder')||'random';
        let seqA=1, seqB=1;
        function applyOrderToggleUI(){
            const isSeq=(orderMode==='sequential');
            $('orderSeqBtn').setAttribute('aria-pressed',String(isSeq));
            $('orderRndBtn').setAttribute('aria-pressed',String(!isSeq));
        }
        applyOrderToggleUI();
        
        (function(){
            const el=$('orderToggle');
            el.addEventListener('click',(e)=>{
                const btn=e.target.closest('.ot-btn');
                if(!btn) return;

                const nextMode=(btn.id==='orderSeqBtn') ? 'sequential' : 'random';
                const doSwitch = () => { setOrderMode(nextMode); };

                if(run){
                    const msg = (appLang==='ja')
                      ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ä¸­ã§ã™ã€‚çµ‚äº†ã—ã¦åˆ‡ã‚Šæ›¿ãˆã¾ã™ã‹ï¼Ÿ\nï¼ˆä»Šå›ã®è¨˜éŒ²ã¯æ®‹ã‚Šã¾ã›ã‚“ï¼‰'
                      : 'A time trial is running. End and switch?\n(This run will not be recorded)';
                    if (confirm(msg)) {
                        endRunNow();
                        doSwitch();
                    }
                } else {
                    doSwitch();
                }
            }, {passive:true});
        })();
        
        function endRunNow(){
            if(!run) return;
            document.body.classList.remove('ta-on');
            $('taStopFab').style.display='none';
            run=null; $('answer').value=''; $('orderToggle').classList.remove('disabled');
        }
        function setOrderMode(mode){ orderMode=mode; localStorage.setItem('kukuOrder',mode); seqA=1; seqB=1; applyOrderToggleUI(); newProblem(true); }
        
        /* ã‚µã‚¦ãƒ³ãƒ‰/TTS */
        const AudioCtx=window.AudioContext||window.webkitAudioContext; const audio=AudioCtx?new AudioCtx():null;
        function ensureAudio(){ if(audio&&audio.state==='suspended') audio.resume(); }
        function tone(f,d,type,g=.95){ if(!audio||!getFlag('sfx')) return; const o=audio.createOscillator(), g1=audio.createGain();
            o.type=type; o.frequency.value=f; o.connect(g1).connect(audio.destination); const now=audio.currentTime;
            g1.gain.setValueAtTime(0,now); g1.gain.linearRampToValueAtTime(g,now+.02); g1.gain.exponentialRampToValueAtTime(.0001,now+d); o.start(); o.stop(now+d+.02); }
        function pop(){ ensureAudio(); const p=localStorage.getItem('kukuSoundPack')||'synth'; if(p==='cute') tone(880,.09,'triangle'); else if(p==='edm') tone(520,.06,'sawtooth'); else tone(900,.08,'sine'); }
        function buzz(){ ensureAudio(); tone(120,.32,'sawtooth',.7); setTimeout(()=>tone(110,.22,'square',.6),80); }
        function pinpon(){
            ensureAudio();
            tone(1568,.12,'sine');
            setTimeout(()=>tone(2093,.16,'sine'),120);
        }
        
        let preferredVoice=null;
        function initVoices(){
            const vs=window.speechSynthesis?.getVoices?.()||[];
            preferredVoice=vs.find(v=>/ja/i.test(v.lang)&&/Kyoko|Nozomi|Nanami|Mizuki/i.test(v.name))||vs.find(v=>/ja/i.test(v.lang))||null;
        }

        if(window.speechSynthesis){
            window.speechSynthesis.onvoiceschanged = initVoices;
            if(speechSynthesis.getVoices().length > 0){
                initVoices();
            }
        }
        
        function speakText(txt){
            if(!userInteracted) return;
            if(!window.speechSynthesis) return;
            
            try {
                if(!preferredVoice && speechSynthesis.getVoices().length > 0){
                    initVoices();
                }
                
                const u=new SpeechSynthesisUtterance(txt);
                u.lang=(appLang==='ja'?'ja-JP':'en-US');
                
                if(preferredVoice&&/ja/i.test(u.lang)) {
                    u.voice=preferredVoice;
                }
                
                try{
                    window.speechSynthesis.cancel();
                }catch(e){}
                
                u.onerror = function(event) {};
                
                window.speechSynthesis.speak(u);
            } catch(error) {}
        }
        
        (function(){
            const wrap=$('soundPack'); const cur=localStorage.getItem('kukuSoundPack')||'synth';
            function setPack(p){ localStorage.setItem('kukuSoundPack',p); [...wrap.querySelectorAll('.opt')].forEach(o=>o.classList.toggle('active',o.dataset.pack===p)); pop(); }
            setPack(cur); wrap.addEventListener('click',e=>{const t=e.target.closest('.opt'); if(!t) return; setPack(t.dataset.pack);});
        })();
        
        function getFlag(k){ return localStorage.getItem('kukuFlag_'+k)!=='0'; }
        function setFlag(k,v){ localStorage.setItem('kukuFlag_'+k, v?'1':'0'); }
        function applyToggleUI(){ ['speak','sfx','cheer'].forEach(k=>{ const btn=document.querySelector(`.toggle[data-flag="${k}"]`); btn.classList.toggle('active', getFlag(k)); }); }
        applyToggleUI();
        $('toggles').addEventListener('click', e=>{ const t=e.target.closest('.toggle'); if(!t) return; const key=t.dataset.flag; setFlag(key, !getFlag(key)); applyToggleUI(); pop(); });
        
        /* å‡ºé¡Œ */
        const problem=$('problem'), ans=$('answer'), result=$('result');
        const scoreEl=$('score'), streakEl=$('streak'), avgTimeEl=$('avgTime');
        const modeSet=$('modeSet');
        let state={a:null,b:null,correct:null,start:null,score:0,streak:0,times:[],mode:'product'};
        
        const keypad=document.querySelector('.keypad');
        if(keypad){
            keypad.addEventListener('touchstart',(e)=>{
                const btn=e.target.closest('.key');
                if(!btn) return;
                e.preventDefault();
                
                const label=btn.textContent.trim();
                pop();
                
                if(label==='âŒ«'){
                    ans.value=ans.value.slice(0,-1);
                }
                else if(label==='OK'){
                    check();
                }
                else if(/^\d$/.test(label)){
                    ans.value+=label;
                }
            }, {passive: false});
            
            keypad.addEventListener('click',(e)=>{
                const btn=e.target.closest('.key');
                if(!btn) return;
                
                const label=btn.textContent.trim();
                pop();
                
                if(label==='âŒ«'){
                    ans.value=ans.value.slice(0,-1);
                }
                else if(label==='OK'){
                    check();
                }
                else if(/^\d$/.test(label)){
                    ans.value+=label;
                }
            }, {passive: true});
        }

        function resetState(){ state.score=0; state.streak=0; state.times=[]; scoreEl.textContent='0'; streakEl.textContent='0'; avgTimeEl.textContent='â€”'; }
        
        function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
        function combosFromSets(A,B){ const list=[], a=[...A].sort((x,y)=>x-y), b=[...B].sort((x,y)=>x-y); for(const x of a){ for(const y of b){ list.push([x,y]); } } return list; }
        function buildProblemQueue(n){
            let pool;
            if(n===81){ pool=[]; for(let a=1;a<=9;a++){ for(let b=1;b<=9;b++){ pool.push([a,b]); } } }
            else if(n===100){ pool=[]; for(let a=1;a<=10;a++){ for(let b=1;b<=10;b++){ pool.push([a,b]); } } }
            else if(n===144){ pool=[]; for(let a=1;a<=12;a++){ for(let b=1;b<=12;b++){ pool.push([a,b]); } } }
            else{ pool=combosFromSets(allowedA,allowedB); }
            const isSeq=(orderMode==='sequential');
            if(!isSeq) shuffle(pool);
            if(n===Infinity) return pool.slice(); if(!pool.length) return [[1,1]];
            const q=[]; while(q.length<n){ if(q.length+pool.length<=n){ q.push(...pool); if(!isSeq) shuffle(pool); } else { q.push(...pool.slice(0,n-q.length)); } }
            return q;
        }
        
        modeSet.addEventListener('click', e=>{
            const t=e.target.closest('.pill'); if(!t) return;
            [...modeSet.querySelectorAll('.pill')].forEach(p=>p.classList.remove('active'));
            t.classList.add('active'); state.mode=t.dataset.mode; pop(); newProblem(true);
        });
        
        function randFrom(set){ const a=[...set]; return a.length?a[(Math.random()*a.length)|0]:1; }
        function nextSequentialFromSets(){
            let tries=0;
            while(tries<300){
                const p={a:seqA,b:seqB};
                
                seqB++;
                if(seqB>12){
                    seqB=1;
                    seqA++;
                    if(seqA>12) seqA=1;
                }
                
                if(allowedA.has(p.a)&&allowedB.has(p.b)) return p;
                tries++;
            }
            return {a:1,b:1};
        }
        
        function showMsg(t,ok){ result.textContent=t; result.className='result '+(ok?'ok':'ng'); }
        function answerText(){ return (state.mode==='product')?state.correct:(state.mode==='missingB')?state.a:state.b; }
        function updateStats(){
            scoreEl.textContent=state.score; streakEl.textContent=state.streak;
            const n=state.times.length;
            avgTimeEl.textContent = n ? (state.times.reduce((a,b)=>a+b,0)/n).toFixed(1)+(appLang==='ja'?'ç§’':'s') : 'â€”';
        }
        
        let problemReady=false;
        
        function newProblem(force){
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ä¸­ã§ã‚­ãƒ¥ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ã€forceã«é–¢ã‚ã‚‰ãšã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—
            if(run && run.queue && run.idx < run.queue.length){
                const [a,b] = run.queue[run.idx++];
                state.a = a; state.b = b;
            } else {
                // ã‚­ãƒ¥ãƒ¼ãŒãªã„å ´åˆã®ã¿é€šå¸¸ã®ãƒ­ã‚¸ãƒƒã‚¯
                if(orderMode === 'sequential'){
                    const p = nextSequentialFromSets();
                    state.a = p.a; state.b = p.b;
                } else {
                    state.a = randFrom(allowedA);
                    state.b = randFrom(allowedB);
                }
            }
            
            if(state.mode === 'product'){
                state.correct = state.a * state.b;
                problem.textContent = `${state.a} Ã— ${state.b} = ?`;
            } else if(state.mode === 'missingB'){
                state.correct = state.a * state.b;
                problem.textContent = `â–¡ Ã— ${state.b} = ${state.correct}`;
            } else if(state.mode === 'missingA'){
                state.correct = state.a * state.b;
                problem.textContent = `${state.a} Ã— â–¡ = ${state.correct}`;
            }
            
            ans.value = '';
            result.textContent = '';
            state.start = performance.now();
            problemReady = true;
             
            requestAnimationFrame(() => {
                if(ans) ans.focus({ preventScroll: true });
            });
             
            if(getFlag('speak') && userInteracted){
                const txt = i18n[appLang].speakProb(state.a, state.b);
                speakText(txt);
            }
            
            if(run && Number.isFinite(run.target)){
                const remain = run.target - (state.score - run.scoreStart);
                const msg = run.hasMiss
                    ? i18n[appLang].remainNg(remain)
                    : i18n[appLang].remainOk(remain);
            }
        }

        function check(){
            if(!problemReady || state.correct==null){
                newProblem(true);
                result.textContent=(appLang==='ja'?'æœ€åˆã®å•é¡Œã‚’ç”¨æ„ã—ã¾ã—ãŸï¼':'Prepared the first problem!');
                result.className='result'; return;
            }
            const val=parseInt(ans.value,10);
            if(isNaN(val)){ showMsg(appLang==='ja'?'æ•°å­—ã‚’å…¥ã‚Œã¦ã­':'Enter a number',false); return; }
            const ok=(val===answerText()); const sec=(performance.now()-state.start)/1000;
            if(ok){
                state.score++; state.streak++;
                showMsg((appLang==='ja'?'æ­£è§£ï¼ ':'OK! ')+sec.toFixed(1)+(appLang==='ja'?'ç§’':'s'), true);
                pinpon();
                pop();
                if(getFlag('cheer')) try{ showMascot('cheer'); }catch(_){}
            }else{
                state.streak=0; showMsg((appLang==='ja'?'ã–ã‚“ã­ã‚“â€¦ æ­£è§£ã¯ ':'Answer: ')+answerText(), false);
                buzz();
                if(getFlag('cheer')) try{ showMascot('cry'); }catch(_){}
                if(run) run.hasMiss=true;
            }
            state.times.push(sec); if(state.times.length>40) state.times.shift(); updateStats();
            
            if(run && Number.isFinite(run.target)){
                const solved=state.score-run.scoreStart; if(solved>=run.target){ finishRun(); return; }
            }
            if(run && !run.isUnlimited){
                run.left--; if(run.left<=0){ finishRun(); return; }
            }
            
            setTimeout(()=>{
                newProblem(true);
                requestAnimationFrame(() => {
                    try {
                        scrollToInput();
                    } catch(e) {}
                });
            }, 400);
        }
        
        const bestEls={20:$('best20'),30:$('best30'),60:$('best60'),81:$('best81'),100:$('best100'),144:$('best144')};
        function rHist(n){ try{ return JSON.parse(localStorage.getItem('historyRun'+n)||'[]'); }catch(e){ return []; } }
        function wHist(n,arr){ localStorage.setItem('historyRun'+n, JSON.stringify(arr)); }
        function addHistory(n,entry){ const arr=rHist(n); arr.unshift(entry); if(arr.length>50) arr.pop(); wHist(n,arr); }
        function bestOf(n){ const arr=rHist(n).filter(x=>x.valid); if(!arr.length) return null; return arr.reduce((p,c)=>p.sec<=c.sec?p:c); }
        function fmt(iso){ const d=new Date(iso); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; }
        function renderBests(){}
        
        function section(n){
            const list=rHist(n).slice(0,10); if(list.length===0) return '';
            const best=(function(){ const a=rHist(n).filter(x=>x.valid); if(!a.length) return null; return a.reduce((p,c)=>p.sec<=c.sec?p:c); })();
            const rows=list.map(h=>{
                const okRatio=(h.correct!=null&&h.total!=null)?`${h.correct}/${h.total}`:'';
                const isBest=!!best&&h.valid&&h.sec===best.sec&&h.score===best.score&&h.date===best.date;
                let modeText=(h.mode==='missingB')?'â–¡Ã—B':(h.mode==='missingA')?'AÃ—â–¡':(appLang==='ja'?'æ¨™æº–':'Std');
                if(h.dan){ modeText += (appLang==='ja')?` / ${h.dan}æ®µ`:` / ${h.dan}Ã—`; }
                return `<tr class="${isBest?'best-row':''} ${(!h.valid?'miss-row':'')}">
        <td style="font-size:11px">${fmt(h.date)}</td><td>${h.sec?.toFixed(1)||''}</td>
        <td>${h.score??''}</td><td style="font-size:13px">${okRatio}</td>
        <td style="font-size:11px">${modeText}</td><td>${isBest?'<span class="best-badge">â­ï¸</span>':''}</td></tr>`;
            }).join('');
            
            let title=(n===81)?(appLang==='ja'?'ä¹ä¹ï¼ˆ81å•ï¼‰':'All 9Ã—9 (81Q)')
            :(n===100)?(appLang==='ja'?'10Ã—10ï¼ˆ100å•ï¼‰':'10Ã—10 (100Q)')
            :(n===144)?(appLang==='ja'?'12Ã—12ï¼ˆ144å•ï¼‰':'12Ã—12 (144Q)')
            :(appLang==='ja'?`${n}å•`:`${n}Q`);
            
            return `<div class="table-wrap"><h4 class="small" style="margin:10px 0 6px">${title}</h4>
      <table class="history-table"><thead><tr>
      <th>${appLang==='ja'?'æ—¥æ™‚':'Date'}</th><th>${appLang==='ja'?'ç§’':'Sec'}</th><th>${appLang==='ja'?'ç‚¹':'Pts'}</th>
      <th>${appLang==='ja'?'æ­£è§£':'Solved'}</th><th>${appLang==='ja'?'å½¢å¼':'Mode'}</th><th></th></tr></thead>
      <tbody>${rows}</tbody></table></div>`;
        }
        
        function sectionDan(dan){
            const key=`dan${dan}`;
            const list=rHist(key).slice(0,10);
            if(list.length===0) return '';
            
            const best=(function(){
                const a=rHist(key).filter(x=>x.valid);
                if(!a.length) return null;
                return a.reduce((p,c)=>p.sec<=c.sec?p:c);
            })();
            
            const rows=list.map(h=>{
                const okRatio=(h.correct!=null&&h.total!=null)?`${h.correct}/${h.total}`:'';
                const isBest=!!best&&h.valid&&h.sec===best.sec&&h.score===best.score&&h.date===best.date;
                let modeText=(h.mode==='missingB')?'â–¡Ã—B':(h.mode==='missingA')?'AÃ—â–¡':(appLang==='ja'?'æ¨™æº–':'Std');
                return `<tr class="${isBest?'best-row':''} ${(!h.valid?'miss-row':'')}">
        <td style="font-size:11px">${fmt(h.date)}</td><td>${h.sec?.toFixed(1)||''}</td>
        <td>${h.score??''}</td><td style="font-size:13px">${okRatio}</td>
        <td style="font-size:11px">${modeText}</td><td>${isBest?'<span class="best-badge">â­ï¸</span>':''}</td></tr>`;
            }).join('');
            
            const firstRecord = list[0];
            const actualTotal = firstRecord && firstRecord.total ? firstRecord.total : 10;
            const title=(appLang==='ja')?`${dan}æ®µï¼ˆ${actualTotal}å•ï¼‰`:`${dan}Ã— (${actualTotal}Q)`;
            
            return `<div class="table-wrap"><h4 class="small" style="margin:10px 0 6px">${title}</h4>
      <table class="history-table"><thead><tr>
      <th>${appLang==='ja'?'æ—¥æ™‚':'Date'}</th><th>${appLang==='ja'?'ç§’':'Sec'}</th><th>${appLang==='ja'?'ç‚¹':'Pts'}</th>
      <th>${appLang==='ja'?'æ­£è§£':'Solved'}</th><th>${appLang==='ja'?'å½¢å¼':'Mode'}</th><th></th>
      </tr></thead><tbody>${rows}</tbody></table></div>`;
        }
        
        function renderHistory(){
            $('histTitle').textContent=(appLang==='ja'?'å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰':'History (last 10)');
            let html='';
            
            for(let d=1; d<=12; d++) html+=sectionDan(d);
            html+=section(20)+section(30)+section(60)+section(81)+section(100)+section(144);
            
            if(!html.trim()){
                html=`<div class="small" style="text-align:center; padding:20px; opacity:0.6;">${appLang==='ja'?'ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“':'No history yet'}</div>`;
            }
            $('historyContent').innerHTML=html;
            $('clearHistory').textContent=(appLang==='ja'?'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢':'Clear history');
            $('historyClose').textContent=(appLang==='ja'?'é–‰ã˜ã‚‹':'Close');
        }
        
        function refreshClearHistoryState(){
            const btn=$('clearHistory'); if(!btn) return;
            const hasData=hasAnyHistory(); btn.disabled=!hasData; btn.style.opacity=hasData?'1':'.5'; btn.style.pointerEvents=hasData?'auto':'none';
        }
        function hasAnyHistory(){
            const hasNormal=[20,30,60,81,100,144].some(n => (localStorage.getItem('historyRun'+n)||'[]')!=='[]');
            if(hasNormal) return true;
            
            for(let d=1; d<=12; d++){
                if((localStorage.getItem('historyRundan'+d)||'[]')!=='[]') return true;
            }
            return false;
        }
        
        /* ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ */
        let run = null;
        function clearTimerStatus(){}

        function beginRun(n, dan){
            $('orderToggle').classList.add('disabled');
            run = {
                target: n,
                isUnlimited: (n === Infinity),
                hasMiss: false,
                startAt: performance.now(),
                scoreStart: state.score,
                left: n,
                problemMode: state.mode,
                dan: dan || null
            };
            
            if(dan){
                const bValues = [...allowedB];
                const actualCount = bValues.length > 0 ? bValues.length : 10;
                run.target = actualCount;
                run.left = actualCount;
                run.queue = [];
                for(const b of bValues){
                    run.queue.push([dan, b]);
                }
                if(orderMode === 'random') shuffle(run.queue);
                run.idx = 0;
            } else if(Number.isFinite(n)){
                run.queue = buildProblemQueue(n);
                run.idx = 0;
            }
            
            document.body.classList.add('ta-on');
            $('taStopFab').style.display = 'flex';
            
            newProblem(true);
            
            setTimeout(() => {
                try {
                    scrollToInput();
                } catch(e) {}
            }, 300);
        }

function finishRun(){
    if(!run) return;

    $('orderToggle').classList.remove('disabled');
    const lang=localStorage.getItem('kukuLang')||appLang||'ja';
    const T=i18n[lang];
    const elapsed=(performance.now()-run.startAt)/1000;
    const gained=state.score-run.scoreStart;
    const solved=gained;
    const total=run.isUnlimited?solved:run.target;
    const allOk=(!run.isUnlimited)&&(!run.hasMiss)&&(solved===total);

    let title,body,shareText;

    if(run.isUnlimited){
        title=T.runDone('âˆ');
        body=T.unlimitedLine(solved, elapsed.toFixed(1), gained);
        shareText=T.shareUnlimited(Math.round(gained/10), elapsed.toFixed(1), gained);
    }else{
        const rec={ sec:elapsed, score:gained, correct:solved, total:total, valid:allOk, mode:run.problemMode, dan:run.dan||null, date:new Date().toISOString() };
        const historyKey = run.dan ? `dan${run.dan}` : run.target;
        addHistory(historyKey, rec);

        title=T.runDone(run.target);
        const lineThis=`${T.thisTime}: ${rec.sec.toFixed(1)}${T.secUnit} / ${rec.score}${T.ptsUnit} / ${rec.correct}/${rec.total}ï¼ˆ${fmt(rec.date)}ï¼‰`;

        if(allOk){
            pinpon();
            confettiBurst();
            body=lineThis;
            shareText=T.shareAllOk(run.target, rec.sec.toFixed(1), rec.score);
        }else{
            body=`${lineThis}\n${T.runInvalid}`;
            shareText=T.shareGeneric(run.target, rec.sec.toFixed(1), rec.score, rec.correct, rec.total);
        }
    }

    $('rpTitle').textContent=title;
    $('rpBody').textContent=body;
    
    // ========================================
    // IndexedDBã«è¨˜éŒ²ã‚’ä¿å­˜
    // ========================================
    saveRecord({
        questionCount: total,
        timeTaken: elapsed.toFixed(1),
        score: gained,
        danNumber: run.dan || null,
        mode: run.problemMode || 'timeattack'
    }).then(() => {
        console.log('âœ… Record saved to IndexedDB');
    }).catch(err => {
        console.error('âŒ Failed to save record:', err);
    });
    // ========================================
    
    $('resultModal').classList.add('show');
    setOverlayLock(true);

    const closeResultModal = () => {
        $('resultModal').classList.remove('show');
        setOverlayLock(false);
        setTimeout(()=>{ try{ scrollToInput(); }catch(_){} }, 400);
    };
    $('rpClose').onclick = closeResultModal;
    $('resultModal').querySelector('.back').onclick = closeResultModal;
    $('rpCopy').onclick=()=>navigator.clipboard?.writeText(shareText||body).catch(()=>{});
    
    // ========================================
    // å…±æœ‰ãƒœã‚¿ãƒ³ (ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ + ãƒ†ã‚­ã‚¹ãƒˆ)
    // ========================================
    $('rpShare').onclick = async () => {
        if (!navigator.share) {
            $('rpCopy').click();
            return;
        }
        
        try {
            const response = await fetch('icon/icon-180.png');
            const blob = await response.blob();
            const file = new File([blob], 'kuku-drill-icon.png', { type: 'image/png' });
            
            await navigator.share({
                text: shareText || body,
                files: [file]
            });
            
            console.log('âœ… å…±æœ‰æˆåŠŸ');
        } catch (err) {
            if (err.name !== 'AbortError') {
                try {
                    await navigator.share({
                        text: shareText || body
                    });
                } catch (err2) {
                    if (err2.name !== 'AbortError') {
                        $('rpCopy').click();
                    }
                }
            }
        }
    };

    document.body.classList.remove('ta-on');
    $('taStopFab').style.display='none';
    run=null;
    clearTimerStatus();
    $('answer').value='';
    $('orderToggle').classList.remove('disabled');
    
      newProblem(true);
}

// ========================================
// çµ±è¨ˆç”»é¢ã®è¡¨ç¤ºãƒ»éè¡¨ç¤º
// ========================================

async function showStats() {

  try {
    const allRecords = await getAllRecords();
    
    if (allRecords.length === 0) {
      alert('ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // å…¨ä½“çµ±è¨ˆã‚’è¨ˆç®—
    const totalQuestions = allRecords.reduce((sum, r) => sum + r.questionCount, 0);
    const avgScore = (allRecords.reduce((sum, r) => sum + r.score, 0) / allRecords.length).toFixed(1);
    const avgTime = (allRecords.reduce((sum, r) => sum + parseFloat(r.timeTaken), 0) / allRecords.length).toFixed(1);
    const bestScore = Math.max(...allRecords.map(r => r.score));
    const bestTime = Math.min(...allRecords.map(r => parseFloat(r.timeTaken))).toFixed(1);
    
    // å…¨ä½“çµ±è¨ˆã‚’è¡¨ç¤º
    document.getElementById('totalQuestions').innerText = totalQuestions;
    document.getElementById('avgScore').innerText = avgScore;
    document.getElementById('avgTime').innerText = avgTime;
    document.getElementById('bestScore').innerText = bestScore;
    document.getElementById('bestTime').innerText = bestTime;
    
    // æ®µåˆ¥çµ±è¨ˆã‚’è¡¨ç¤º
    const danStatsDiv = document.getElementById('danStats');
    danStatsDiv.innerHTML = '';
    
    for (let i = 1; i <= 12; i++) {
      const stats = await getStatsByDan(i);
      if (stats) {
        const danDiv = document.createElement('div');
        danDiv.style.cssText = 'margin:10px 0; padding:15px; background:#2a2a3e; border-radius:8px; border-left:4px solid #9c2cff;';
        danDiv.innerHTML = `
          <strong style="color:#9c2cff; font-size:18px;">${i}ã®æ®µ</strong><br>
          <span style="color:#aaa; font-size:14px;">æŒ‘æˆ¦å›æ•°: ${stats.totalAttempts}å›</span><br>
          <span style="font-size:14px;">å¹³å‡ã‚¹ã‚³ã‚¢: <strong>${stats.avgScore}ç‚¹</strong> | æœ€é«˜: <strong style="color:#4caf50;">${stats.bestScore}ç‚¹</strong></span><br>
          <span style="font-size:14px;">å¹³å‡ã‚¿ã‚¤ãƒ : <strong>${stats.avgTime}ç§’</strong> | æœ€é€Ÿ: <strong style="color:#2196f3;">${stats.bestTime}ç§’</strong></span>
        `;
        danStatsDiv.appendChild(danDiv);
      }
    }
    
    // çµ±è¨ˆç”»é¢ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
    document.getElementById('statsScreen').style.display = 'block';
    document.getElementById('statsOverlay').style.display = 'block';
    
    console.log('ğŸ“Š çµ±è¨ˆç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
    
  } catch (err) {
    console.error('âŒ çµ±è¨ˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
    alert('çµ±è¨ˆã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
  }
}

// çµ±è¨ˆç”»é¢ã‚’é–‰ã˜ã‚‹
function closeStats() {
  document.getElementById('statsScreen').style.display = 'none';
  document.getElementById('statsOverlay').style.display = 'none';
  console.log('ğŸ“Š çµ±è¨ˆç”»é¢ã‚’é–‰ã˜ã¾ã—ãŸ');
}
        
function confettiBurst(){
    const colors=['#ff4dc4','#3bc7ff','#ffe066','#35ffa1','#ff8af2','#a1a8ff']; 
    const n=90;
    for(let i=0;i<n;i++){
        const d=document.createElement('div');
        d.style.position='fixed'; 
        d.style.top='-10px'; 
        d.style.width='8px'; 
        d.style.height='14px'; 
        d.style.opacity='.9'; 
        d.style.zIndex='1000'; 
        d.style.borderRadius='2px';
        d.style.left=(Math.random()*100)+'vw'; 
        d.style.background=colors[(Math.random()*colors.length)|0]; 
        d.style.transform='rotate('+(Math.random()*360)+'deg)';
        const dur=900+Math.random()*1200;
        d.style.transition=`transform ${dur}ms ease-out, top ${dur}ms ease-out, opacity ${dur}ms ease`;
        document.body.appendChild(d);
        requestAnimationFrame(()=>{ 
            d.style.top='110vh'; 
            d.style.transform+=` translateY(90vh) rotate(${360+Math.random()*360}deg)`; 
        });
        setTimeout(()=>d.remove(), dur+500);
    }
}

        function openStart(n, dan){
            const m = $('startModal'), desc = $('startDesc'), count = $('countNum');
            m.classList.add('show'); setOverlayLock(true);
            
            let actualQuestions = n;
            if(dan){
                const bValues = [...allowedB];
                actualQuestions = bValues.length > 0 ? bValues.length : 10;
            }
            
            const msgJa = dan
            ? `${dan}æ®µï¼ˆ${actualQuestions}å•ï¼‰ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚`
            : (n===Infinity ? 'ç„¡åˆ¶é™ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚'
               : (n===81 ? 'ä¹ä¹(81å•)ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚'
                  : (n===100 ? '10Ã—10(100å•)ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚'
                     : (n===144 ? '12Ã—12(144å•)ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚' : (n+'å•ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚')))));
                     
            const msgEn = dan
            ? `Start ${dan}Ã— table (${actualQuestions}Q).`
            : (n===Infinity ? 'Start Unlimited.'
                : (n===81 ? 'Start All 9Ã—9.'
                   : (n===100 ? 'Start All 10Ã—10.'
                      : (n===144 ? 'Start All 12Ã—12.' : ('Start with '+n+' questions.')))));
                      
            desc.textContent = (appLang==='ja') ? msgJa : msgEn;
            count.textContent='â±';
            count.classList.remove('pop-grow');
            
            const close = ()=>{ m.classList.remove('show'); setOverlayLock(false); };
            $('startCancel').onclick = close;
            m.querySelector('.back').onclick = close;
            
            $('startGo').onclick = ()=>{
                let i=0; const seq=['3','2','1'];
                const tick=()=>{
                    count.textContent = seq[i];
                    count.classList.remove('pop-grow'); void count.offsetWidth; count.classList.add('pop-grow');
                    ensureAudio(); tone(700,.12,'sine',.9);
                    i++;
                    if(i < seq.length){ setTimeout(tick,650); }
                    else {
                        const proceed = ()=>{
                            try { close(); } catch(_){}
                            try {
                                beginRun(n, dan);
                            } catch(e){
                                console.error('beginRun error', e);
                            }
                        };
                        setTimeout(proceed, 650);
                        setTimeout(()=>{ if(!run) proceed(); }, 1600);
                    }
                };
                setTimeout(tick, 220);
            };
        }
        
        $('timer20').onclick=()=>openStart(20);
        $('timer30').onclick=()=>openStart(30);
        $('timer60').onclick=()=>openStart(60);
        $('timer81').onclick=()=>openStart(81);
        $('timer100').onclick=()=>openStart(100);
        $('timer144').onclick=()=>openStart(144);
        $('timerDan1').onclick=()=>openStart(10,1);
        $('timerDan2').onclick=()=>openStart(10,2);
        $('timerDan3').onclick=()=>openStart(10,3);
        $('timerDan4').onclick=()=>openStart(10,4);
        $('timerDan5').onclick=()=>openStart(10,5);
        $('timerDan6').onclick=()=>openStart(10,6);
        $('timerDan7').onclick=()=>openStart(10,7);
        $('timerDan8').onclick=()=>openStart(10,8);
        $('timerDan9').onclick=()=>openStart(10,9);
        $('timerDan10').onclick=()=>openStart(10,10);
        $('timerDan11').onclick=()=>openStart(10,11);
        $('timerDan12').onclick=()=>openStart(10,12);
        
        /* èƒŒæ™¯ */
        const bgPick=$('bgPick'), bgReset=$('bgReset'), bgFile=$('bgFile'), bgBright=$('bgBright'), bgSize=$('bgSize');
        function setWallBackground(uri){ document.documentElement.style.setProperty('--neon-wall', uri); const w=document.querySelector('.wall'); if(w) w.style.backgroundImage=uri; }
        function injectDefaultNeon(){
            const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 220 220'>
      <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='#ff4dc4'/><stop offset='1' stop-color='#3bc7ff'/></linearGradient></defs>
      <rect width='100%' height='100%' fill='black'/>
      <g opacity='0.18' stroke='url(#g)' stroke-width='1.5' fill='none'>
        <path d='M-40 220 L 260 -40'/><path d='M-20 240 L 280 -20'/><path d='M0 260 L 300 0'/>
      </g></svg>`;
      const encoded=encodeURIComponent(svg);
      document.documentElement.style.setProperty('--neon-wall', `url('data:image/svg+xml;utf8,${encoded}')`);
      const w=document.querySelector('.wall'); if(w) w.style.backgroundImage='';
        }
        function validUserBg(){ const d=localStorage.getItem('neonWallData'); return !!(d && d.indexOf('data:image')===0); }
        function applySavedOrDefaultWall(){
            const saved=localStorage.getItem('neonWallData');
            if(validUserBg()) setWallBackground("url('"+saved+"')"); else injectDefaultNeon();
            const savedOp=localStorage.getItem('neonWallOpacity'); if(savedOp){ document.documentElement.style.setProperty('--wallOpacity', savedOp); if(bgBright) bgBright.value=Math.round(parseFloat(savedOp)*100); } else { document.documentElement.style.setProperty('--wallOpacity','0.36'); if(bgBright) bgBright.value=36; }
            const savedSize=localStorage.getItem('neonWallSize'); if(savedSize){ document.documentElement.style.setProperty('--wallSize', savedSize+'%'); if(bgSize) bgSize.value=savedSize; } else { document.documentElement.style.setProperty('--wallSize','cover'); if(bgSize) bgSize.value=100; }
        }
        applySavedOrDefaultWall();
        
        const bgResetBtn = $('bgReset');
        if(bgResetBtn){
          bgResetBtn.onclick = async () => {
            const ja = (appLang === 'ja');
            const ok = await confirmAsync(ja ? 'èƒŒæ™¯ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' : 'Remove background image?');
            if (!ok) return;
            
            try {
              localStorage.removeItem('neonWallData');
            } catch(_){}
            
            applySavedOrDefaultWall();
            alert(ja ? 'èƒŒæ™¯ç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ' : 'Background image reset');
          };
        }

        const hardResetBtn = $('hardResetBtn');
        if(hardResetBtn){
          hardResetBtn.onclick = async () => {
            const msg = (appLang === 'ja')
              ? 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆå±¥æ­´ãƒ»è¨­å®šãƒ»åŒæ„çŠ¶æ…‹ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'
              : 'Delete all data (history, settings, consent).\nThis cannot be undone.';
            
            const ok = await confirmAsync(msg);
            if(!ok) return;
            
            try{
              const keys = [
                'kukuTheme','kukuLang','kukuOrder','kukuSoundPack','kukuLite',
                'allowedA','allowedB','neonWallData','neonWallOpacity','neonWallSize',
                'cheerFaceImg','cameraExplainDontShow','privacyAgreed'
              ];
              
              for(const k of keys){
                localStorage.removeItem(k);
              }
              
              for(let n of [20,30,60,81,100,144]){
                localStorage.removeItem('historyRun'+n);
              }
              for(let d=1; d<=12; d++){
                localStorage.removeItem('historyRundan'+d);
              }
              
              ['speak','sfx','cheer','lite'].forEach(f => localStorage.removeItem('kukuFlag_'+f));
              
              alert((appLang === 'ja')
                ? 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚'
                : 'All data deleted.\nReloading page.');
              
              location.reload();
            }catch(e){
              console.error('Reset error:', e);
              alert((appLang === 'ja') ? 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'Failed to delete data');
            }
          };
        }

        if(bgBright){
            bgBright.oninput = debounce(()=>{
                const v=Math.max(0,Math.min(100,parseInt(bgBright.value||'36',10)))/100;
                document.documentElement.style.setProperty('--wallOpacity',String(v));
                localStorage.setItem('neonWallOpacity',String(v));
            }, 200);
        }
        if(bgSize){
            bgSize.oninput = debounce(()=>{
                const v=bgSize.value;
                document.documentElement.style.setProperty('--wallSize', v+'%');
                localStorage.setItem('neonWallSize', v);
            }, 200);
        }
        if(bgPick){ bgPick.onclick=()=> bgFile.click(); }
        if(bgFile){ bgFile.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ localStorage.setItem('neonWallData', r.result); }catch(_){ alert(appLang==='ja'?'ç”»åƒãŒå¤§ãã™ãã¾ã™':'Image too large'); return; } setWallBackground("url('"+r.result+"')"); }; r.readAsDataURL(f); }; }
        
        /* ã‚«ãƒ¡ãƒ©èª¬æ˜æ©Ÿèƒ½ */
        function setupCameraExplainContent(){
            const title = $('cameraExplainTitle');
            const body = $('cameraExplainBody');
            const privacy = $('cameraExplainPrivacy');
            const dontShowLabel = $('cameraExplainDontShowLabel');
            const cancelBtn = $('cameraExplainCancel');
            const okBtn = $('cameraExplainOk');
            
            if(appLang === 'ja'){
                if(title) title.textContent = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã«ã¤ã„ã¦';
                if(body){
                    body.innerHTML = `
      <strong>ğŸ­ å¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ©Ÿèƒ½ã«ã¤ã„ã¦</strong><br><br>
      ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€æ­£è§£æ™‚ã«ã‚ãªãŸã‚„ãŠå­æ§˜ã®é¡”ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€Œå¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚<br><br>
      <strong>ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹ç›®çš„ï¼š</strong>
      <ul>
      <li>å¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®é¡”ã‚’æ’®å½±ã™ã‚‹ãŸã‚</li>
      <li>å­¦ç¿’ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã®ãŸã‚</li>
      </ul>
      <strong>âœ¨ ã“ã®æ©Ÿèƒ½ã¯ä»»æ„ã§ã™</strong><br>
      ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ãªãã¦ã‚‚ã€ã‚¢ãƒ—ãƒªã®ä¸»è¦æ©Ÿèƒ½ï¼ˆä¹ä¹ã®å­¦ç¿’ï¼‰ã¯ã™ã¹ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
      `;
                }
                if(privacy){
                    privacy.innerHTML = `
      <strong>ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã«ã¤ã„ã¦ï¼š</strong><br>
      â€¢ æ’®å½±ã—ãŸå†™çœŸã¯ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™<br>
      â€¢ å¤–éƒ¨ã®ã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“<br>
      â€¢ ã„ã¤ã§ã‚‚è¨­å®šã‹ã‚‰å‰Šé™¤ã§ãã¾ã™<br>
      â€¢ ã‚«ãƒ¡ãƒ©æ˜ åƒã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®ã¿ã§ã€è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã›ã‚“
      `;
                }
                if(dontShowLabel) dontShowLabel.textContent = 'æ¬¡å›ã‹ã‚‰è¡¨ç¤ºã—ãªã„';
                if(cancelBtn) cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                if(okBtn) okBtn.textContent = 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•';
            } else {
                if(title) title.textContent = 'About Camera Usage';
                if(body){
                    body.innerHTML = `
      <strong>ğŸ­ Cheer Character Feature</strong><br><br>
      This app offers a "Cheer Character" feature that displays your or your child's face when answering correctly.<br><br>
      <strong>Purpose of Camera Use:</strong>
      <ul>
      <li>To capture your cheer character's face</li>
      <li>To increase learning motivation</li>
      </ul>
      <strong>âœ¨ This feature is optional</strong><br>
      You can use all main features (multiplication practice) without using the camera.
      `;
                }
                if(privacy){
                    privacy.innerHTML = `
      <strong>ğŸ”’ Privacy Protection:</strong><br>
      â€¢ Captured photos are stored only on your device<br>
      â€¢ Never transmitted to external servers or the internet<br>
      â€¢ Can be deleted anytime from settings<br>
      â€¢ Camera feed is processed in real-time only, not automatically saved
      `;
                }
                if(dontShowLabel) dontShowLabel.textContent = "Don't show again";
                if(cancelBtn) cancelBtn.textContent = 'Cancel';
                if(okBtn) okBtn.textContent = 'Open Camera';
            }
        }
        
        function setupCameraDeniedContent(){
            const title = $('cameraDeniedTitle');
            const body = $('cameraDeniedBody');
            const useFileBtn = $('cameraDeniedUseFile');
            const settingsBtn = $('cameraDeniedSettings');
            const closeBtn = $('cameraDeniedClose');
            
            if(appLang === 'ja'){
                if(title) title.textContent = 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                if(body){
                    body.innerHTML = `
    <strong>ğŸ“± ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</strong><br><br>
    ã€Œå¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™ã€‚<br><br>
    <strong>å¯¾å‡¦æ–¹æ³•ï¼š</strong>
    <ol>
    <li><strong>ã€Œè¨­å®šã‚’é–‹ãã€</strong>ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li>
    <li>ãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šç”»é¢ã§ã€ŒKuKuãƒ‰ãƒªãƒ«ã€ã‚’æ¢ã™</li>
    <li>ã€Œã‚«ãƒ¡ãƒ©ã€ã®é …ç›®ã‚’ã‚ªãƒ³ã«ã™ã‚‹</li>
    <li>ã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„</li>
    </ol>
    <strong>ã¾ãŸã¯</strong><br>
    æ—¢ã«æ’®å½±æ¸ˆã¿ã®å†™çœŸã‚’ã”ä½¿ç”¨ã®å ´åˆã¯ã€<strong>ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠã€</strong>ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
    `;
                }
                if(useFileBtn) useFileBtn.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ';
                if(settingsBtn) settingsBtn.textContent = 'è¨­å®šã‚’é–‹ã';
                if(closeBtn) closeBtn.textContent = 'é–‰ã˜ã‚‹';
            } else {
                if(title) title.textContent = 'Camera Access Denied';
                if(body){
                    body.innerHTML = `
    <strong>ğŸ“± Camera Access Required</strong><br><br>
    Camera access is needed to use the "Cheer Character" feature.<br><br>
    <strong>How to Fix:</strong>
    <ol>
    <li>Tap <strong>"Open Settings"</strong> button</li>
    <li>Find "KuKu Drill" in device settings</li>
    <li>Turn on "Camera" permission</li>
    <li>Return to the app and try again</li>
    </ol>
    <strong>Or</strong><br>
    If you have an existing photo, try <strong>"Choose from Files"</strong>.
    `;
                }
                if(useFileBtn) useFileBtn.textContent = 'Choose from Files';
                if(settingsBtn) settingsBtn.textContent = 'Open Settings';
                if(closeBtn) closeBtn.textContent = 'Close';
            }
        }
        
        function showCameraExplainModal(callback){
            if(localStorage.getItem('cameraExplainDontShow') === '1'){
                if(callback) callback();
                return;
            }
            
            setupCameraExplainContent();
            const modal = $('cameraExplainModal');
            if(!modal) return;
            
            modal.classList.add('show');
            setOverlayLock(true);
            
            const okBtn = $('cameraExplainOk');
            if(okBtn){
                okBtn.onclick = ()=>{
                    const dontShow = $('cameraExplainDontShow');
                    if(dontShow && dontShow.checked){
                        localStorage.setItem('cameraExplainDontShow', '1');
                    }
                    
                    modal.classList.remove('show');
                    setOverlayLock(false);
                    if(callback) callback();
                };
            }
            
            const cancelBtn = $('cameraExplainCancel');
            if(cancelBtn){
                cancelBtn.onclick = ()=>{
                    modal.classList.remove('show');
                    setOverlayLock(false);
                };
            }
            
            const back = modal.querySelector('.back');
            if(back){
                back.onclick = ()=>{
                    modal.classList.remove('show');
                    setOverlayLock(false);
                };
            }
        }
        
        function showCameraDeniedModal(){
            setupCameraDeniedContent();
            const modal = $('cameraDeniedModal');
            if(!modal) return;
            
            modal.classList.add('show');
            setOverlayLock(true);
            
            const useFileBtn = $('cameraDeniedUseFile');
            if(useFileBtn){
                useFileBtn.onclick = ()=>{
                    modal.classList.remove('show');
                    setOverlayLock(false);
                    const fileInput = $('faceFileInput');
                    if(fileInput) fileInput.click();
                };
            }
            
            const settingsBtn = $('cameraDeniedSettings');
            if(settingsBtn){
                settingsBtn.onclick = ()=>{
                    if(window.webkit?.messageHandlers?.openSettings){
                        window.webkit.messageHandlers.openSettings.postMessage({});
                    } else {
                        alert(appLang==='ja'
                              ? 'ãƒ‡ãƒã‚¤ã‚¹ã®ã€Œè¨­å®šã€ã‚¢ãƒ—ãƒªã‚’é–‹ãã€ã“ã®ã‚¢ãƒ—ãƒªã®ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'
                              : 'Please open your device Settings app and enable camera access for this app.');
                    }
                    modal.classList.remove('show');
                    setOverlayLock(false);
                };
            }
            
            const closeBtn = $('cameraDeniedClose');
            if(closeBtn){
                closeBtn.onclick = ()=>{
                    modal.classList.remove('show');
                    setOverlayLock(false);
                };
            }
            
            const back = modal.querySelector('.back');
            if(back){
                back.onclick = ()=>{
                    modal.classList.remove('show');
                    setOverlayLock(false);
                };
            }
        }
        
        /* ã‚«ãƒ¡ãƒ©é–¢é€£å¤‰æ•° */
        let stream=null, faceImg=null, faceScale=1, faceOffsetX=0, faceOffsetY=0, isDragging=false, dragStartX=0, dragStartY=0, pointers=new Map(), pinchBaseDist=0;
        let camWarned = false;
        let cameraExplainShown = false;
        
        function getShotCanvas(){ return $('shot'); }
        function showLivePreview(isLive){
            const v=$('cam'), c=$('shot'), take=$('faceTake'), save=$('faceSave');
            if(isLive){ if(v) v.style.display='block'; if(c) c.style.display='none'; if(save) save.disabled=true; if(take){ take.style.display=stream?'inline-block':'none'; take.textContent=stream?(appLang==='ja'?'æ’®å½±':'Capture'):(appLang==='ja'?'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•':'Open Camera'); } }
            else{ if(v) v.style.display='none'; if(c) c.style.display='block'; if(save) save.disabled=false; if(take){ take.style.display='inline-block'; take.textContent=(appLang==='ja'?'å†æ’®å½±':'Retake'); } }
        }
        
        function fallbackToPicker(){
            const faceModal = $('faceModal');
            if(faceModal && faceModal.classList.contains('show')){
                faceModal.classList.remove('show');
                setOverlayLock(false);
            }
            
            if(!camWarned){
                try{
                    alert(appLang==='ja'
                          ?'ã“ã®ç’°å¢ƒã§ã¯ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„ãŸã‚ã€å†™çœŸã‚’é¸æŠã—ã¾ã™ã€‚'
                          :'Camera unavailable. Opening photo picker.');
                }catch(_){}
                camWarned = true;
            }
            
            showLivePreview(false);
            const take=$('faceTake');
            if(take) take.style.display='none';
            
            setTimeout(()=>{
                const file=$('faceFileInput');
                if(file) file.click();
            }, 100);
        }
        
        function startCamera(){
            if(navigator.mediaDevices?.getUserMedia){
                navigator.mediaDevices.getUserMedia({
                    video: {facingMode:'user', width:{ideal:640}, height:{ideal:640}},
                    audio: false
                })
                .then(s => {
                    stream = s;
                    const v = $('cam');
                    if(v){
                        v.srcObject = s;
                        v.classList.add('mirror');
                    }
                    showLivePreview(true);
                })
                .catch(err => {
                    console.error('Camera error:', err);
                    
                    const faceModal = $('faceModal');
                    if(faceModal && faceModal.classList.contains('show')){
                        faceModal.classList.remove('show');
                        setOverlayLock(false);
                    }
                    
                    setTimeout(() => {
                        if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError'){
                            showCameraDeniedModal();
                        } else if(err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError'){
                            alert(appLang==='ja'
                                  ? 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚'
                                  : 'Camera not found. Please choose from files.');
                                  fallbackToPicker();
                        } else {
                            alert(appLang==='ja'
                                  ? 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚'
                                  : 'Failed to start camera. Please choose from files.');
                                  fallbackToPicker();
                        }
                    }, 200);
                });
            } else {
                const faceModal = $('faceModal');
                if(faceModal && faceModal.classList.contains('show')){
                    faceModal.classList.remove('show');
                    setOverlayLock(false);
                }
                setTimeout(() => {
                    fallbackToPicker();
                }, 200);
            }
        }
        
        function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } const v=$('cam'); if(v){ v.srcObject=null; v.classList.remove('mirror'); } }
        function closeFace(){ const modal=$('faceModal'); if(modal){ modal.classList.remove('show'); setOverlayLock(false); } stopCamera(); showLivePreview(true); faceImg=null; faceScale=1; faceOffsetX=0; faceOffsetY=0; pointers.clear(); isDragging=false; pinchBaseDist=0; }
        function beginFaceEdit(img){ faceImg=img; faceScale=1; faceOffsetX=0; faceOffsetY=0; drawFacePreview(); showLivePreview(false); attachFaceEditorEvents(); }
        function drawFacePreview(){
            if(!faceImg) return; const c=getShotCanvas(); if(!c) return; const ctx=c.getContext('2d'); const s=c.width;
            ctx.clearRect(0,0,s,s); ctx.save(); const cx=s/2, cy=s/2; const radius=(s/2)-3; ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.closePath(); ctx.clip();
            const imgRatio=faceImg.width/faceImg.height; const base=radius*2; const drawW=(imgRatio>=1)?base*imgRatio:base; const drawH=(imgRatio>=1)?base:base/imgRatio;
            const w=drawW*faceScale, h=drawH*faceScale; const ox=cx-w/2+faceOffsetX, oy=cy-h/2+faceOffsetY;
            ctx.drawImage(faceImg, ox, oy, w, h); ctx.restore();
        }
        function attachFaceEditorEvents(){
            const c=getShotCanvas(); if(!c) return;
            c.onpointerdown=c.onpointermove=c.onpointerup=c.onpointercancel=c.onwheel=null; c.style.touchAction='none';
            c.onpointerdown=e=>{ c.setPointerCapture(e.pointerId); pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
                if(pointers.size===1){ isDragging=true; dragStartX=e.clientX; dragStartY=e.clientY; }
                else if(pointers.size===2){ const pts=[...pointers.values()]; pinchBaseDist=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y); } };
            c.onpointermove=e=>{ if(!pointers.has(e.pointerId)) return; pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
                if(pointers.size===1&&isDragging){ faceOffsetX+=e.clientX-dragStartX; faceOffsetY+=e.clientY-dragStartY; dragStartX=e.clientX; dragStartY=e.clientY; drawFacePreview(); }
                else if(pointers.size===2){ const pts=[...pointers.values()]; const dist=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
                    if(pinchBaseDist>0){ const factor=dist/pinchBaseDist; faceScale=clamp(faceScale*factor,.5,3); drawFacePreview(); } pinchBaseDist=dist; } };
            c.onpointerup=c.onpointercancel=e=>{ try{ c.releasePointerCapture(e.pointerId); }catch(_){}
                pointers.delete(e.pointerId); if(pointers.size===0){ isDragging=false; pinchBaseDist=0; } };
            c.onwheel=e=>{ e.preventDefault(); const factor=(e.deltaY<0)?1.08:0.92; faceScale=clamp(faceScale*factor,.5,3); drawFacePreview(); };
        }
        function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
        function refreshFaceButtons(){ const t=$('faceTake'); if(!t) return; t.textContent=stream?(appLang==='ja'?'æ’®å½±':'Capture'):(appLang==='ja'?'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•':'Open Camera'); }
        
        function showMascot(kind){
            if(!getFlag('cheer')) return;
            const shotData=localStorage.getItem('kukuFaceData');
            if(!shotData) return;
            
            const box=document.createElement('div');
            box.className='mascot';
            
            if(kind==='cry'){
                const t1=document.createElement('div'); t1.className='tear left';
                const t2=document.createElement('div'); t2.className='tear right';
                box.appendChild(t1); box.appendChild(t2);
            } else {
                const balloon=document.createElement('div');
                balloon.className='mascot-bubble';
                balloon.textContent=(appLang==='ja'?'ã™ã”ã„ï¼ğŸ‘':'Great!ğŸ‘');
                box.appendChild(balloon);
            }
            
            const img=new Image();
            img.src=shotData;
            box.appendChild(img);
            document.body.appendChild(box);
            setTimeout(()=>box.remove(),2600);
        }
        
        document.addEventListener('click', async (e)=>{
            const btn = e.target.closest('#hardResetBtn');
            if (!btn) return;
            e.preventDefault(); e.stopPropagation();
            const ja = (localStorage.getItem('kukuLang') || 'ja') === 'ja';
            const ok = await confirmAsync(
                                          ja
                                          ? 'ã€ç¢ºèªã€‘ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ã‚³ã‚¢/å±¥æ­´/è¨­å®š/èƒŒæ™¯/é¡” ç­‰ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
                                          : 'CONFIRM: Delete ALL data (scores/history/settings/bg/face etc.). This cannot be undone. Proceed?'
                                          );
                                          if (!ok) return;
                                          await handleHardReset();
        });
        
        async function handleHardReset(){
            try{
                endRunNow();
                const keys=['allowedA','allowedB','kukuTheme','kukuLang','kukuSoundPack','kukuOrder','kukuLite','neonWallData','neonWallOpacity','neonWallSize','kukuFaceData','privacyAgreed'];
                keys.forEach(k=>{ try{ localStorage.removeItem(k); }catch(_){ } });
                ['speak','sfx','cheer'].forEach(f=>{ try{ localStorage.removeItem('kukuFlag_'+f); }catch(_){ } });
                
                [20,30,60,81,100,144].forEach(n=>{ try{ localStorage.removeItem('historyRun'+n); }catch(_){ } });
                
                for(let d=1; d<=12; d++){
                    try{ localStorage.removeItem('historyRundan'+d); }catch(_){ }
                }
            }finally{
                allowedA=new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
                allowedB=new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
                setTheme('mix');
                setLang('ja');
                applyToggleUI();
                buildPills($('danSet'),'A'); buildPills($('kuSet'),'B');
                applySavedOrDefaultWall();
                resetState(); newProblem(true);
                renderHistory(); refreshClearHistoryState();
                alert((appLang==='ja')?'ã™ã¹ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚æ¬¡å›èµ·å‹•æ™‚ã«ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ãŒå†è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚':'All data deleted. Privacy agreement will show on next launch.');
                
                setTimeout(()=>{
                    location.reload();
                }, 1000);
            }
        }
        
        /* è¨­å®šã‚·ãƒ¼ãƒˆ */
        const sheet=$('sheet'), openSettingsBtn=$('openSettings'), closeSettingsBtn=$('closeSettings');
        if(sheet&&openSettingsBtn&&closeSettingsBtn){
            sheet.classList.remove('show'); openSettingsBtn.setAttribute('aria-expanded','false');
            openSettingsBtn.onclick=()=>{ sheet.classList.add('show'); openSettingsBtn.setAttribute('aria-expanded','true'); setOverlayLock(true); };
            closeSettingsBtn.onclick=()=>{ sheet.classList.remove('show'); openSettingsBtn.setAttribute('aria-expanded','false'); setOverlayLock(false); };
            const grab=sheet.querySelector('.grab'); if(grab){ grab.onclick=()=>{ sheet.classList.remove('show'); openSettingsBtn.setAttribute('aria-expanded','false'); setOverlayLock(false); }; }
        }
        const closeSettingsTop=$('closeSettingsTop');
        if(closeSettingsTop){ closeSettingsTop.addEventListener('click',()=>{ sheet.classList.remove('show'); openSettingsBtn.setAttribute('aria-expanded','false'); setOverlayLock(false); }); }
        
        /* é¡”ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ */
        const faceBtnEl=$('faceBtn');
        if(faceBtnEl){
            faceBtnEl.onclick = ()=>{
                sheet.classList.remove('show');
                setOverlayLock(false);
                const modal = $('faceModal');
                if(modal){
                    showCameraExplainModal(()=>{
                        modal.classList.add('show');
                        setOverlayLock(true);
                        showLivePreview(true);
                    });
                }
            };
        }
        
        const facePickFileBtn=$('facePickFile'); if(facePickFileBtn){ facePickFileBtn.onclick=()=>{ const fileInput=$('faceFileInput'); if(fileInput) fileInput.click(); }; }
        const faceFileInput = $('faceFileInput');
        if (faceFileInput) {
            try { faceFileInput.removeAttribute('capture'); } catch(_){}
            faceFileInput.onchange = e => {
                const file = e.target.files?.[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = ev => { const img = new Image();
                    img.onload = ()=>{ beginFaceEdit(img); faceFileInput.value=''; };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };
        }
        
        const faceTakeBtn=$('faceTake');
        if(faceTakeBtn){
            faceTakeBtn.onclick = e => {
                e.preventDefault();
                e.stopPropagation();
                
                if(!stream){
                    showCameraExplainModal(()=>{
                        startCamera();
                    });
                    return;
                }
                
                const v=$('cam'), c=$('shot'), s=c?c.width:320;
                if(!v||!v.srcObject){
                    const faceModal = $('faceModal');
                    if(faceModal && faceModal.classList.contains('show')){
                        faceModal.classList.remove('show');
                        setOverlayLock(false);
                    }
                    setTimeout(() => {
                        showCameraDeniedModal();
                    }, 200);
                    return;
                }
                
                const tmp=document.createElement('canvas');
                tmp.width=s; tmp.height=s;
                const tctx=tmp.getContext('2d');
                tctx.clearRect(0,0,s,s);
                tctx.save();
                tctx.translate(s,0);
                tctx.scale(-1,1);
                tctx.drawImage(v,0,0,s,s);
                tctx.restore();
                
                const img=new Image();
                img.onload=()=>{ beginFaceEdit(img); };
                img.src=tmp.toDataURL('image/png');
            };
        }
        
        const faceSaveBtn=$('faceSave'); if(faceSaveBtn){ faceSaveBtn.onclick=e=>{ e.preventDefault(); e.stopPropagation(); try{ const c=$('shot'); if(!c) return; const data=c.toDataURL('image/png'); localStorage.setItem('kukuFaceData',data); alert(appLang==='ja'?'ä¿å­˜ã—ã¾ã—ãŸï¼':'Saved!'); }catch(err){ alert(appLang==='ja'?'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ':'Save failed'); } closeFace(); }; }
        const faceCancelBtn=$('faceCancel'); if(faceCancelBtn){ faceCancelBtn.onclick=e=>{ e.preventDefault(); e.stopPropagation(); closeFace(); }; }
        const faceModal=$('faceModal'); if(faceModal){ const bk=faceModal.querySelector('.back'); if(bk){ bk.onclick=e=>{ e.preventDefault(); e.stopPropagation(); closeFace(); }; } }
        const faceDelBtn=$('faceDel'); if(faceDelBtn){ faceDelBtn.onclick=async()=>{ const ja=(appLang==='ja'); const ok=await confirmAsync(ja?'é¡”ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ':'Delete face image?'); if(!ok) return; try{ localStorage.removeItem('kukuFaceData'); }catch(_){}
            stopCamera(); showLivePreview(true); alert(ja?'é¡”ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ':'Face image deleted'); }; }
        
        /* å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« */
        $('openHistory').onclick=()=>{ renderHistory(); refreshClearHistoryState(); setOverlayLock(true); $('historyModal').classList.add('show'); };
        $('historyClose').onclick=()=>{ $('historyModal').classList.remove('show'); setOverlayLock(false); };
        $('historyModal').querySelector('.back').onclick=()=>{ $('historyModal').classList.remove('show'); setOverlayLock(false); };
        
        async function handleClearHistory(){
            const ja=(appLang==='ja');
            const ok=await confirmAsync(ja?'å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ':'Clear all history?');
            if(!ok) return;
            
            [20,30,60,81,100,144].forEach(n=>{ try{ localStorage.removeItem('historyRun'+n); }catch(_){ } });
            
            for(let d=1; d<=12; d++){
                try{ localStorage.removeItem('historyRundan'+d); }catch(_){}
            }
            
            renderHistory();
            refreshClearHistoryState();
            alert(ja?'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ':'History cleared');
        }
        
        $('clearHistory').addEventListener('click',(e)=>{ e.preventDefault(); e.stopPropagation(); handleClearHistory(); });
        
        /* åœæ­¢FAB */
        const taStopFab=$('taStopFab');
        if(taStopFab){ taStopFab.addEventListener('click', async (e)=>{ e.preventDefault(); e.stopPropagation(); if(!run) return;
            const ja=(appLang==='ja');
            const ok=await confirmAsync(ja?'ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä»Šå›ã®è¨˜éŒ²ã¯æ®‹ã‚Šã¾ã›ã‚“ï¼‰':'End the time trial?\n(This run will not be recorded)');
            if(!ok) return;
            document.body.classList.remove('ta-on'); taStopFab.style.display='none'; run=null; const ai=$('answer'); if(ai) ai.value=''; $('orderToggle').classList.remove('disabled'); clearTimerStatus(); newProblem(true);
        }); }
        
        /* ç‰©ç†ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ */
        document.addEventListener('keydown',(e)=>{
            const k=e.key;
            if(k>='0'&&k<='9'){ navigator.vibrate?.(50); pop(); ans.value+=k; return; }
            if(k==='Enter'){ navigator.vibrate?.(50); pop(); check(); return; }
            if(k==='Backspace'){ navigator.vibrate?.(50); pop(); ans.value=ans.value.slice(0,-1); return; }
            if(e.key==='Escape'){
                ['startModal','resultModal','historyModal','faceModal','privacyModal','termsModal'].forEach(id=>{ const m=$(id); if(m&&m.classList.contains('show')){ m.classList.remove('show'); setOverlayLock(false); } });
                if(sheet && sheet.classList.contains('show')){ sheet.classList.remove('show'); setOverlayLock(false); }
            }
        });
        
        try{ window.webkit?.messageHandlers?.lang?.postMessage({ lang: appLang }); }catch(_){}
        
        function boot(){
            try {
                setTimeout(()=>{
                    const beams = document.querySelector('.beams');
                    if(beams){
                        beams.style.animation = 'spin 18s linear infinite';
                    }
                }, 500);
            } catch(e) {}
        }
        
        /* ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒ»åˆ©ç”¨è¦ç´„è¨­å®š */
        function setupPrivacyContent(){
          const title = $('privacyTitle');
          const content = $('privacyContent');
          
          if(appLang === 'ja'){
            if(title) title.textContent = 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼';
            if(content){
              content.textContent = `
        ã€KuKuãƒ‰ãƒªãƒ« ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã€‘

        æœ€çµ‚æ›´æ–°æ—¥: ${new Date().toLocaleDateString('ja-JP')}

        1. åŸºæœ¬æ–¹é‡
        KuKuãƒ‰ãƒªãƒ«ï¼ˆä»¥ä¸‹ã€Œå½“ã‚¢ãƒ—ãƒªã€ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’æœ€é‡è¦è¦–ã—ã¦ã„ã¾ã™ã€‚
        å½“ã‚¢ãƒ—ãƒªã¯å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œã—ã€å€‹äººæƒ…å ±ã®åé›†ãƒ»é€ä¿¡ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚

        2. åé›†ã™ã‚‹æƒ…å ±
        å½“ã‚¢ãƒ—ãƒªã¯ä»¥ä¸‹ã®æƒ…å ±ã‚’ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã—ã¾ã™ï¼š
        â€¢ å­¦ç¿’å±¥æ­´ï¼ˆã‚¹ã‚³ã‚¢ã€ã‚¿ã‚¤ãƒ è¨˜éŒ²ï¼‰
        â€¢ ã‚¢ãƒ—ãƒªè¨­å®šï¼ˆãƒ†ãƒ¼ãƒã€è¨€èªã€ã‚µã‚¦ãƒ³ãƒ‰è¨­å®šãªã©ï¼‰
        â€¢ å¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã®é¡”ç”»åƒï¼ˆä»»æ„ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸå ´åˆã®ã¿ï¼‰

        3. ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜å ´æ‰€
        ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        å¤–éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã®é€ä¿¡ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚

        4. ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ã«ã¤ã„ã¦
        å¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ©Ÿèƒ½ã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š
        â€¢ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å®Œå…¨ã«ä»»æ„ã§ã™
        â€¢ æ’®å½±ã—ãŸç”»åƒã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™
        â€¢ ç”»åƒã®å¤–éƒ¨é€ä¿¡ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“
        â€¢ ã„ã¤ã§ã‚‚è¨­å®šã‹ã‚‰å‰Šé™¤ã§ãã¾ã™

        5. ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
        ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‹ã‚‰ã€ã„ã¤ã§ã‚‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã§ãã¾ã™ã€‚

        6. ç¬¬ä¸‰è€…ã¸ã®æƒ…å ±æä¾›
        å½“ã‚¢ãƒ—ãƒªã¯ã€ã„ã‹ãªã‚‹å€‹äººæƒ…å ±ã‚‚ç¬¬ä¸‰è€…ã«æä¾›ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

        7. ãŠå•ã„åˆã‚ã›
        ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«é–¢ã™ã‚‹ã”è³ªå•ã¯ã€ã‚¢ãƒ—ãƒªã‚¹ãƒˆã‚¢ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¬„ã«ã¦ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

        ä»¥ä¸Š
        `;
            }
          } else {
            if(title) title.textContent = 'Privacy Policy';
            if(content){
              content.textContent = `
        ã€KuKu Drill Privacy Policyã€‘

        Last Updated: ${new Date().toLocaleDateString('en-US')}

        1. Basic Policy
        KuKu Drill ("the App") places the highest priority on user privacy.
        The App operates completely offline and does not collect or transmit any personal information.

        2. Information We Store
        The App stores the following information only on your device:
        â€¢ Learning history (scores, time records)
        â€¢ App settings (theme, language, sound settings, etc.)
        â€¢ Cheer character face image (optional, only if set by user)

        3. Data Storage Location
        All data is stored only in local storage on your device.
        No data is transmitted to external servers or cloud services.

        4. Camera Feature
        When using the camera for the cheer character feature:
        â€¢ Camera access is completely optional
        â€¢ Captured images are stored only on your device
        â€¢ Images are never transmitted externally
        â€¢ Can be deleted anytime from settings

        5. Data Deletion
        You can delete all data anytime from the app settings screen.

        6. Third-Party Information Sharing
        The App does not share any personal information with third parties.

        7. Contact
        For questions about this Privacy Policy, please contact us via the App Store review section.

        End
        `;
            }
          }
        }

        function setupTermsContent(){
          const title = $('termsTitle');
          const content = $('termsContent');
          
          if(appLang === 'ja'){
            if(title) title.textContent = 'åˆ©ç”¨è¦ç´„';
            if(content){
              content.textContent = `
        ã€KuKuãƒ‰ãƒªãƒ« åˆ©ç”¨è¦ç´„ã€‘

        æœ€çµ‚æ›´æ–°æ—¥: ${new Date().toLocaleDateString('ja-JP')}

        1. åˆ©ç”¨è¦ç´„ã®é©ç”¨
        æœ¬åˆ©ç”¨è¦ç´„ã¯ã€KuKuãƒ‰ãƒªãƒ«ï¼ˆä»¥ä¸‹ã€Œå½“ã‚¢ãƒ—ãƒªã€ï¼‰ã®åˆ©ç”¨ã«é–¢ã™ã‚‹æ¡ä»¶ã‚’å®šã‚ã‚‹ã‚‚ã®ã§ã™ã€‚
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€å½“ã‚¢ãƒ—ãƒªã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æœ¬è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã•ã‚Œã¾ã™ã€‚

        2. ã‚¢ãƒ—ãƒªã®åˆ©ç”¨
        â€¢ å½“ã‚¢ãƒ—ãƒªã¯æ•™è‚²ç›®çš„ã§æä¾›ã•ã‚Œã‚‹ç„¡æ–™ã‚¢ãƒ—ãƒªã§ã™
        â€¢ å€‹äººåˆ©ç”¨ãƒ»å®¶åº­å†…åˆ©ç”¨ãƒ»å­¦æ ¡ã§ã®åˆ©ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
        â€¢ å–¶åˆ©ç›®çš„ã§ã®å†é…å¸ƒã‚„æ”¹å¤‰ã¯ç¦æ­¢ã—ã¾ã™

        3. å…è²¬äº‹é …
        â€¢ å½“ã‚¢ãƒ—ãƒªã¯ã€Œç¾çŠ¶ã®ã¾ã¾ã€æä¾›ã•ã‚Œã¾ã™
        â€¢ å½“ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“
        â€¢ å½“ã‚¢ãƒ—ãƒªã®å‹•ä½œä¿è¨¼ã¯ã„ãŸã—ã¾ã›ã‚“

        4. çŸ¥çš„è²¡ç”£æ¨©
        å½“ã‚¢ãƒ—ãƒªã«é–¢ã™ã‚‹è‘—ä½œæ¨©ãƒ»çŸ¥çš„è²¡ç”£æ¨©ã¯é–‹ç™ºè€…ã«å¸°å±ã—ã¾ã™ã€‚

        5. ç¦æ­¢äº‹é …
        ä»¥ä¸‹ã®è¡Œç‚ºã‚’ç¦æ­¢ã—ã¾ã™ï¼š
        â€¢ å½“ã‚¢ãƒ—ãƒªã®ä¸æ­£åˆ©ç”¨ãƒ»æ”¹å¤‰ãƒ»ãƒªãƒãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°
        â€¢ ä»–è€…ã®æ¨©åˆ©ã‚’ä¾µå®³ã™ã‚‹è¡Œç‚º
        â€¢ æ³•ä»¤ã«é•åã™ã‚‹è¡Œç‚º

        6. è¦ç´„ã®å¤‰æ›´
        é–‹ç™ºè€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®äº‹å‰é€šçŸ¥ãªãæœ¬è¦ç´„ã‚’å¤‰æ›´ã§ãã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

        7. æº–æ‹ æ³•ãƒ»ç®¡è½„è£åˆ¤æ‰€
        æœ¬è¦ç´„ã¯æ—¥æœ¬æ³•ã«æº–æ‹ ã—ã¾ã™ã€‚
        ç´›äº‰ãŒç”Ÿã˜ãŸå ´åˆã¯ã€æ±äº¬åœ°æ–¹è£åˆ¤æ‰€ã‚’ç¬¬ä¸€å¯©ã®å°‚å±çš„åˆæ„ç®¡è½„è£åˆ¤æ‰€ã¨ã—ã¾ã™ã€‚

        ä»¥ä¸Š
        `;
            }
          } else {
            if(title) title.textContent = 'Terms of Use';
            if(content){
              content.textContent = `
        ã€KuKu Drill Terms of Useã€‘

        Last Updated: ${new Date().toLocaleDateString('en-US')}

        1. Application of Terms
        These Terms of Use define the conditions for using KuKu Drill ("the App").
        By using the App, users are deemed to have agreed to these Terms.

        2. Use of the App
        â€¢ The App is a free educational app
        â€¢ Intended for personal, home, and school use
        â€¢ Commercial redistribution or modification is prohibited

        3. Disclaimer
        â€¢ The App is provided "as is"
        â€¢ The developer is not responsible for any damages arising from use of the App
        â€¢ No warranty is provided for the App's operation

        4. Intellectual Property Rights
        Copyright and intellectual property rights related to the App belong to the developer.

        5. Prohibited Activities
        The following activities are prohibited:
        â€¢ Unauthorized use, modification, or reverse engineering of the App
        â€¢ Acts that infringe on the rights of others
        â€¢ Acts that violate laws and regulations

        6. Changes to Terms
        The developer may change these Terms without prior notice to users.

        7. Governing Law and Jurisdiction
        These Terms are governed by Japanese law.
        In case of disputes, Tokyo District Court shall be the exclusive agreed jurisdiction court of first instance.

        End
        `;
            }
          }
        }
        
        const privacyBtn = $('privacyBtn');
        if(privacyBtn){
            privacyBtn.onclick = ()=>{
                const modal = $('privacyModal');
                const content = $('privacyContent');
                const title = $('privacyTitle');
                const closeBtn = $('privacyClose');
                
                if(!modal || !content || !title) return;
                
                setupPrivacyContent();
                
                modal.classList.add('show');
                setOverlayLock(true);
                
                const sheet = $('sheet');
                if(sheet) sheet.classList.remove('show');
                
                if(closeBtn){
                    closeBtn.onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        modal.classList.remove('show');
                        setOverlayLock(false);
                        return false;
                    };
                }
                
                const backDrop = modal.querySelector('.back');
                if(backDrop){
                    backDrop.onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        modal.classList.remove('show');
                        setOverlayLock(false);
                        return false;
                    };
                }
            };
        }
        
        const termsBtn = $('termsBtn');
        if(termsBtn){
            termsBtn.onclick = ()=>{
                const modal = $('termsModal');
                const content = $('termsContent');
                const title = $('termsTitle');
                const closeBtn = $('termsClose');
                
                if(!modal || !content || !title) return;
                
                setupTermsContent();
                
                modal.classList.add('show');
                setOverlayLock(true);
                
                const sheet = $('sheet');
                if(sheet) sheet.classList.remove('show');
                
                if(closeBtn){
                    closeBtn.onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        modal.classList.remove('show');
                        setOverlayLock(false);
                        return false;
                    };
                }
                
                const backDrop = modal.querySelector('.back');
                if(backDrop){
                    backDrop.onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        modal.classList.remove('show');
                        setOverlayLock(false);
                        return false;
                    };
                }
            };
        }
        
        // â˜…DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆå†…ã§å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ”µ DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
            await showFirstLaunchPrivacy();
        });

        (async ()=>{
            console.log('ğŸ”µ åˆæœŸåŒ–å‡¦ç†é–‹å§‹');
            
            updateLangUI();
            resetState();
            newProblem(true);
            
            const saved=localStorage.getItem('kukuLite');
            if(saved!=null){
                applyLite(saved==='1');
            } else {
                const prefersReduce=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                if(prefersReduce){
                    applyLite(true);
                } else {
                    const fps=await measureFps(12);
                    if(isiOS && fps<30) applyLite(true);
                }
            }
            
            const togLite=$('togLite');
            if(togLite){
                togLite.classList.toggle('active', document.body.classList.contains('perf-lite'));
                togLite.addEventListener('click',()=>{
                    const next=!document.body.classList.contains('perf-lite');
                    applyLite(next);
                    togLite.classList.toggle('active', next);
                });
            }
            
            boot();
        })();

        // ========================================
        // Service Worker ç™»éŒ² (å®Œå…¨ç‰ˆ)
        // ========================================
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            console.log('ğŸ”§ Service Worker ç™»éŒ²å‡¦ç†é–‹å§‹');
            
            // localhost ã¾ãŸã¯ https ã®å ´åˆã®ã¿ç™»éŒ²
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
              navigator.serviceWorker.register('./sw.js', { scope: './' })
                .then(function(registration) {
                  console.log('âœ… Service Worker ç™»éŒ²æˆåŠŸ!');
                  console.log('ğŸ“ Scope:', registration.scope);
                  
                  if (registration.active) {
                    console.log('ğŸ“¦ Active Worker:', registration.active.scriptURL);
                    console.log('ğŸ“¦ State:', registration.active.state);
                  } else if (registration.installing) {
                    console.log('â³ Installing Worker...');
                  } else if (registration.waiting) {
                    console.log('â¸ï¸ Waiting Worker...');
                  }
                  
                  // æ›´æ–°ãƒã‚§ãƒƒã‚¯
                  registration.update();
                  
                  // æ–°ã—ã„ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚‰é€šçŸ¥
                  registration.addEventListener('updatefound', () => {
                    console.log('ğŸ”„ æ–°ã—ã„ Service Worker ã‚’æ¤œå‡º');
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                      console.log('ğŸ“¦ SW State changed to:', newWorker.state);
                      if (newWorker.state === 'activated') {
                        console.log('ğŸ‰ æ–°ã—ã„ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ!');
                      }
                    });
                  });
                })
                .catch(function(error) {
                  console.error('âŒ Service Worker ç™»éŒ²å¤±æ•—:', error);
                  console.error('âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                  console.error('âŒ ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
                });
            } else {
              console.warn('âš ï¸ Service Worker ã¯ https:// ã¾ãŸã¯ localhost ã§ã®ã¿å‹•ä½œã—ã¾ã™');
              console.log('ç¾åœ¨ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«:', location.protocol);
              console.log('ç¾åœ¨ã®ãƒ›ã‚¹ãƒˆ:', location.hostname);
            }
          });
        } else {
          console.error('âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ Service Worker ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
        }

                })();
            </script>

    <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <!-- â˜…è¿½åŠ : åˆå›èµ·å‹•æ™‚ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼åŒæ„ç”»é¢ -->
    <div class="modal" id="firstLaunchModal" style="z-index:1400">
      <div class="back" style="background: rgba(6,4,20,.85)"></div>
      <div class="panel" style="text-align:center; max-width:540px; max-height:88vh; overflow-y:auto;">
        <div style="font-size:56px; margin:20px 0 16px;">ğŸ›¡ï¸</div>
        <div class="h" id="firstLaunchTitle" style="font-size:22px; margin-bottom:12px;">
          ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„
        </div>
        
        <div id="firstLaunchBody" style="text-align:left; padding:0 12px; margin-bottom:20px;">
          <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                      border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
            <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
              âœ¨ ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦
            </div>
            <div class="small" style="line-height:1.7; color:var(--muted);">
              KuKuãƒ‰ãƒªãƒ«ã¯ã€ãŠå­æ§˜ãŒæ¥½ã—ãä¹ä¹ã‚’å­¦ç¿’ã§ãã‚‹æ•™è‚²ã‚¢ãƒ—ãƒªã§ã™ã€‚<br>
              ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãŠä½¿ã„ã®ãƒ‡ãƒã‚¤ã‚¹å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚
            </div>
          </div>

          <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                      border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
            <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
              ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·
            </div>
            <ul class="small" style="line-height:1.7; color:var(--muted); margin:0; padding-left:20px;">
              <li>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ã‚³ã‚¢ã€å±¥æ­´ï¼‰ã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã®ã¿ã«ä¿å­˜</li>
              <li>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã¯ä¸è¦ï¼ˆå®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œï¼‰</li>
              <li>å€‹äººæƒ…å ±ã®åé›†ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“</li>
              <li>åºƒå‘Šã‚„ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</li>
            </ul>
          </div>

          <div style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); 
                      border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px;">
            <div style="font-size:15px; font-weight:700; margin-bottom:8px; color:var(--text);">
              ğŸ“¸ ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ï¼ˆä»»æ„ï¼‰
            </div>
            <div class="small" style="line-height:1.7; color:var(--muted);">
              å¿œæ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ©Ÿèƒ½ã§ã¯ã€ã‚«ãƒ¡ãƒ©æ’®å½±ãŒå¯èƒ½ã§ã™ã€‚<br>
              â€¢ ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã¯<strong>å®Œå…¨ã«ä»»æ„</strong>ã§ã™<br>
              â€¢ æ’®å½±ã—ãŸå†™çœŸã¯ãƒ‡ãƒã‚¤ã‚¹å†…ã®ã¿ã«ä¿å­˜<br>
              â€¢ å¤–éƒ¨ã¸ã®é€ä¿¡ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“<br>
              â€¢ ã„ã¤ã§ã‚‚å‰Šé™¤ã§ãã¾ã™
            </div>
          </div>

          <div style="background:linear-gradient(180deg, rgba(59,199,255,.12), rgba(59,199,255,.04)); 
                      border:1px solid rgba(59,199,255,.3); border-radius:12px; padding:14px; margin-bottom:16px;">
            <div class="small" style="line-height:1.7; color:var(--text); text-align:center;">
              è©³ç´°ã¯
              <button id="privacyLinkFromFirst"
                      style="background:none; border:0; color:var(--accentB); 
                             text-decoration:underline; cursor:pointer; font-size:inherit; padding:0;">
                ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
              </button>
              ã¨
              <button id="termsLinkFromFirst"
                      style="background:none; border:0; color:var(--accentB); 
                             text-decoration:underline; cursor:pointer; font-size:inherit; padding:0;">
                åˆ©ç”¨è¦ç´„
              </button>
              ã‚’ã”è¦§ãã ã•ã„
            </div>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn grad" id="firstLaunchAgree" style="min-width:200px; font-size:16px;">
            åŒæ„ã—ã¦ã¯ã˜ã‚ã‚‹
          </button>
        </div>

        <div class="small" style="margin-top:16px; color:var(--muted); font-size:12px;">
          ã€ŒåŒæ„ã—ã¦ã¯ã˜ã‚ã‚‹ã€ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¨åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™
        </div>
      </div>
    </div>


    <div class="modal" id="privacyModal">
      <div class="back"></div>
      <div class="panel" style="max-height:80vh; overflow:auto;">
        <div class="h" id="privacyTitle">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</div>
        <div class="small" id="privacyContent" style="text-align:left; line-height:1.8; white-space:pre-wrap;">
          <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æœ¬æ–‡ã¯JavaScriptã§æŒ¿å…¥ -->
        </div>
        <div class="btnrow">
          <button class="btn grad" id="privacyClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

    <!-- åˆ©ç”¨è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="termsModal">
      <div class="back"></div>
      <div class="panel" style="max-height:80vh; overflow:auto;">
        <div class="h" id="termsTitle">åˆ©ç”¨è¦ç´„</div>
        <div class="small" id="termsContent" style="text-align:left; line-height:1.8; white-space:pre-wrap;">
          <!-- åˆ©ç”¨è¦ç´„æœ¬æ–‡ã¯JavaScriptã§æŒ¿å…¥ -->
        </div>
        <div class="btnrow">
          <button class="btn grad" id="termsClose">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>

    </body>
    </html>
