<!DOCTYPE html>
<html lang="ja">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>KuKuãƒ‰ãƒªãƒ«</title>
<meta name="theme-color" content="#9c2cff">
<style>
:root{
  --bg:#0a0714; --grad1:#2b115a; --grad2:#091a3a;
  --pink:#ff4dc4; --blue:#3bc7ff;
  --panel: rgba(255,255,255,.08);
  --panel2: rgba(255,255,255,.05);
  --border: rgba(255,255,255,.14);
  --text:#f7f6ff; --muted:#c7c2e6;
  --ok:#35ffa1; --ng:#ff6a6a;
  --radius:18px; --radius-sm:14px;
  --wallOpacity:.36;
  --accentA:#ff4dc4; --accentB:#3bc7ff;
}
body.theme-mix{ --accentA:#ff4dc4; --accentB:#3bc7ff; }
body.theme-pink{ --accentA:#ff7adf; --accentB:#ff5ea6; }
body.theme-blue{ --accentA:#7ad3ff; --accentB:#3bc7ff; }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); font-family:system-ui,-apple-system,"Inter","Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",sans-serif;
  display:flex; justify-content:center; align-items:flex-start; padding:16px;
  background:
    radial-gradient(1200px 700px at 10% -10%, rgba(156,44,255,.32), var(--bg) 60%),
    radial-gradient(1100px 700px at 120% 10%, rgba(59,199,255,.26), var(--bg) 60%),
    linear-gradient(180deg, var(--grad1) 0%, var(--bg) 100%);
  overflow-x:hidden;
}
.wall{ position:fixed; inset:0; z-index:-2; opacity:var(--wallOpacity);
  background-image: var(--neon-wall);
  background-size:260px 260px; filter:saturate(120%) contrast(110%);
}
.beams{ position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.9;
  background:
    conic-gradient(from 0deg at 20% 0%, color-mix(in oklab, var(--accentA) 45%, transparent), transparent 30%),
    conic-gradient(from 180deg at 80% 10%, color-mix(in oklab, var(--accentB) 45%, transparent), transparent 35%);
  filter: blur(44px) saturate(120%); animation:spin 18s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.app{width:100%;max-width:720px;margin:0 auto;}
header{display:flex;align-items:center;justify-content:space-between;margin:2px 0 12px;gap:8px}
.title{font-weight:900;font-size:28px;letter-spacing:.5px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.badge{
  display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none;
  background:linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#0b0416; font-weight:800; border:0; box-shadow:inset 0 0 0 1px rgba(255,255,255,.22);
}
.btn-ghost{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:transparent; color:#e8e2ff; font-weight:800; cursor:pointer }

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid var(--border); border-radius:18px; padding:14px; backdrop-filter:blur(14px); box-shadow:0 12px 30px rgba(12,4,40,.5);
}
.panel{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius:16px; padding:12px }

.problem{
  text-align:center; font-size:56px; font-weight:900; letter-spacing:1px; padding:16px 10px; border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid var(--border);
  text-shadow:0 0 14px color-mix(in oklab, var(--accentB) 55%, transparent), 0 0 10px color-mix(in oklab, var(--accentA) 45%, transparent); 
  margin-bottom:12px;
}
.kuku-input{ text-align:right; width:100%; font-size:28px; padding:14px 16px; border-radius:16px; border:1px solid var(--border);
  background:rgba(255,255,255,.1); color:#fff; outline:none; }

.keypad{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px }
.key{ font-size:24px; padding:16px 10px; text-align:center; border-radius:14px; border:1px solid var(--border);
  background:linear-gradient(180deg,var(--panel),var(--panel2)); color:#f2efff; cursor:pointer; user-select:none; }
.key:active{ transform:translateY(1px) scale(.99); }

.key.ok{
  position:relative; font-weight:900;
  background: linear-gradient(90deg,var(--accentA),var(--accentB));
  color:#0b0416;
  border:0;
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,.25),
    0 6px 18px color-mix(in oklab, var(--accentB) 35%, transparent);
}
.key.ok::before{
  content:""; position:absolute; inset:0; border-radius:14px;
  background:linear-gradient(90deg,color-mix(in oklab,var(--accentA) 92%, transparent), color-mix(in oklab,var(--accentB) 92%, transparent));
  mask:linear-gradient(#000,#000); opacity:.85; pointer-events:none;
}

.statrow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
.stat{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius:14px; padding:10px; text-align:center }
.stat small{color:var(--muted)} .stat b{display:block;font-size:18px}

.result{text-align:center;margin-top:10px;font-weight:900;min-height:28px}
.result.ok{color:var(--ok)} .result.ng{color:var(--ng)}

details{ margin-top:12px }
summary{
  list-style:none; cursor:pointer; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
  background:
    linear-gradient(90deg, color-mix(in oklab, var(--accentA) 25%, transparent), color-mix(in oklab, var(--accentB) 25%, transparent)),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  color:#fff; font-weight:800;
}
summary::-webkit-details-marker{ display:none }
.section-body{ margin-top:10px; padding:10px; border-radius:12px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); }

.pillset{display:flex;flex-wrap:wrap;gap:8px}
.pill{ padding:8px 12px; border-radius:999px; border:1px solid var(--border);
  background:linear-gradient(90deg, color-mix(in oklab, var(--accentA) 22%, transparent), color-mix(in oklab, var(--accentB) 22%, transparent));
  color:#eae7ff; cursor:pointer; font-size:14px; user-select:none; }
.pill.active{ outline:2px solid color-mix(in oklab, var(--accentA) 55%, transparent); box-shadow:0 0 20px color-mix(in oklab, var(--accentA) 35%, transparent)}

.sep{height:1px;background:linear-gradient(90deg, color-mix(in oklab, var(--accentA) 0%, transparent), color-mix(in oklab, var(--accentA) 40%, transparent), color-mix(in oklab, var(--accentB) 40%, transparent), color-mix(in oklab, var(--accentB) 0%, transparent));margin:10px 0}

footer{margin:16px 0 6px;text-align:center;color:#bcb6da;font-size:12px}

/* ====== ã‚·ãƒ¼ãƒˆï¼ˆè©³ç´°è¨­å®šï¼‰ ====== */
.fab{position:fixed; right:14px; bottom:16px; z-index:980; display:flex; align-items:center; gap:8px}
#openSettings{border-radius:999px; padding:12px 14px; font-weight:800; cursor:pointer; background:linear-gradient(90deg, var(--accentA), var(--accentB)); color:#0b0416; border:0; box-shadow:0 12px 30px rgba(12,4,40,.5)}
.sheet{position:fixed; left:0; right:0; bottom:-72vh; height:72vh; z-index:990;
  background:rgba(10,7,20,.6); backdrop-filter: blur(18px); border-top:1px solid var(--border); border-radius:18px 18px 0 0;
  transition: bottom .28s ease}
.sheet.show{bottom:0}
.sheet .grab{width:50px; height:5px; border-radius:999px; background:rgba(255,255,255,.35); margin:8px auto}
.sheet .inner{padding:10px 14px 18px; height:calc(100% - 18px); overflow:auto}
.label{font-size:12px;color:var(--muted);margin:8px 0 6px}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:999}
.modal.show{display:flex}
.modal .back{position:absolute; inset:0; background:rgba(0,0,0,.45)}

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ‘ãƒãƒ«ã‚’å¸¸ã«ç”»é¢å†…ã«åã‚ã‚‹ï¼ˆiPhoneå¯¾ç­–ï¼‰ */
.modal .panel{
  width: clamp(280px, 92vw, 720px);
  max-width: 92vw;
  margin: 0 auto;
  box-sizing: border-box;

  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  backdrop-filter:blur(14px);
}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¦ªã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯ï¼ˆå°ç”»é¢ã§ã®ã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
.table-wrap{
  margin-top:8px;
  overflow-x:auto;         /* â† è¿½åŠ  */
  -webkit-overflow-scrolling: touch;
}
.history-table{
  min-width: 560px;        /* åˆ—ãŒæ½°ã‚Œã™ããªã„ã‚ˆã†æœ€ä½å¹…ã‚’ç¢ºä¿ */
  width: 100%;
  border-collapse:separate; border-spacing:0; font-size:14px;
  border:1px solid var(--border); border-radius:12px; overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
}
.modal .h{font-weight:900;font-size:18px;margin-bottom:6px}
.btnrow{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:10px}
.btn{min-width:120px; padding:12px 14px; border-radius:14px; font-weight:900; cursor:pointer; border:1px solid var(--border); background:transparent; color:#fff}
.btn.grad{ border:0; color:#0b0416; background:linear-gradient(90deg,var(--accentA),var(--accentB)) }

/* mascot */
.mascot{position:fixed; left:50%; bottom:12vh; transform:translateX(-50%); z-index:1001; width:140px; height:140px; border-radius:50%; overflow:hidden;
  box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 4px rgba(255,255,255,.85); background:#000}
.mascot img{width:100%; height:100%; object-fit:cover}
@keyframes cheer-bounce{0%{transform:translate(-50%,0)}25%{transform:translate(-50%,-12px)}50%{transform:translate(-50%,0)}75%{transform:translate(-50%,-10px)}100%{transform:translate(-50%,0)}}
@keyframes cry-shake{0%{transform:translate(-50%,0)}20%{transform:translate(calc(-50% - 8px),0)}40%{transform:translate(calc(-50% + 8px),0)}60%{transform:translate(calc(-50% - 6px),0)}80%{transform:translate(calc(-50% + 6px),0)}100%{transform:translate(-50%,0)}}
.mascot.cheer{animation:cheer-bounce .9s ease-in-out 3}
.mascot.cry{animation:cry-shake .6s ease-in-out 2}
.tear{ position:absolute; width:14px; height:22px; left:50%; top:18px; transform:translateX(-50%); border-radius:10px; background:#7fd4ff; opacity:.85}
.tear.right{ left:65% } .tear.left{ left:35% }
/* â–¼3,2,1 ãƒãƒƒãƒ—è¡¨ç¤ºç”¨ */
.pop-grow{ animation:pop .45s ease forwards }
@keyframes pop{
  0%{ transform:scale(.4); opacity:.2 }
  60%{ transform:scale(1.2); opacity:1 }
  100%{ transform:scale(1) }
}
/* ===== Confetti (paper fireworks) ===== */
.confetti{
  position:fixed;
  top:-10px;
  width:8px;
  height:14px;
  opacity:.9;
  z-index:1000;
  border-radius:2px
}
/* History table look */
.hist-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
.hist-table th, .hist-table td {
  border: 1px solid var(--border);
  padding: 8px 10px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
}
.hist-table thead th {
  background: rgba(255,255,255,.10);
}
.hist-section-title {
  margin: 10px 0 6px;
}
/* â”€â”€ å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¦‹ãŸç›®å¼·åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap{ margin-top:8px }
.table-note{ font-size:12px; color:var(--muted); margin:6px 0 4px }

.history-table{
  width:100%; border-collapse:separate; border-spacing:0; font-size:14px;
  border:1px solid var(--border); border-radius:12px; overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
}
.history-table th, .history-table td{
  padding:10px 12px; border-bottom:1px solid var(--border);
}
.history-table th{
  text-align:left; background:rgba(255,255,255,.08); font-weight:700;
}
.history-table tr:last-child td{ border-bottom:none }

/* äº¤äº’ã®ã†ã£ã™ã‚‰ã‚¼ãƒ–ãƒ© */
.history-table tbody tr:nth-child(odd):not(.best-row):not(.miss-row){
  background:rgba(255,255,255,.02);
}

/* ãƒ™ã‚¹ãƒˆè¡Œã®å¼·èª¿ï¼ˆã‚„ã‚Šã™ããªã„ã‚°ãƒ­ãƒ¼ï¼‰ */
.best-row{
  position:relative;
  background:linear-gradient(90deg, rgba(59,199,255,.10), rgba(255,77,196,.10));
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.18);
}
.best-badge{
  display:inline-flex; align-items:center; gap:6px; font-weight:800;
}
.best-badge .star{
  font-size:14px; filter:drop-shadow(0 0 4px rgba(255,255,255,.5));
}

/* ãƒŸã‚¹ãŒã‚ã£ãŸå›ã‚’ã»ã‚“ã®ã‚Šèµ¤ã¿ã§ */
.miss-row{
  background:rgba(255,106,106,.10);
}

/* æ­£è§£æ•°/å…¨å•æ•°ã®ãƒŸãƒ‹ãƒ©ãƒ™ãƒ« */
.solved-chip{
  font-size:12px; font-weight:700; padding:3px 8px; border-radius:999px;
  background:rgba(255,255,255,.10); border:1px solid var(--border);
}
/* é¡”ã‚«ãƒ¡ãƒ©ã‚’ãƒŸãƒ©ãƒ¼è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã¿ï¼‰ */
#cam.mirror { transform: scaleX(-1); 
}

</style>
</head>
<body class="theme-mix">
<div class="wall"></div><div class="beams"></div>

<div class="app">
  <header>
    <div class="title" id="titleTxt">KuKuãƒ‰ãƒªãƒ«</div>
    <div class="row">
      <button id="paletteBtn" class="badge"><span id="paletteEmoji">ğŸ’™Ã—ğŸ’–</span><span id="paletteLabel">MIX</span></button>
    </div>
  </header>

  <div class="card">
    <div id="problem" class="problem" aria-live="assertive" aria-atomic="true">â€” Ã— â€” = ?</div>
    <input id="answer" class="kuku-input" type="text" inputmode="none" placeholder="ã“ãŸãˆ" readonly>
    <div class="keypad">
      <div class="key">7</div><div class="key">8</div><div class="key">9</div>
      <div class="key">4</div><div class="key">5</div><div class="key">6</div>
      <div class="key">1</div><div class="key">2</div><div class="key">3</div>
      <div class="key">0</div><div class="key">âŒ«</div><div class="key ok" id="okKey">OK</div>
    </div>

    <div id="result" class="result"></div>
    <div class="statrow">
      <div class="stat"><small id="labScore">ã‚¹ã‚³ã‚¢</small><b id="score">0</b></div>
      <div class="stat"><small id="labStreak">ã‚Œã‚“ã•</small><b id="streak">0</b></div>
      <div class="stat"><small id="labAvg">å¹³å‡ã‚¿ã‚¤ãƒ </small><b id="avgTime">â€”</b></div>
    </div>

    <details id="rangeD">
      <summary id="rngTitle">å‡ºé¡Œç¯„å›²ï¼ˆã‹ã‘ã‚‰ã‚Œã‚‹æ•° Ã— ã‹ã‘ã‚‹æ•°ï¼‰</summary>
      <div class="section-body">
        <div class="label" id="labA">ã‹ã‘ã‚‰ã‚Œã‚‹æ•°ï¼ˆæ®µï¼‰</div>
        <div id="danSet" class="pillset"></div>
        <div class="sep"></div>
        <div class="label" id="labB">ã‹ã‘ã‚‹æ•°ï¼ˆ1ã€œ9ï¼‰</div>
        <div id="kuSet" class="pillset"></div>
      </div>
    </details>

    <details id="modeD">
      <summary id="labMode">ãƒ¢ãƒ¼ãƒ‰</summary>
      <div class="section-body pillset" id="modeSet">
        <button class="pill active" data-mode="product" id="modeP">ç­”ãˆã‚’å…¥åŠ›ï¼ˆæ¨™æº–ï¼‰</button>
        <button class="pill" data-mode="missingB" id="modeMB">â–¡ Ã— B = ?ï¼ˆå·¦ã‚’å…¥åŠ›ï¼‰</button>
        <button class="pill" data-mode="missingA" id="modeMA">A Ã— â–¡ = ?ï¼ˆå³ã‚’å…¥åŠ›ï¼‰</button>
      </div>
    </details>

    <details id="ttD">
      <summary id="timerLabel">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ <small id="timerStatus">æœªé–‹å§‹</small></summary>
      <div class="section-body">
        <div class="pillset">
          <button class="pill" id="timer15">15å•</button><span class="pill small" id="best15" style="opacity:.65">Best: â€”</span>
          <button class="pill" id="timer30">30å•</button><span class="pill small" id="best30" style="opacity:.65">Best: â€”</span>
          <button class="pill" id="timer60">60å•</button><span class="pill small" id="best60" style="opacity:.65">Best: â€”</span>
          <button class="pill" id="timer81">99(81å•)ãƒ©ãƒ³ãƒ€ãƒ </button><span class="pill small" id="best81" style="opacity:.65">Best: â€”</span>
          <button class="pill" id="timerFree">ç„¡åˆ¶é™</button>
          <button class="pill" id="openHistory">å±¥æ­´</button>
        </div>
      </div>
    </details>
  </div>

  <footer>Â© KuKuãƒ‰ãƒªãƒ«</footer>
</div>

<!-- è©³ç´°è¨­å®š -->
<div class="fab"><button id="openSettings">âš™ï¸è©³ç´°è¨­å®š</button></div>
<div class="sheet" id="sheet">
  <div class="grab"></div>
  <div class="inner">
    <div class="label" id="secSound">ã‚µã‚¦ãƒ³ãƒ‰</div>
    <div class="pillset" id="soundPack">
      <div class="opt pill" data-pack="synth">Synth Pop</div>
      <div class="opt pill" data-pack="edm">EDM</div>
      <div class="opt pill" data-pack="cute">Cute</div>
    </div>

    <div class="label" id="secLang">è¨€èªè¨­å®š</div>
    <div class="pillset" id="langSet">
      <button class="pill" data-lang="ja">JPğŸ‡¯ğŸ‡µ</button>
      <button class="pill" data-lang="en">ENğŸ‡ºğŸ‡¸</button>
    </div>

    <div class="label" id="secTog">èª­ã¿ä¸Šã’ / åŠ¹æœéŸ³ / å¿œæ´</div>
    <div class="pillset" id="toggles">
      <button class="pill toggle" data-flag="speak" id="togSpeak">èª­ã¿ä¸Šã’</button>
      <button class="pill toggle" data-flag="sfx"   id="togSfx">åŠ¹æœéŸ³</button>
      <button class="pill toggle" data-flag="cheer" id="togCheer">å¿œæ´</button>
    </div>

    <div class="label" id="secCheer">å¿œæ´</div>
    <div class="pillset">
      <button class="pill" id="faceBtn">é¡”ã‚’è¨­å®š</button>
      <button class="pill" id="faceDel">é¡”ã‚’å‰Šé™¤</button>
    </div>

    <div class="label" id="secBg">èƒŒæ™¯ç”»åƒ</div>
    <div class="pillset">
      <button class="pill" id="bgPick">èƒŒæ™¯ç”»åƒ</button>
      <button class="pill" id="bgReset">èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ</button>
      <input type="file" id="bgFile" accept="image/*" style="display:none">
    </div>
    <div class="label" style="margin-top:12px">ãƒ‡ãƒ¼ã‚¿</div>
<div class="pillset">
  <button class="pill" id="hardResetBtn" type="button">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>
    <div class="label" id="secBright">æ˜ã‚‹ã•</div>
    <input type="range" id="bgBright" min="0" max="100" value="36" style="width:100%">

    <div class="row" style="justify-content:center;margin-top:12px">
      <button class="btn" id="closeSettings">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- é¡” æ’®å½±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="faceModal"><div class="back"></div><div class="panel" style="text-align:center">
  <div class="h" id="faceTitle">å¿œæ´ã®é¡”ã‚’æ’®å½±</div><div class="small" id="faceHint">ä¸¸æ ã«é¡”ã‚’å…¥ã‚Œã¦ã­ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ã€‚</div>
  <div style="position:relative; width:min(80vw,320px); height:min(80vw,320px); margin:10px auto;">
    <video id="cam" autoplay playsinline style="width:100%;height:100%;border-radius:50%;object-fit:cover;background:#000"></video>
    <div style="position:absolute;inset:0;border-radius:50%;box-shadow:inset 0 0 0 6px rgba(255,255,255,.9);pointer-events:none"></div>
  </div>
  <canvas id="shot" width="320" height="320" style="display:none"></canvas>
  <div class="btnrow"><button class="btn" id="faceCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn grad" id="faceTake">æ’®å½±</button><button class="btn grad" id="faceSave" disabled>ä¿å­˜</button></div>
</div></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚¹ã‚¿ãƒ¼ãƒˆç¢ºèª / çµæœ / å±¥æ­´ -->
<div class="modal" id="startModal"><div class="back"></div><div class="panel" style="text-align:center">
  <div class="h" id="startTitle">ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ</div>
  <div class="small" id="startDesc">é¸æŠã—ãŸæœ¬æ•°ã§é–‹å§‹ã—ã¾ã™ã€‚</div>
  <div id="countNum" style="font-size:46px;font-weight:900;margin:8px 0">â±</div>
  <div class="btnrow">
    <button class="btn" id="startCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn grad" id="startGo">OK</button>
  </div>
</div></div>

<div class="modal" id="resultModal"><div class="back"></div><div class="panel">
  <div class="h" id="rpTitle">çµæœ</div>
  <div class="small" id="rpBody" style="white-space:pre-line">â€”</div>
  <div class="btnrow">
    <button class="btn grad" id="rpShare">å…±æœ‰</button>
    <button class="btn" id="rpCopy">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn grad" id="rpClose">OK</button>
  </div>
</div></div>

<div class="modal" id="historyModal"><div class="back"></div><div class="panel">
  <div class="h" id="histTitle">å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰</div>
  <div id="historyContent" class="small">â€”</div>
  <div class="btnrow"><button class="btn" id="clearHistory" type="button">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button><button class="btn grad" id="historyClose">é–‰ã˜ã‚‹</button></div>
</div></div>

<script>
// ==== Safe localStorage shim (iPhone HTML Viewer / Private mode å¯¾ç­–) ====
(function(){
  var ok = true;
  try {
    var k = '__ls_test__';
    window.localStorage.setItem(k, '1');
    window.localStorage.removeItem(k);
  } catch (e) { ok = false; }

  if (!ok) {
    // ä¾‹å¤–ã‚’å‡ºã•ãªã„ãƒ€ãƒŸãƒ¼å®Ÿè£…ï¼ˆãƒšãƒ¼ã‚¸ãŒè½ã¡ã‚‹ã®ã‚’é˜²ãï¼‰
    var mem = {};
    window.localStorage = {
      getItem: function(key){ return Object.prototype.hasOwnProperty.call(mem, key) ? mem[key] : null; },
      setItem: function(key, val){ mem[key] = String(val); },
      removeItem: function(key){ delete mem[key]; },
      clear: function(){ mem = {}; },
      key: function(i){ return Object.keys(mem)[i] || null; },
      get length(){ return Object.keys(mem).length; }
    };
    // å¿…è¦ãªã‚‰é€šçŸ¥
    try { alert('ã“ã®ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ã¯ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒç„¡åŠ¹ã§ã™ã€‚å±¥æ­´ã‚„è¨­å®šã¯æ¬¡å›èµ·å‹•æ™‚ã«æ®‹ã‚Šã¾ã›ã‚“ã€‚'); } catch(_) {}
  }
})();
(function(){
  const $=id=>document.getElementById(id);

  /* ========== ãƒ†ãƒ¼ãƒ ========== */
const paletteBtn=$('paletteBtn'), paletteLabel=$('paletteLabel'), paletteEmoji=$('paletteEmoji');
const resetBtn=$('resetBtn'); // ãªãã¦ã‚‚OKã«ã™ã‚‹
if (resetBtn) {
  resetBtn.onclick=function(){ localStorage.clear(); location.reload(); };
}
  function setTheme(t){
    document.body.classList.remove('theme-mix','theme-pink','theme-blue');
    if(t==='pink'){ document.body.classList.add('theme-pink'); paletteLabel.textContent='PINK'; paletteEmoji.textContent='ğŸ’–'; }
    else if(t==='blue'){ document.body.classList.add('theme-blue'); paletteLabel.textContent='BLUE'; paletteEmoji.textContent='ğŸ’™'; }
    else{ document.body.classList.add('theme-mix'); paletteLabel.textContent='MIX'; paletteEmoji.textContent='ğŸ’™Ã—ğŸ’–'; t='mix'; }
    localStorage.setItem('kukuTheme', t);
  }
  setTheme(localStorage.getItem('kukuTheme')||'mix');
  paletteBtn.onclick=function(){
    const cur=localStorage.getItem('kukuTheme')||'mix';
    setTheme(cur==='mix'?'pink':(cur==='pink'?'blue':'mix'));
  };

  /* ========== i18n ========== */
  const i18n={
    ja:{
      title:'KuKuãƒ‰ãƒªãƒ«', answerPH:'ã“ãŸãˆ',
      range:'å‡ºé¡Œç¯„å›²ï¼ˆã‹ã‘ã‚‰ã‚Œã‚‹æ•° Ã— ã‹ã‘ã‚‹æ•°ï¼‰', A:'ã‹ã‘ã‚‰ã‚Œã‚‹æ•°ï¼ˆæ®µï¼‰', B:'ã‹ã‘ã‚‹æ•°ï¼ˆ1ã€œ9ï¼‰',
      mode:'ãƒ¢ãƒ¼ãƒ‰', modeP:'ç­”ãˆã‚’å…¥åŠ›ï¼ˆæ¨™æº–ï¼‰', modeMB:'â–¡ Ã— B = ?ï¼ˆå·¦ã‚’å…¥åŠ›ï¼‰', modeMA:'A Ã— â–¡ = ?ï¼ˆå³ã‚’å…¥åŠ›ï¼‰',
      timer:'ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯', notStarted:'æœªé–‹å§‹', startQ:'ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ', startDesc:'é¸æŠã—ãŸæœ¬æ•°ã§é–‹å§‹ã—ã¾ã™ã€‚',
      ok:'OK', cancel:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', score:'ã‚¹ã‚³ã‚¢', streak:'ã‚Œã‚“ã•', avg:'å¹³å‡ã‚¿ã‚¤ãƒ ', history:'å±¥æ­´',
      q15:'15å•', q30:'30å•', q60:'60å•', q81:'99(81å•)ãƒ©ãƒ³ãƒ€ãƒ ', qFree:'ç„¡åˆ¶é™', best:'Best: â€”',
      speak:'èª­ã¿ä¸Šã’', sfx:'åŠ¹æœéŸ³', cheer:'å¿œæ´', settings:'è©³ç´°è¨­å®š', close:'é–‰ã˜ã‚‹',
      sound:'ã‚µã‚¦ãƒ³ãƒ‰', lang:'è¨€èªè¨­å®š', tog:'èª­ã¿ä¸Šã’ / åŠ¹æœéŸ³ / å¿œæ´', bg:'èƒŒæ™¯ç”»åƒ', bright:'æ˜ã‚‹ã•', hardReset:'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ',
      pickBg:'èƒŒæ™¯ç”»åƒ', resetBg:'èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ', footer:'Â© KuKuãƒ‰ãƒªãƒ«',
      faceTitle:'å¿œæ´ã®é¡”ã‚’æ’®å½±', faceHint:'ä¸¸æ ã«é¡”ã‚’å…¥ã‚Œã¦ã­ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿ã€‚', faceSet:'é¡”ã‚’è¨­å®š', faceDel:'é¡”ã‚’å‰Šé™¤',
      correct:t=>`æ­£è§£ï¼ ${t.toFixed(1)}ç§’`, wrong:ans=>`ã–ã‚“ã­ã‚“â€¦ æ­£è§£ã¯ ${ans}`,
      remainOk:n=>`ã®ã“ã‚Š ${n} å•ï¼ˆãƒŸã‚¹ãªã—ï¼‰`, remainNg:n=>`ã®ã“ã‚Š ${n} å•ï¼ˆãƒŸã‚¹ã‚ã‚Šï¼šè¨˜éŒ²å¤–ï¼‰`,
      runDone:n=>`${n}å• å®Œèµ°ï¼`, runInvalid:`é€”ä¸­ã§ã¾ã¡ãŒã„ãŒã‚ã£ãŸãŸã‚ã€ã“ã®å›ã¯è¨˜éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚`,
      runFree:`ç„¡åˆ¶é™ãƒ¢ãƒ¼ãƒ‰çµæœ`, runFreeBody:(q,sec,pt)=>`è§£ã„ãŸæ•°: ${q}å• / æ‰€è¦ ${sec.toFixed(1)}ç§’ / ${pt}ç‚¹ï¼ˆè¨˜éŒ²å¯¾è±¡å¤–ï¼‰`,
      bestLabel:(sec,score,date)=>`Best: ${sec.toFixed(1)}ç§’ / ${score}ç‚¹ï¼ˆ${date}ï¼‰`,
      speakProb:(a,b)=>`${a} ã‹ã‘ã‚‹ ${b}`, speakStart:'ã‚¹ã‚¿ãƒ¼ãƒˆ',
      histTitle:'å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰', clearHistory:'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢'
    },
    en:{
      title:'KuKu Drill', answerPH:'answer',
      range:'Range (Multiplicand Ã— Multiplier)', A:'Multiplicand (tables)', B:'Multiplier (1â€“9)',
      mode:'Mode', modeP:'Enter product (default)', modeMB:'â–¡ Ã— B = ? (fill left)', modeMA:'A Ã— â–¡ = ? (fill right)',
      timer:'Time Trial', notStarted:'Not started', startQ:'Ready to start?', startDesc:'Start with selected number of problems.',
      ok:'OK', cancel:'Cancel', score:'Score', streak:'Streak', avg:'Avg time', history:'History',
      q15:'15', q30:'30', q60:'60', q81:'All 9Ã—9 Random', qFree:'âˆ', best:'Best: â€”',
      speak:'TTS', sfx:'SFX', cheer:'Cheer', settings:'Settings', close:'Close',
      sound:'Sound', lang:'Language', tog:'TTS / SFX / Cheer', bg:'Background', bright:'Brightness', hardReset:'Reset ALL data',
      pickBg:'Pick image', resetBg:'Reset background', footer:'Â© KuKu Drill',
      faceTitle:'Take cheering face', faceHint:'Fit your face in the round frame. Local only.', faceSet:'Set face', faceDel:'Remove face',
      correct:t=>`Correct! ${t.toFixed(1)}s`, wrong:ans=>`Oopsâ€¦ answer is ${ans}`,
      remainOk:n=>`${n} left (no miss)`, remainNg:n=>`${n} left (miss: no record)`,
      runDone:n=>`${n}Q Completed!`, runInvalid:`Record void due to a mistake.`,
      runFree:`Unlimited Result`, runFreeBody:(q,sec,pt)=>`Solved: ${q} / ${sec.toFixed(1)}s / ${pt}pts (not recorded)`,
      bestLabel:(sec,score,date)=>`Best: ${sec.toFixed(1)}s / ${score}pts (${date})`,
      speakProb:(a,b)=>`${a} times ${b}`, speakStart:'Start',
      histTitle:'History (last 10)', clearHistory:'Clear history'
    }
  };
  let appLang=localStorage.getItem('kukuLang')||'ja';
  const el = {
    titleTxt:$('titleTxt'), ans:$('answer'),
    labScore:$('labScore'), labStreak:$('labStreak'), labAvg:$('labAvg'),
    rngTitle:$('rngTitle'), labA:$('labA'), labB:$('labB'),
    labMode:$('labMode'), timerLabel:$('timerLabel'), timerStatus:$('timerStatus'),
    modeP:$('modeP'), modeMB:$('modeMB'), modeMA:$('modeMA'),
    best15:$('best15'), best30:$('best30'), best60:$('best60'), best81:$('best81'),
    timer15:$('timer15'), timer30:$('timer30'), timer60:$('timer60'), timer81:$('timer81'), timerFree:$('timerFree'),
    openHistory:$('openHistory'),
    openSettings:$('openSettings'), closeSettings:$('closeSettings'),
    secSound:$('secSound'), secLang:$('secLang'), secTog:$('secTog'), secBg:$('secBg'), secBright:$('secBright'),
    bgPick:$('bgPick'), bgReset:$('bgReset'),
    faceBtn:$('faceBtn'), faceDel:$('faceDel'),
    togSpeak: $('togSpeak'),
    togSfx:   $('togSfx'),
    togCheer: $('togCheer'),
    hardResetBtn: $('hardResetBtn')
  };

  function txt(node, s){ if(node) node.textContent=s; }
  function updateLangUI(){
    const t=i18n[appLang];
    document.documentElement.lang=(appLang==='ja'?'ja':'en');
    txt(el.titleTxt, t.title); el.ans.placeholder=t.answerPH;
    txt(el.labScore,t.score); txt(el.labStreak,t.streak); txt(el.labAvg,t.avg);
    txt(el.rngTitle,t.range); txt(el.labA,t.A); txt(el.labB,t.B);
    txt(el.labMode,t.mode); txt(el.modeP,t.modeP); txt(el.modeMB,t.modeMB); txt(el.modeMA,t.modeMA);
    txt(el.timerLabel, t.timer); el.timerStatus.textContent=t.notStarted;
    txt(el.timer15, t.q15); txt(el.timer30, t.q30); txt(el.timer60, t.q60); txt(el.timer81, t.q81); txt(el.timerFree, t.qFree);
    txt(el.best15, t.best); txt(el.best30, t.best); txt(el.best60, t.best); txt(el.best81, t.best);
    txt(el.openHistory, t.history);
    // settings & buttons
    txt(el.openSettings, t.settings); txt(el.closeSettings, t.close);
    txt(el.secSound, t.sound); txt(el.secLang, t.lang); txt(el.secTog, t.tog); txt(el.secBg, t.bg); txt(el.secBright, t.bright);
    txt(el.bgPick, t.pickBg); txt(el.bgReset, t.resetBg);
    if(resetBtn) txt(resetBtn, appLang==='ja'?'ãƒªã‚»ãƒƒãƒˆ':'Reset');
     if (el.hardResetBtn) txt(el.hardResetBtn, t.hardReset);   // â† è¿½åŠ 
    // face texts
    $('faceTitle').textContent = t.faceTitle; $('faceHint').textContent = t.faceHint;
    txt(el.faceBtn, t.faceSet); txt(el.faceDel, t.faceDel);
    // start/result labels
    $('startTitle').textContent=t.startQ; $('startDesc').textContent=t.startDesc;
    $('startCancel').textContent=t.cancel; $('startGo').textContent=t.ok;
    $('rpShare').textContent=(appLang==='ja'?'å…±æœ‰':'Share'); $('rpCopy').textContent=(appLang==='ja'?'ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼':'Copy text'); $('rpClose').textContent=t.ok;
    $('histTitle').textContent=t.histTitle; $('clearHistory').textContent=t.clearHistory; $('historyClose').textContent=t.close;
    document.querySelector('footer').textContent=t.footer;
    // â–¼ãƒˆã‚°ãƒ«ã®ãƒ©ãƒ™ãƒ«ã‚‚è¨€èªã«åˆã‚ã›ã¦æ›´æ–°
    txt(el.togSpeak, t.speak);
    txt(el.togSfx,   t.sfx);
    txt(el.togCheer, t.cheer);
    // lang pills active
    document.querySelectorAll('#langSet .pill').forEach(b=>b.classList.toggle('active', b.dataset.lang===appLang));
    localStorage.setItem('kukuLang', appLang);
    initVoices();
  }
  $('langSet').addEventListener('click', e=>{
    const t=e.target.closest('button'); if(!t) return;
    appLang=t.dataset.lang; updateLangUI();
  });

  /* ========== èƒŒæ™¯ã®æ—¢å®šSVGï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ ========= */
  function injectDefaultNeon(){
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 220 220'>
      <defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%23ff4dc4'/><stop offset='1' stop-color='%233bc7ff'/></linearGradient></defs>
      <rect width='100%' height='100%' fill='black'/>
      <g opacity='0.12' stroke='url(%23g)'><path d='M-40 220 L 260 -40'/><path d='M-20 240 L 280 -20'/><path d='M0 260 L 300 0'/></g></svg>`;
    document.documentElement.style.setProperty('--neon-wall', `url('data:image/svg+xml;utf8,${encodeURIComponent(svg)}')`);
  }
  injectDefaultNeon();

  /* ========== èƒŒæ™¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”»åƒ ========= */
  const bgPick=$('bgPick'), bgReset=$('bgReset'), bgFile=$('bgFile'), bgBright=$('bgBright');
function setWallBackground(uri){
  document.documentElement.style.setProperty('--neon-wall', uri);
  const wall = document.querySelector('.wall');
  if (wall) wall.style.backgroundImage = uri;
}
function clearWallInline(){
  const wall = document.querySelector('.wall');
  if (wall) wall.style.backgroundImage = ''; // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚’æ¶ˆã™
}
function validUserBg(){
  const d = localStorage.getItem('neonWallData');
  return !!(d && d.indexOf('data:image')===0);
}
function applySavedOrDefaultWall(){
  const saved = localStorage.getItem('neonWallData');
  if (validUserBg()){
    setWallBackground("url('"+saved+"')");
  }else{
    // æ—¢å®šSVGã‚’CSSå¤‰æ•°ã¸ã‚»ãƒƒãƒˆã—ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã¯æ¶ˆã™
    injectDefaultNeon();
    clearWallInline();
  }
  const savedOp = localStorage.getItem('neonWallOpacity');
  if (savedOp){
    document.documentElement.style.setProperty('--wallOpacity', savedOp);
    bgBright.value = Math.round(parseFloat(savedOp)*100);
  }
}
bgReset.onclick = ()=>{
  localStorage.removeItem('neonWallData');
  applySavedOrDefaultWall();
  alert(appLang==='ja'?'èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ':'Background reset');
};
  bgBright.oninput=()=>{ const v=Math.max(0,Math.min(100,parseInt(bgBright.value||'36',10)))/100; document.documentElement.style.setProperty('--wallOpacity', String(v)); localStorage.setItem('neonWallOpacity', String(v)); };
  // â–¼ ç”»åƒé¸æŠã®ãƒãƒ³ãƒ‰ãƒ©ãŒæ¶ˆãˆã¦ã„ãŸã®ã§å¾©æ´»
bgPick.onclick = ()=> bgFile.click();

bgFile.onchange = (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    // DataURL ã‚’ä¿å­˜ & ã™ãåæ˜ 
    try{
      localStorage.setItem('neonWallData', r.result);
    }catch(_){}
    setWallBackground("url('"+r.result+"')");
  };
  r.readAsDataURL(f);
};
  applySavedOrDefaultWall();

  /* ========== SFX / TTS ========= */
  const AudioCtx=window.AudioContext||window.webkitAudioContext; const audio=AudioCtx?new AudioCtx():null;
  function ensureAudio(){ if(audio && audio.state==='suspended') audio.resume(); }
  let currentPack=localStorage.getItem('kukuSoundPack')||'synth';
  function setSoundPack(p){ currentPack=p; localStorage.setItem('kukuSoundPack', p);
    document.querySelectorAll('#soundPack .opt').forEach(o=>o.classList.toggle('active', o.dataset.pack===p));
  }
  setSoundPack(currentPack);
  $('soundPack').addEventListener('click', e=>{ const t=e.target.closest('.opt'); if(!t) return; setSoundPack(t.dataset.pack); pop(); });

  function tone(f,t,type,gain=.95){ if(!audio||!getFlag('sfx')) return; const o=audio.createOscillator(), g=audio.createGain(); o.type=type; o.frequency.value=f; o.connect(g).connect(audio.destination); const now=audio.currentTime; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(gain,now+.02); g.gain.exponentialRampToValueAtTime(.0001, now+t); o.start(); o.stop(now+t+.02); }
  function pop(){ ensureAudio(); if(currentPack==='cute') tone(880,.09,'triangle'); else if(currentPack==='edm') tone(520,.06,'sawtooth'); else tone(900,.08,'sine'); }
  function buzz(){ ensureAudio(); tone(120,.32,'sawtooth',.7); setTimeout(()=>tone(110,.22,'square',.6),80); }
    function pinpon(){ ensureAudio(); tone(1319,.12,'sine'); setTimeout(()=>tone(1760,.16,'sine'),120); }

  /* ========== TTSï¼ˆå¥³æ€§å„ªå…ˆï¼‰ ========== */
  let preferredVoice=null, FEMALE=/Kyoko|Mizuki|Nanami|Nozomi|Samantha|Victoria|Allison|Zira|Amy|Emma|Joanna|Female|å¥³/i;
  function pickVoice(lang){
    const vs=window.speechSynthesis?window.speechSynthesis.getVoices():[];
    const cand=vs.filter(v=>new RegExp(lang,'i').test(v.lang));
    if(!cand.length) return null;
    for(const v of cand){ if(FEMALE.test(v.name)) return v; }
    return cand[0];
  }
  function initVoices(){
    if(!window.speechSynthesis) return;
    preferredVoice=pickVoice(appLang==='ja'?'ja-JP':'en-US');
  }
  if(window.speechSynthesis){
    initVoices();
    window.speechSynthesis.onvoiceschanged=initVoices;
  }
  function speakText(txt){
    if(!window.speechSynthesis||!getFlag('speak')) return;
    const u=new SpeechSynthesisUtterance(txt);
    u.lang=(appLang==='ja'?'ja-JP':'en-US');
    if(preferredVoice && new RegExp(u.lang,'i').test(preferredVoice.lang)) u.voice=preferredVoice;
    u.rate=1.0; u.pitch=1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  /* ===== Confetti (paper fireworks) ===== */
  function confettiBurst(){
    const colors=['#ff4dc4','#3bc7ff','#ffe066','#35ffa1','#ff8af2','#a1a8ff'];
    const n=90;
    for(let i=0;i<n;i++){
      const d=document.createElement('div');
      d.className='confetti';
      d.style.left=(Math.random()*100)+'vw';
      d.style.background=colors[(Math.random()*colors.length)|0];
      d.style.transform='rotate('+(Math.random()*360)+'deg)';
      const dur=900+Math.random()*1200;
      d.style.transition=`transform ${dur}ms ease-out, top ${dur}ms ease-out, opacity ${dur}ms ease`;
      document.body.appendChild(d);
      requestAnimationFrame(()=>{
        d.style.top='110vh';
        d.style.transform+=` translateY(90vh) rotate(${360+Math.random()*360}deg)`;
        d.style.opacity='0.9';
      });
      setTimeout(()=>d.remove(), dur+400);
    }
  }
  /* ========== ãƒˆã‚°ãƒ«ï¼ˆpillã§ON/OFFï¼‰ ========= */
  function getFlag(k){ return localStorage.getItem('kukuFlag_'+k)!=='0'; }
  function setFlag(k,v){ localStorage.setItem('kukuFlag_'+k, v?'1':'0'); }
  function applyToggleUI(){
    ['speak','sfx','cheer'].forEach(k=>{
      const btn=document.querySelector(`.toggle[data-flag="${k}"]`);
      const on=getFlag(k); btn.classList.toggle('active', on);
    });
  }
  document.getElementById('toggles').addEventListener('click', e=>{
    const t=e.target.closest('.toggle'); if(!t) return;
    const key=t.dataset.flag; const next=!getFlag(key); setFlag(key,next); applyToggleUI(); pop();
  });
  applyToggleUI();

  /* ========== å‡ºé¡Œ ========= */
  const problem=$('problem'), ans=$('answer'), result=$('result');
  const scoreEl=$('score'), streakEl=$('streak'), avgTimeEl=$('avgTime');
  const modeSet=$('modeSet'), danSet=$('danSet'), kuSet=$('kuSet');
  let state={a:null,b:null,correct:null,start:null,score:0,streak:0,times:[],mode:'product'};
  let allowedA=new Set(JSON.parse(localStorage.getItem('allowedA')||'[1,2,3,4,5,6,7,8,9]'));
  let allowedB=new Set(JSON.parse(localStorage.getItem('allowedB')||'[1,2,3,4,5,6,7,8,9]'));
  
// ======== é‡è¤‡ãªã—å‡ºé¡Œã®ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========
// é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisherâ€“Yatesï¼‰
function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j=(Math.random()*(i+1))|0;
    [arr[i], arr[j]]=[arr[j], arr[i]];
  }
  return arr;
}

// allowedA Ã— allowedB ã®ç›´ç©ã‚’é…åˆ—ã«
function combosFromSets(Aset, Bset){
  const list=[];
  const a=Array.from(Aset).sort((x,y)=>x-y);
  const b=Array.from(Bset).sort((x,y)=>x-y);
  for(const x of a){ for(const y of b){ list.push([x,y]); } }
  return list;
}

// ãƒ©ãƒ³ï¼ˆã‚¿ã‚¤ãƒ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ï¼‰ç”¨ã®å•é¡Œã‚­ãƒ¥ãƒ¼ã‚’ç”¨æ„
// n===81 â†’ 1..9 Ã— 1..9 ã®81é€šã‚Šã‚’å¿…ãš1å›ãšã¤
// ãã‚Œä»¥å¤– â†’ ç¾åœ¨ã®allowedAÃ—allowedBã‹ã‚‰ n å€‹ã¶ã‚“ã‚’é‡è¤‡ãªã—ã§ï¼ˆä¸è¶³åˆ†ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§åŸ‹ã‚ã‚‹ï¼‰
function buildProblemQueue(n){
  let pool;
  if(n===81){
    pool=[];
    for(let a=1;a<=9;a++){ for(let b=1;b<=9;b++){ pool.push([a,b]); } }
  }else{
    pool=combosFromSets(allowedA, allowedB);
  }
  shuffle(pool);

  if(n===Infinity){
    // ç„¡åˆ¶é™ã¯ä½¿ã„åˆ‡ã£ãŸã‚‰å¾Œã§è£œå……
    return pool.slice();
  }

  if(pool.length===0) return [[1,1]];

  const q=[];
  while(q.length<n){
    if(q.length+pool.length<=n){ q.push(...pool); shuffle(pool); }
    else{ q.push(...pool.slice(0, n-q.length)); }
  }
  return q;
}
  function pillLabel(i,type){ return (type==='A') ? (appLang==='ja' ? (i+'æ®µ') : (i+'Ã—')) : String(i); }
  function buildPills(container,type){
    container.innerHTML=''; for(let i=1;i<=9;i++){ const btn=document.createElement('button'); btn.className='pill'+(((type==='A'?allowedA:allowedB).has(i))?' active':''); btn.textContent=pillLabel(i,type);
      btn.onclick=()=>{ const set=(type==='A'?allowedA:allowedB); if(set.has(i)) set.delete(i); else set.add(i); btn.classList.toggle('active'); localStorage.setItem(type==='A'?'allowedA':'allowedB', JSON.stringify(Array.from(set))); pop(); newProblem(); };
      container.appendChild(btn);
    }
  }
  buildPills(danSet,'A'); buildPills(kuSet,'B');
  modeSet.addEventListener('click', e=>{
    const t=e.target.closest('.pill'); if(!t) return;
    [...modeSet.querySelectorAll('.pill')].forEach(p=>p.classList.remove('active'));
    t.classList.add('active'); state.mode=t.dataset.mode; pop(); newProblem();
  });

  function randFrom(set){ const a=Array.from(set); return a.length?a[Math.floor(Math.random()*a.length)]:1; }
  function newProblem(skipFocus){
  // ã‚¿ã‚¤ãƒ ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­ã§ã‚­ãƒ¥ãƒ¼ãŒã‚ã‚‹ãªã‚‰ãã“ã‹ã‚‰å‡ºã™
  if(run && Array.isArray(run.queue) && run.queue.length){
    const idx = run.isUnlimited ? 0 : (run.target - run.left); // 0å§‹ã¾ã‚Šã®ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    const pair = run.queue[idx] || run.queue[0];
    state.a = pair[0]; state.b = pair[1];
  }else{
    // é€šå¸¸å‡ºé¡Œï¼šé¸æŠç¯„å›²ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 
    state.a = randFrom(allowedA);
    state.b = randFrom(allowedB);
  }

  state.correct = state.a * state.b;
  const m = state.mode;
  problem.textContent = (m==='product')
    ? `${state.a} Ã— ${state.b} = ?`
    : (m==='missingB') ? `â–¡ Ã— ${state.b} = ${state.correct}`
    : `${state.a} Ã— â–¡ = ${state.correct}`;

  state.start = performance.now();
  ans.value = '';
  if(!skipFocus) ans.blur();

  // èª­ã¿ä¸Šã’ï¼ˆæ—¢å­˜ã®å‡¦ç†ãã®ã¾ã¾ï¼‰
  speakText(i18n[appLang].speakProb(state.a, state.b));
}
  function answerText(){ return (state.mode==='product')?state.correct:(state.mode==='missingB'?state.a:state.b); }
  function updateStats(){ scoreEl.textContent=state.score; streakEl.textContent=state.streak; const n=state.times.length; avgTimeEl.textContent=n? ((state.times.reduce((a,b)=>a+b,0)/n).toFixed(1)+(appLang==='ja'?'ç§’':'s')):'â€”'; }
  function showMsg(t,ok){ result.textContent=t; result.className='result '+(ok?'ok':'ng'); }

  document.querySelectorAll('.keypad .key').forEach(k=>{
    k.onclick=()=>{
      ensureAudio();
      const v=k.textContent.trim();
      if(v==='âŒ«'){ ans.value=ans.value.slice(0,-1); pop(); return; }
      if(k.id==='okKey'){ check(); return; }
      ans.value += v; pop();
    };
  });

  /* ========== ã‚¿ã‚¤ãƒ ãƒˆãƒ©ã‚¤ã‚¢ãƒ« ========= */
  const timerStatus=$('timerStatus'), bestEls={15:$('best15'),30:$('best30'),60:$('best60'),81:$('best81')};
  function rHist(n){ try{return JSON.parse(localStorage.getItem('historyRun'+n)||'[]')}catch(e){return[]} }
  function wHist(n,a){ localStorage.setItem('historyRun'+n, JSON.stringify(a)); }
  function addHistory(n,e){ const a=rHist(n); a.unshift(e); if(a.length>50) a.pop(); wHist(n,a); }
  function bestOf(n){ const a=rHist(n).filter(x=>x.valid); if(!a.length) return null; return a.reduce((p,c)=>p.sec<=c.sec?p:c); }
  function fmt(iso){ const d=new Date(iso); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`; }
  function renderBests(){
    const t=i18n[appLang]; [15,30,60,81].forEach(n=>{ const b=bestOf(n); bestEls[n].textContent=b? t.bestLabel(b.sec,b.score,fmt(b.date)) : t.best; });
  }
  renderBests();

  let run=null;
function beginRun(n){
  if(n===81){
    run = {
      target:81, left:81, isUnlimited:false, isAllKuku:true,
      queue: buildProblemQueue(81), hasMiss:false,
      startAt: performance.now(), scoreStart: state.score
    };
  } else if(n===Infinity){
    run = {
      target:Infinity, left:Infinity, isUnlimited:true, isAllKuku:false,
      queue: buildProblemQueue(Infinity), hasMiss:false,
      startAt: performance.now(), scoreStart: state.score, pos:0
    };
  } else {
    run = {
      target:n, left:n, isUnlimited:false, isAllKuku:false,
      queue: buildProblemQueue(n), hasMiss:false,
      startAt: performance.now(), scoreStart: state.score
    };
  }
  // UIæ›´æ–°ï¼†æœ€åˆã®å‡ºé¡Œ
  timerStatus.textContent = (appLang==='ja')
    ? `ã®ã“ã‚Š ${run.left} å•ï¼ˆãƒŸã‚¹ãªã—ï¼‰`
    : `left ${run.left} (no miss)`;
  newProblem(true);
}
  function beginUnlimited(){ const t=i18n[appLang]; run={target:Infinity,left:Infinity,isUnlimited:true,hasMiss:false,startAt:performance.now(),scoreStart:state.score}; timerStatus.textContent=(appLang==='ja'?'ç„¡åˆ¶é™ãƒ¢ãƒ¼ãƒ‰ä¸­':'Unlimited'); }

function finishRun(){
  const t=i18n[appLang];
  const elapsed=(performance.now()-run.startAt)/1000;

  // ä»Šå›ã®ç²å¾—ç‚¹ï¼ˆ= æ­£è§£æ•°Ã—10ï¼‰
  const gained = state.score - run.scoreStart;
  const solved = Math.max(0, Math.round(gained/10)); // æ­£è§£æ•°
  const total  = run.isUnlimited ? solved : run.target;

  // â–¼å…¨å•æ­£è§£ã®ãƒ•ãƒ©ã‚°ï¼ˆç„¡åˆ¶é™ã¯ falseï¼‰
  const allOk = (!run.isUnlimited) && (!run.hasMiss) && (solved === total);

  let title, body, shareText;

  if (run.isUnlimited) {
    title=t.runFree;
    body=t.runFreeBody((gained/10), elapsed, gained);
    shareText=`KuKu: Free ${(gained/10)} Q, â±${elapsed.toFixed(1)}s / ${gained}pts`;
  } else {
    const rec = {
      sec: elapsed,
      score: gained,
      correct: solved,
      total: total,
      valid: allOk,                 // ãƒ™ã‚¹ãƒˆç®—å‡ºå¯¾è±¡ã¯ã€Œå…¨å•æ­£è§£ã®ã¿ã€
      date: new Date().toISOString()
    };
    addHistory(run.target, rec);
    renderBests();

    title = t.runDone(run.target);

    if (allOk) {
      // â˜… å…¨å•æ­£è§£ã®ã¨ãã ã‘ç¥ç ²
      pinpon();
      confettiBurst();

      const best = bestOf(run.target);
      body = (appLang==='ja')
        ? `ä»Šå›: ${rec.sec.toFixed(1)}ç§’ / ${rec.score}ç‚¹ / ${rec.correct}/${rec.total}ï¼ˆ${fmt(rec.date)}ï¼‰`
        : `This run: ${rec.sec.toFixed(1)}s / ${rec.score}pts / ${rec.correct}/${rec.total} (${fmt(rec.date)})`;
      if (best) {
        body += (appLang==='ja')
          ? `\nè‡ªå·±ãƒ™ã‚¹ãƒˆ: ${best.sec.toFixed(1)}ç§’ / ${best.score}ç‚¹ï¼ˆ${fmt(best.date)}ï¼‰`
          : `\nPersonal Best: ${best.sec.toFixed(1)}s / ${best.score}pts (${fmt(best.date)})`;
      }
      shareText=(appLang==='ja')
        ? `KuKu ${run.target}å• å…¨å•æ­£è§£ï¼ â±${rec.sec.toFixed(1)}ç§’ / ${rec.score}ç‚¹`
        : `KuKu ${run.target}Q All Correct! â±${rec.sec.toFixed(1)}s / ${rec.score}pts`;
    } else {
      // ãƒŸã‚¹ã‚ã‚Šï¼ˆç¥ç ²ãªã—ï¼‰
      body = (appLang==='ja')
        ? `ä»Šå›: ${rec.sec.toFixed(1)}ç§’ / ${rec.score}ç‚¹ / ${rec.correct}/${rec.total}\n${t.runInvalid}`
        : `This run: ${rec.sec.toFixed(1)}s / ${rec.score}pts / ${rec.correct}/${rec.total}\n${t.runInvalid}`;
    }
  }

  $('rpTitle').textContent=title;
  $('rpBody').textContent=body;
  $('resultModal').classList.add('show');

  const close=()=>$('resultModal').classList.remove('show');
  $('rpClose').onclick=close;
  $('resultModal').querySelector('.back').onclick=close;
  $('rpCopy').onclick=()=>{
    if(navigator.clipboard){
      navigator.clipboard.writeText(shareText||body).catch(()=>{});
    }
  };
  $('rpShare').onclick=()=>{
    if(navigator.share){ navigator.share({text:shareText||body}).catch(()=>{}); }
    else { $('rpCopy').click(); }
  };

  run=null;
  $('timerStatus').textContent=i18n[appLang].notStarted;
}
function openStart(n){
  const startM = $('startModal');
  const descEl = $('startDesc');
  const countEl = $('countNum');

  startM.classList.add('show');
  // èª¬æ˜æ–‡ï¼ˆæ—¥æœ¬èª/è‹±èªã¨æœ¬æ•°ã§å‡ºã—åˆ†ã‘ï¼‰
  const desc = (appLang==='ja')
    ? (n===Infinity ? 'ç„¡åˆ¶é™ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚'
       : (n===81 ? '99(81å•)ãƒ©ãƒ³ãƒ€ãƒ ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚' : (n+'å•ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚')))
    : (n===Infinity ? 'Start Unlimited.'
       : (n===81 ? 'Start All 9Ã—9 Random.' : ('Start with '+n+' questions.')));
  descEl.textContent = desc;

  countEl.textContent = 'â±';           // åˆæœŸè¡¨ç¤º
  countEl.classList.remove('pop-grow'); // ã‚¢ãƒ‹ãƒ¡åˆæœŸåŒ–

  const close = ()=>{ startM.classList.remove('show'); };
  $('startCancel').onclick = close;
  startM.querySelector('.back').onclick = close;

  $('startGo').onclick = ()=>{
    // â–¼OKã‚’æŠ¼ã—ãŸã‚‰ 3â†’2â†’1 ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼ˆâ€œãƒ”ãƒƒâ€éŸ³ã®ã¿ãƒ»TTSãªã—ï¼‰
    // éŸ³ã¯æ—¢å­˜ã® SFX/tone() ã‚’ä½¿ç”¨ã€‚SFXãŒOFFãªã‚‰ç„¡éŸ³ã§é€²ã‚€ã€‚
    let i = 0;
    const seq = ['3','2','1'];

    // ã‚«ã‚¦ãƒ³ãƒˆã‚’1ã¤é€²ã‚ã‚‹é–¢æ•°
    const tick = ()=>{
      countEl.textContent = seq[i];
      countEl.classList.remove('pop-grow');  // ã‚¢ãƒ‹ãƒ¡ã‚’ã‚„ã‚Šç›´ã™ãŸã‚ã®å†ä»˜ä¸
      void countEl.offsetWidth;
      countEl.classList.add('pop-grow');

      // ãƒ”ãƒƒéŸ³ï¼ˆçŸ­ã„ãƒ“ãƒ¼ãƒ—ï¼‰
      ensureAudio();
      tone(700, .12, 'sine', 0.9);

      i++;
      if(i < seq.length){
        setTimeout(tick, 650);  // æ¬¡ã®æ•°å­—ã¸
      }else{
        setTimeout(()=>{
          // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å®Œäº† â†’ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã€ãƒ©ãƒ³é–‹å§‹ï¼†æœ€åˆã®å•é¡Œç”Ÿæˆ
          close();
          if(n===Infinity) beginUnlimited(); else beginRun(n);
          newProblem(true);
        }, 650);
      }
    };

    // ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹
    countEl.textContent = 'â±';
    setTimeout(tick, 220);
  };
}
  $('timer15').onclick=()=>openStart(15);
  $('timer30').onclick=()=>openStart(30);
  $('timer60').onclick=()=>openStart(60);
  $('timer81').onclick=()=>openStart(81);
  $('timerFree').onclick=()=>openStart(Infinity);

  /* ========== ãƒã‚§ãƒƒã‚¯ ========= */
  function showMascot(kind){
    if(!getFlag('cheer')) return;
    const shotData=localStorage.getItem('kukuFaceData'); if(!shotData) return;
    const box=document.createElement('div'); box.className='mascot '+(kind==='cry'?'cry':'cheer');
    const img=new Image(); img.src=shotData; box.appendChild(img); document.body.appendChild(box);
    if(kind==='cry'){
      const t1=document.createElement('div'); t1.className='tear left';
      const t2=document.createElement('div'); t2.className='tear right';
      box.appendChild(t1); box.appendChild(t2);
      setTimeout(()=>{ t1.style.top='70px'; t2.style.top='70px'; t1.style.transition=t2.style.transition='top 600ms ease'; },10);
    }
    setTimeout(()=>box.remove(),2600);
  }

  function check(){
    const t=i18n[appLang]; const val=parseInt(ans.value,10);
    if(isNaN(val)){ showMsg(appLang==='ja'?'æ•°å­—ã‚’å…¥ã‚Œã¦ã­':'Enter numbers', false); buzz(); return; }
    const ok=(state.mode==='product')? val===state.correct : (state.mode==='missingB'? val===state.a : val===state.b);
    const took=(performance.now()-state.start)/1000; state.times.push(took); if(state.times.length>50) state.times.shift();
    if(ok){ state.score+=10; state.streak+=1; showMsg(t.correct(took), true); pinpon(); showMascot('cheer'); }
    else { state.streak=0; showMsg(t.wrong(answerText()), false); buzz(); showMascot('cry'); if(run && !run.isUnlimited){ run.hasMiss=true; } }

        if (run && !run.isUnlimited) {
      run.left--;
      if (run.left > 0) {
        timerStatus.textContent = run.hasMiss
          ? i18n[appLang].remainNg(run.left)
          : i18n[appLang].remainOk(run.left);
        updateStats();
        setTimeout(newProblem, 450);
      } else {
        finishRun();
      }
      return;

    // â–¼ç„¡åˆ¶é™ï¼ˆrun ãŒå­˜åœ¨ã—ã€ã‹ã¤ isUnlimitedï¼‰ã®ã¨ãã ã‘ã“ã¡ã‚‰
    } else if (run && run.isUnlimited) {
      if (typeof run.pos !== 'number') run.pos = 0;
      run.pos++;

      // ã‚‚ã†ã™ãå°½ãã‚‹ãªã‚‰è£œå……
      if (run.queue && run.queue.length) {
        if (run.pos + 1 >= run.queue.length) {
          run.queue = run.queue.concat(buildProblemQueue(Infinity));
        }
      }

      updateStats();
      setTimeout(newProblem, 450);
      return;

    // â–¼é€šå¸¸ç·´ç¿’ï¼ˆrun ãŒãªã„ï¼‰
    } else {
      updateStats();
      setTimeout(newProblem, 450);
      return;
    }
    }
  ans.addEventListener('focus', ()=>ans.blur());

  // ========== å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
  // å±¥æ­´ã®èª­ã¿å‡ºã—ï¼ˆå®‰å…¨ã«ï¼‰
  function readHistory(n){
    try { return JSON.parse(localStorage.getItem('historyRun'+n) || '[]'); }
    catch(e){ return []; }
  }

// ==== å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸€å¼ï¼ˆè¦‹å‡ºã—/æœ¬æ–‡ãƒ»ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ãƒ»ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ï¼‰ ====

function renderHistory(){
  const t = i18n[appLang];
  function z(n){ return String(n).padStart(2,'0'); }
  function fmt(iso){
    const d = new Date(iso);
    return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
  }
  function readHistory(n){
    try{ return JSON.parse(localStorage.getItem('historyRun'+n))||[]; }catch(e){ return []; }
  }
function section(n){
  const list = readHistory(n).slice(0, 10);
  const best = (function(){
    const a = readHistory(n).filter(x => x.valid);
    if (!a.length) return null;
    return a.reduce((p,c)=> p.sec <= c.sec ? p : c);
  })();

  const rows = list.map(h=>{
    const okRatio = (h.correct!=null && h.total!=null) ? `${h.correct}/${h.total}` : '';
    const isBest = !!best && h.valid && h.sec === best.sec && h.score === best.score && h.date === best.date;
    return `
      <tr class="${isBest?'best-row':''} ${(!h.valid?'miss-row':'')}">
        <td>${fmt(h.date)}</td>
        <td>${(h.sec!=null)?h.sec.toFixed(1):''}</td>
        <td>${h.score!=null?h.score:''}</td>
        <td>${okRatio}</td>
        <td>${isBest?'<span class="best-badge">â­ï¸</span>':''}</td>
      </tr>`;
  }).join('');

  const empty = `<tr><td colspan="5" class="small">${appLang==='ja'?'ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“':'No records yet'}</td></tr>`;
  const title = (appLang==='ja') ? `${n}å•` : `${n}Q`;

  return `
    <div class="table-wrap">
      <h4 class="small hist-section-title" style="margin:10px 0 6px">${title}</h4>
      <table class="history-table">
        <thead>
          <tr>
            <th>${appLang==='ja'?'æ—¥æ™‚':'Date'}</th>
            <th>${appLang==='ja'?'ç§’':'Sec'}</th>
            <th>${appLang==='ja'?'ç‚¹':'Pts'}</th>
            <th>${appLang==='ja'?'æ­£è§£æ•°/å…¨':'Solved/Total'}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows || empty}</tbody>
      </table>
    </div>`;
} 
// è¦‹å‡ºã—ã¨æœ¬æ–‡
  $('histTitle').textContent = (appLang==='ja'?'å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰':'History (last 10)');
  $('historyContent').innerHTML = section(15)+section(30)+section(60)+section(81);
  // ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«
  $('clearHistory').textContent = (appLang==='ja'?'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢':'Clear history');
  $('historyClose').textContent  = (appLang==='ja'?'é–‰ã˜ã‚‹':'Close');
}

// ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ï¼ˆé‡è¤‡ãªã1å›ã ã‘ï¼‰
$('openHistory').onclick = function(){
  renderHistory();
  $('historyModal').classList.add('show');
};
$('historyClose').onclick = function(){
  $('historyModal').classList.remove('show');
};
$('historyModal').querySelector('.back').onclick = function(){
  $('historyModal').classList.remove('show');
};

// ===== ã‚¯ãƒªãƒƒã‚¯å¯¾ç­–ï¼špointerup / touchend / click ã‚’ã™ã¹ã¦æ‹¾ã†ï¼ˆé‡è¤‡å‘¼ã³å‡ºã—é˜²æ­¢ã¤ãï¼‰ =====
function onTap(el, handler){
  if(!el) return;
  let lock = false;
  const wrap = (e)=>{
    if (lock) return;
    lock = true;
    try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
    handler(e);
    setTimeout(()=>{ lock = false; }, 300); // äºŒé‡ç™ºç«é˜²æ­¢
  };
  ['pointerup','touchend','click'].forEach(ev=>{
    el.addEventListener(ev, wrap, {passive:false});
  });
}

function askConfirm(msg){
  // confirm ãŒä½¿ãˆãªã„ç’°å¢ƒã§ã‚‚å‡¦ç†ã¯é€²ã‚ã‚‹ï¼ˆtrue ã‚’è¿”ã™ï¼‰
  try { return window.confirm(msg); } catch(e){ return true; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å±¥æ­´ã‚¯ãƒªã‚¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var clearBtn = document.getElementById('clearHistory');

function handleClearHistory(e){
  try{ e && e.preventDefault(); e && e.stopPropagation(); }catch(_){}
  const msg = (appLang==='ja'
    ? 'å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒ™ã‚¹ãƒˆè¡¨ç¤ºã‚‚æ¶ˆãˆã¾ã™ï¼‰'
    : 'Clear all history (also clears bests)?');
  if(!askConfirm(msg)) return false;

  const kill = k => { try{ localStorage.removeItem(k); }catch(_){ } };
  [15,30,60,81].forEach(n=> kill('historyRun'+n));

  // å¤ã„ã‚­ãƒ¼ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã‚‚æƒé™¤
  try{
    Object.keys(localStorage).forEach(k=>{
      if (/^(history|hist|best)/i.test(k)) kill(k);
    });
  }catch(_){}

  // ç©ºé…åˆ—ã‚’å†ã‚»ãƒƒãƒˆï¼ˆãƒ‘ãƒ¼ã‚¹å‰æã®å ´æ‰€ãŒã‚ã‚‹ãŸã‚ï¼‰
  [15,30,60,81].forEach(n=>{
    try{ localStorage.setItem('historyRun'+n, '[]'); }catch(_){}
  });

  // UI åæ˜ 
  renderBests();
  renderHistory();

  // ç”»é¢ä¸Šã§ã‚‚åæ˜ ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«
  try { alert(appLang==='ja'?'å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ':'History cleared'); } catch(_){}
  return false;
}
onTap(clearBtn, handleClearHistory);

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const hardResetBtn = document.getElementById('hardResetBtn');

function handleHardReset(){
  const msg = (appLang==='ja'
    ? 'ã€ç¢ºèªã€‘ã‚¹ã‚³ã‚¢ãƒ»å±¥æ­´ãƒ»ãƒ™ã‚¹ãƒˆãƒ»è¨­å®šãƒ»èƒŒæ™¯ç”»åƒãƒ»å¿œæ´ã®é¡”ãªã©ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ'
    : 'CONFIRM: Delete ALL data (scores, history, bests, settings, bg, face). This cannot be undone. Proceed?');
  if(!askConfirm(msg)) return;

  try{ localStorage.clear(); }catch(_){}
  // å†æç”»ï¼ˆreload ãŒç„¡è¦–ã•ã‚Œã‚‹ç’°å¢ƒå‘ã‘ã«äºŒæ®µæ§‹ãˆï¼‰
  try{ location.reload(); }catch(_){}
  try{ window.location.href = window.location.href; }catch(_){}
}
onTap(hardResetBtn, handleHardReset);

  /* ========== é¡”ï¼ˆå¿œæ´ï¼‰ ========= */
  let stream=null;

  // ãƒ©ã‚¤ãƒ–/é™æ­¢ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆ
  function showLivePreview(isLive){
    const v = $('cam');
    const c = $('shot');
    if(isLive){
      v.style.display = 'block';
      c.style.display = 'none';
      $('faceSave').disabled = true;
      $('faceTake').textContent = (appLang==='ja' ? 'æ’®å½±' : 'Snap');
    }else{
      v.style.display = 'none';
      c.style.display = 'block';
      $('faceSave').disabled = false;
      $('faceTake').textContent = (appLang==='ja' ? 'æ’®ã‚Šç›´ã—' : 'Retake');
    }
  }

  // ã‚«ãƒ¡ãƒ©èµ·å‹•ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
  $('faceBtn').onclick=function(){
    $('sheet').classList.remove('show');
    $('faceModal').classList.add('show');

    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
      navigator.mediaDevices.getUserMedia({
        video:{ facingMode:'user', width:{ideal:640}, height:{ideal:640} },
        audio:false
      }).then(s=>{
        stream = s;
        const v = $('cam');
        v.srcObject = s;
        v.classList.add('mirror');   // â† é¡è¡¨ç¤ºï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã¿ï¼‰
        showLivePreview(true);
      }).catch(()=>{
        alert(appLang==='ja'?'ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚':'Camera unavailable. Please allow access.');
      });
    }else{
      alert(appLang==='ja'?'ã“ã®ç’°å¢ƒã§ã¯ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆã¾ã›ã‚“':'Camera not supported');
    }
  };

  // æ’®å½±ï¼æ’®ã‚Šç›´ã—
  $('faceTake').onclick=function(){
    const v = $('cam');
    const c = $('shot');
    const s = c.width; // 320

    // ã™ã§ã«é™æ­¢ç”»è¡¨ç¤ºä¸­ â†’ æ’®ã‚Šç›´ã—ï¼ˆãƒ©ã‚¤ãƒ–ã«æˆ»ã™ï¼‰
    if (v.style.display === 'none'){
      showLivePreview(true);
      return;
    }

    if(!v.srcObject){
      alert(appLang==='ja'?'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“':'Cannot start camera');
      return;
    }

    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,s,s);
    ctx.save();
    // å††å½¢ã‚¯ãƒªãƒƒãƒ—
    ctx.beginPath(); ctx.arc(s/2, s/2, s/2, 0, Math.PI*2); ctx.closePath(); ctx.clip();

    // ä¿å­˜ã™ã‚‹ç”»åƒã¯å·¦å³åè»¢ã‚’æˆ»ã—ã¦æç”»ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ãƒŸãƒ©ãƒ¼ã ãŒã€ä¿å­˜ã¯æ­£å‘ãï¼‰
    ctx.translate(s, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(v, 0, 0, s, s);

    ctx.restore();

    showLivePreview(false); // é™æ­¢ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
  };

  // ä¿å­˜
  $('faceSave').onclick=function(){
    try{
      const data = $('shot').toDataURL('image/png');
      localStorage.setItem('kukuFaceData', data);
      alert(appLang==='ja'?'ä¿å­˜ã—ã¾ã—ãŸï¼':'Saved!');
    }catch(e){
      alert(appLang==='ja'?'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ':'Save failed');
    }
    closeFace();
  };

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«/èƒŒæ™¯ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹
  function closeFace(){
    $('faceModal').classList.remove('show');
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    showLivePreview(true); // æ¬¡å›ã®ãŸã‚åˆæœŸçŠ¶æ…‹ã¸
  }
  $('faceCancel').onclick = closeFace;
  $('faceModal').querySelector('.back').onclick = closeFace;

  // é¡”ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
  $('faceDel').onclick=function(){
    if(confirm(appLang==='ja'?'ä¿å­˜æ¸ˆã¿ã®é¡”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ':'Remove saved face?')){
      localStorage.removeItem('kukuFaceData');
      alert(appLang==='ja'?'å‰Šé™¤ã—ã¾ã—ãŸ':'Removed');
    }
  };

  /* ========== è©³ç´°è¨­å®šã‚·ãƒ¼ãƒˆ ========= */
  const sheet=$('sheet'); $('openSettings').onclick=()=>{ sheet.classList.add('show'); }; $('closeSettings').onclick=()=>{ sheet.classList.remove('show'); };

  /* ========== åˆæœŸåŒ– ========= */
  updateLangUI();
  newProblem(true);
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}
</script>
</body>
</html>
